<!DOCTYPE html>
<html lang="en">
    <!-- TEMP: wrap test -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sora:wght@400;500;600;700&family=Cousine:wght@400;700&display=swap" rel="stylesheet">
    <title>Don't Lose Your Job</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .setup-wizard {
            background: #ffffff;
            padding: 0;
            border-radius: 0;
            margin-bottom: 0;
        }
        
        .setup-section {
            margin-bottom: 30px;
        }
        
        .setup-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .section-category {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2a5298;
        }
        
        .section-category h4 {
            color: #2a5298;
            margin-bottom: 15px;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-category h4:hover {
            color: #1e3c72;
        }

        .expand-icon {
            font-size: 0.9em;
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 16px;
        }

        @media (max-width: 1000px) and (min-width: 769px) {
            .question-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) and (min-width: 361px) {
            .question-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 360px) {
            .question-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        .additional-questions {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .additional-questions.expanded {
            max-height: 2000px;
        }
        
        .role-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }
        
        
        
        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .preset-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .question-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .question-group h5 {
            font-family: 'Sora', sans-serif;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
            font-weight: 600;
            line-height: 1.4;
        }

        .question-group p {
            font-family: 'Sora', sans-serif;
            color: #666;
            font-size: 0.85em;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .radio-option {
            flex: 1 1 auto;
            min-width: 100px;
            max-width: 220px;
        }
        
        .radio-option input[type="radio"] {
            display: none;
        }
        
        .radio-option label {
            font-family: 'Sora', sans-serif;
            display: block;
            padding: 10px 14px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: 500;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .radio-option input[type="radio"]:checked + label {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }
        
        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
        }
        
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }

        .left-column {
            min-width: 0;
        }

        .right-column {
            min-width: 0;
            position: sticky;
            top: 100px;
            align-self: start;
        }

        @media (max-width: 1200px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }

            .right-column {
                position: static;
            }
        }
        
        .parameter-breakdown {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.05);
            margin-top: 24px;
            margin-bottom: 48px;
        }

        .parameter-breakdown h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .profile-scores {
            display: flex;
            flex-direction: column;
        }

        .profile-timeline {
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1em;
            margin-bottom: 12px;
            color: #1f1c18;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #e6e0d4;
        }

        .parameter-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .parameter-item:last-child {
            border-bottom: none;
        }
        
        .parameter-label {
            color: #666;
            font-size: 1em;
        }

        .parameter-value {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }
        
        .timeline-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .timeline-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .timeline-card h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .timeline-event {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            flex: 0 0 auto;
        }
        
        .timeline-date {
            font-weight: 600;
            color: #2a5298;
            margin-right: 10px;
            min-width: 65px;
            font-size: 0.9em;
        }

        .timeline-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .control-group h3 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .control-group p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2a5298;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #2a5298;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .value-display {
            min-width: 60px;
            text-align: right;
            font-weight: bold;
            color: #333;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        canvas {
            max-width: 100%;
            height: 400px;
            display: block;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }
        
        .result-card.critical {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .result-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: bold;
        }

        .model-insights {
            margin-top: 20px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px 20px;
            line-height: 1.4;
        }

        .model-insights p {
            margin: 4px 0;
            color: #495057;
            font-size: 0.95em;
        }

        .progress-indicator {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            transition: width 0.3s;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .content-wrapper {
                width: 100%;
                padding: 24px 0;
            }

            .two-column-layout {
                gap: 24px;
            }

            .model-explanation {
                padding: 15px !important;
            }

            .model-explanation h3 {
                font-size: 1.1em;
            }

            .ai-equation-display {
                padding: 15px !important;
                font-size: 0.9em;
            }

            .ai-equation-display h3 {
                font-size: 1em;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 12px;
            }

            .subtitle {
                font-size: 1.1em;
                margin-bottom: 0;
            }
            .setup-wizard {
                padding: 15px;
            }

            .setup-section h3 {
                font-size: 1em;
            }

            .role-presets {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }

            .preset-btn {
                padding: 10px 12px;
                font-size: 0.85em;
            }

            .section-category {
                padding: 12px;
                margin-bottom: 16px;
            }

            .section-category h4 {
                font-size: 1em;
                margin-bottom: 12px;
            }

            .question-group {
                padding: 10px;
                margin-bottom: 10px;
            }

            .question-group h5 {
                font-size: 0.85em;
                margin-bottom: 5px;
                line-height: 1.3;
            }

            .question-group p {
                font-size: 0.75em;
                margin-bottom: 7px;
                line-height: 1.4;
            }

            .radio-group {
                flex-direction: column;
                gap: 6px;
            }

            .radio-option {
                min-width: auto;
            }

            .radio-option label {
                padding: 8px;
                font-size: 0.78em;
            }

            .timeline-comparison {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .timeline-card {
                padding: 15px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .control-group {
                padding: 15px;
            }

            .control-group h3 {
                font-size: 1em;
            }

            .control-group p {
                font-size: 0.85em;
            }

            .chart-container {
                padding: 8px;
                height: 280px;
                display: flex;
                flex-direction: column;
            }

            canvas {
                width: 100% !important;
                height: 100% !important;
                display: block;
            }

            .results {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }

            .result-card {
                padding: 15px;
            }

            .result-card h4 {
                font-size: 0.8em;
            }

            .result-value {
                font-size: 1.5em;
            }

            .analyze-btn {
                padding: 12px;
                font-size: 1em;
            }

            .parameter-breakdown {
                padding: 15px;
            }

            .parameter-breakdown h3 {
                font-size: 1em;
            }

            .profile-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .parameter-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .parameter-label,
            .parameter-value {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.3em;
            }

            .role-presets {
                grid-template-columns: 1fr;
            }

            .results {
                grid-template-columns: 1fr;
            }

            .slider-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .value-display {
                text-align: left;
            }
        }

        /* Substack-inspired refresh */
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: #faf7f1;
            color: #1f1c18;
            line-height: 1.7;
            min-height: 100vh;
        }

        .container {
            width: 92.5%;
            max-width: none;
            margin: 0 auto;
            padding: 0 0 96px;
            background: transparent;
        }

        @media (max-width: 768px) {
            .container {
                width: 96%;
                padding: 0 0 60px;
            }
        }

        @media (max-width: 480px) {
            .container {
                width: 98%;
                padding: 0 0 48px;
            }
        }

        .hero-section {
            background: transparent;
            color: inherit;
            padding: 96px 0 48px;
            text-align: left;
            border-bottom: 1px solid #e6e0d4;
            margin-bottom: 48px;
        }

        .hero-section h1 {
            font-family: 'Sora', sans-serif;
            font-size: clamp(2.8rem, 4vw, 3.6rem);
            letter-spacing: -0.015em;
            color: #1f1c18;
            font-weight: 600;
        }

        .article-hero {
            padding: 96px 0 48px;
            border-bottom: 1px solid #e6e0d4;
            margin-bottom: 48px;
        }

        .article-hero h1 {
            font-family: 'Sora', sans-serif;
            font-size: clamp(2.8rem, 4vw, 3.6rem);
            letter-spacing: -0.015em;
            font-weight: 600;
            margin-top: 18px;
        }

        .lede {
            color: #5c564f;
            max-width: 48ch;
            margin-top: 16px;
            font-size: 1.18rem;
        }

        .meta-line {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 24px;
            font-size: 0.85rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #8c857d;
        }

        .subtitle {
            color: #5c564f;
            font-size: 1.15rem;
            margin-top: 16px;
            max-width: 32ch;
        }

        .content-wrapper {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        .narrow-content {
            width: 100%;
            margin: 0 auto;
        }

        p {
            margin-bottom: 1.2em;
            color: #3f392f;
        }

        h2,
        h3,
        h4 {
            font-family: 'Sora', sans-serif;
            color: #1f1c18;
            font-weight: 600;
        }

        .site-header {
            position: static;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e6e0d4;
        }

        .header-inner {
            width: 92.5%;
            max-width: none;
            margin: 0 auto;
            padding: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
        }

        .header-brand {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-actions {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-btn {
            background: #fdf8f0;
            color: #1f1c18;
            border: 1px solid #e6e0d4;
            border-radius: 6px;
            padding: 14px 32px;
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: #f5eee0;
            border-color: #d9d2c4;
            color: #000000;
        }

        .header-btn.active {
            background: #1f1c18;
            color: #ffffff;
            border-color: #1f1c18;
            box-shadow: 0 12px 28px rgba(31, 28, 24, 0.2);
        }

        .publication-title {
            font-family: 'Sora', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 0.02em;
        }

        .publication-tagline,
        .author-link {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 600;
        }

        .publication-tagline {
            color: #5c564f;
        }

        .author-link {
            color: #6ba3d4;
            text-decoration: none;
            transition: color 0.3s;
        }

        .author-link:hover {
            color: #4a8bc2;
        }

        .header-actions {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-button {
            border: 1px solid #1f1c18;
            background: #1f1c18;
            color: #ffffff;
            padding: 10px 24px;
            border-radius: 999px;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .header-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(31, 28, 24, 0.15);
        }

        .header-button--ghost {
            background: transparent;
            color: #1f1c18;
        }

        .eyebrow {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #1f1c18;
            font-weight: 600;
        }

        .model-explanation {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.05);
            margin-bottom: 16px;
        }

        .model-explanation h2 {
            margin-bottom: 1rem;
        }

        .ai-equation {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.05);
            margin: 72px 0 64px;
            overflow: hidden;
            max-width: 100%;
        }

        .section-intro {
            margin-bottom: 24px;
        }

        .section-intro p {
            color: #5c564f;
        }

        .equation-callout {
            margin: 24px 0;
            padding: 20px 24px;
            border-left: 4px solid #d2c7b8;
            background: #fefbf5;
            border-radius: 18px;
            overflow: hidden;
            max-width: 100%;
        }

        .callout-label {
            display: block;
            font-size: 0.8rem;
            letter-spacing: 0.12em;
            color: #3b3326;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .equation-callout code {
            font-family: 'Cousine', 'Menlo', monospace;
            font-size: 0.95rem;
            color: #3b3326;
            background: transparent;
        }

        .equation-display {
            font-size: 1.1rem;
            color: #3b3326;
            overflow-x: auto;
            padding: 8px 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .factor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin: 32px 0;
            list-style: none;
            padding: 0;
        }

        .factor-grid li {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 16px;
            padding: 16px 18px;
            font-size: 0.95rem;
            color: #3f392f;
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.04);
        }

        .factor-grid--compact {
            margin-top: 24px;
        }

        .note {
            font-size: 0.85rem;
            color: #8c857d;
            font-style: italic;
        }

        .inline-link {
            color: #a35d2c;
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .inline-link:hover {
            color: #703b16;
        }
        .setup-wizard {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 48px 48px 56px;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.05);
        }

        .setup-section {
            border-top: 1px solid #eee5d7;
            padding-top: 32px;
            margin-top: 32px;
        }

        .setup-section:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        .role-presets {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .preset-btn {
            border-radius: 16px;
            border: 1px solid #d9d2c4;
            background: #fdfaf4;
            padding: 14px 18px;
            font-weight: 500;
            color: #4b453c;
            transition: all 0.2s ease;
        }

        .preset-btn:hover,
        .preset-btn.active {
            background: #1f1c18;
            color: #ffffff;
            border-color: #1f1c18;
            box-shadow: 0 12px 28px rgba(31, 28, 24, 0.2);
        }

        label {
            color: #3f392f;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            border-radius: 14px;
            border: 1px solid #d9d2c4;
            padding: 12px 14px;
            font-size: 0.95rem;
            background: #fdfaf4;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid rgba(31, 28, 24, 0.25);
        }

        input[type="range"] {
            accent-color: #1f1c18;
        }

        .progress-indicator {
            display: flex;
            flex-direction: column;
            gap: 12px;
            color: #3b3326;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 16px;
            margin-top: -12px;
        }

        .progress-bar {
            height: 6px;
            background: #f1eadf;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-fill {
            background: #1f1c18;
            width: 0;
            height: 100%;
            border-radius: inherit;
        }

        .timeline-comparison {
            display: grid;
            gap: 20px;
            margin: 48px 0;
        }

        .timeline-card {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 18px 48px rgba(15, 23, 42, 0.05);
        }

        .timeline-card h4 {
            margin-bottom: 12px;
        }

        .timeline-event {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
            color: #3f392f;
        }

        .timeline-date {
            font-weight: 600;
            font-family: 'Cousine', 'Menlo', monospace;
            color: #a35d2c;
        }

        .controls-grid {
            display: grid;
            gap: 24px;
            margin: 56px 0 48px;
        }

        .control-group {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 16px 42px rgba(15, 23, 42, 0.05);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .value-display {
            font-family: 'Cousine', 'Menlo', monospace;
            color: #8c857d;
            font-size: 0.9rem;
        }

        .chart-container {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.05);
            margin-bottom: 48px;
            height: 600px;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-top: 48px;
        }

        .result-card {
            border-radius: 20px;
            border: 1px solid #e6e0d4;
            background: linear-gradient(180deg, #ffffff 0%, #fdf8f0 100%);
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.05);
            padding: 24px;
            text-align: left;
        }

        .result-card h4 {
            font-size: 0.95rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #8c857d;
        }

        .result-value {
            font-family: 'Sora', sans-serif;
            font-size: 2rem;
            color: #1f1c18;
            margin-top: 8px;
        }

        /* .result-card.critical styling intentionally removed */

        .footer-note {
            color: #8c857d;
            font-size: 0.85rem;
            margin-top: 32px;
        }

        .parameter-summary,
        .parameter-item {
            color: #3f392f;
        }

        /* Match Guide header width on tablets */
        @media (max-width: 900px) {
            .header-inner {
                width: 94%;
            }
        }

        @media (max-width: 640px) {
            .header-inner {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
            }

            .header-btn {
                flex: 1;
            }

            .hero-section {
                padding: 56px 16px 36px;
            }

            .article-hero {
                padding: 56px 16px 32px;
            }

            .article-hero h1 {
                font-size: clamp(1.8rem, 6vw, 2.4rem);
                margin-top: 12px;
                letter-spacing: -0.01em;
            }

            .hero-section h1 {
                font-size: clamp(1.8rem, 6vw, 2.4rem);
                letter-spacing: -0.01em;
            }

            .lede {
                font-size: 1.0rem;
                max-width: 100%;
                line-height: 1.6;
            }

            .model-explanation,
            .ai-equation,
            .setup-wizard {
                padding: 32px 24px;
            }

            /* Stack equation grids on mobile - but not question grids */
            .ai-equation-display [style*="grid-template-columns: 1fr 1fr"],
            .model-explanation [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-brand">
                <span class="publication-title">Don't Lose Your Job</span>
                <span class="publication-tagline">Forecasting work in the age of AI</span>
                <a href="https://x.com/wrenclay" target="_blank" class="author-link">Clay Wren</a>
            </div>
            <div class="header-actions">
                <button class="header-btn active" data-page="/">Calculator</button>
                <button class="header-btn" data-page="/guide">Guide</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="content-wrapper">
            <header class="article-hero">
                <h1>Job Displacement Model</h1>
                <p class="lede">Complete the sections below for a personalized analysis of how AI capability growth affects knowledge work in white-collar roles.</p>
                <div class="meta-line">
                    <span>Updated October 2025</span>
                </div>
            </header>

            <div class="two-column-layout">
                <div class="left-column">
                    <div class="setup-wizard" id="setup-wizard">
            <div class="setup-section">
                <h3>Step 1: Select Your Role Category</h3>
                <div class="role-presets">
                    <button class="preset-btn" data-role="software">
                        Software/Tech
                    </button>
                    <button class="preset-btn" data-role="admin">
                        Administrative
                    </button>
                    <button class="preset-btn" data-role="customer-service">
                        Customer Service
                    </button>
                    <button class="preset-btn" data-role="data-analysis">
                        Data Analysis
                    </button>
                    <button class="preset-btn" data-role="finance">
                        Finance/Accounting
                    </button>
                    <button class="preset-btn" data-role="sales">
                        Sales/Marketing
                    </button>
                    <button class="preset-btn" data-role="creative">
                        Creative/Design
                    </button>
                    <button class="preset-btn" data-role="legal">
                        Legal/Compliance
                    </button>
                    <button class="preset-btn" data-role="product-management">
                        Product Management
                    </button>
                    <button class="preset-btn" data-role="consulting">
                        Consulting/Strategy
                    </button>
                    <button class="preset-btn" data-role="hr">
                        HR/People Ops
                    </button>
                    <button class="preset-btn" data-role="content-writing">
                        Content Writing
                    </button>
                    <button class="preset-btn" data-role="journalism">
                        Journalism
                    </button>
                    <button class="preset-btn" data-role="engineering">
                        Engineering (Non-Software)
                    </button>
                    <button class="preset-btn" data-role="operations">
                        Operations Management
                    </button>
                    <button class="preset-btn" data-role="custom">Other/Custom</button>
                </div>
            </div>

            <div class="setup-section">
                <h3>Step 2: Your Hierarchy Position</h3>
                <div class="question-group">
                    <p>Select based on how many people <strong>above you in your specific workflow</strong> could absorb your responsibilities if your role were eliminated. A senior engineer who owns a system has no one above (Level 4-5), while a VP with C-suite above might be Level 2-3.</p>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="seniority-1" name="seniority" value="1" checked>
                            <label for="seniority-1">Level 1: Many layers above me (4+ people who do similar work)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="seniority-2" name="seniority" value="2">
                            <label for="seniority-2">Level 2: Several layers above (2-3 people/levels)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="seniority-3" name="seniority" value="3">
                            <label for="seniority-3">Level 3: Few above (1-2 people) or mostly peers</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="seniority-4" name="seniority" value="4">
                            <label for="seniority-4">Level 4: Top of my domain (no one above can do my work)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="seniority-5" name="seniority" value="5">
                            <label for="seniority-5">Level 5: Unique/irreplaceable (own entire function/system)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setup-section">
                <h3>Step 3: AI Displacement Risk Assessment</h3>

                <div class="section-category">
                    <h4>AI Technical Readiness</h4>

                    <div class="question-grid">
                    <div class="question-group">
                        <h5>1. Current AI Performance</h5>
                        <p>How well can AI already perform core tasks in your field?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q1-1" name="q1" value="1">
                                <label for="q1-1">Very Poor</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-2" name="q1" value="2">
                                <label for="q1-2">Limited</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-3" name="q1" value="3" checked>
                                <label for="q1-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-4" name="q1" value="4">
                                <label for="q1-4">Good</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-5" name="q1" value="5">
                                <label for="q1-5">Near-Human</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>2. Data Availability</h5>
                        <p>How much example work and documentation about your type of role is available (training materials, online guides, industry examples, case studies)?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q2-1" name="q2" value="1">
                                <label for="q2-1">Very Limited</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-2" name="q2" value="2">
                                <label for="q2-2">Limited</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-3" name="q2" value="3" checked>
                                <label for="q2-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-4" name="q2" value="4">
                                <label for="q2-4">Abundant</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-5" name="q2" value="5">
                                <label for="q2-5">Very Abundant</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>3. Benchmark Clarity</h5>
                        <p>How easily can success in your role be measured objectively?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q3-1" name="q3" value="1">
                                <label for="q3-1">Very Hard</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-2" name="q3" value="2">
                                <label for="q3-2">Difficult</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-3" name="q3" value="3" checked>
                                <label for="q3-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-4" name="q3" value="4">
                                <label for="q3-4">Fairly Easy</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-5" name="q3" value="5">
                                <label for="q3-5">Very Easy</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>4. Task Digitization</h5>
                        <p>What percentage of your work inputs and outputs currently exist in digital/text format?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q4-1" name="q4" value="1">
                                <label for="q4-1">0-20%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-2" name="q4" value="2">
                                <label for="q4-2">21-40%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-3" name="q4" value="3" checked>
                                <label for="q4-3">41-60%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-4" name="q4" value="4">
                                <label for="q4-4">61-80%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-5" name="q4" value="5">
                                <label for="q4-5">81-100%</label>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <div class="section-category">
                    <h4>Task Structure & Adaptability</h4>

                    <div class="question-grid">
                    <div class="question-group">
                        <h5>5. Task Decomposability</h5>
                        <p>Can your work be broken into discrete, measurable tasks?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q5-1" name="q5" value="1">
                                <label for="q5-1">Very Complex</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-2" name="q5" value="2">
                                <label for="q5-2">Complex</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-3" name="q5" value="3" checked>
                                <label for="q5-3">Mixed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-4" name="q5" value="4">
                                <label for="q5-4">Structured</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-5" name="q5" value="5">
                                <label for="q5-5">Highly Structured</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>6. Task Standardization</h5>
                        <p>How standardized are procedures/workflows in your role?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q6-1" name="q6" value="1">
                                <label for="q6-1">Highly Variable</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-2" name="q6" value="2">
                                <label for="q6-2">Variable</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-3" name="q6" value="3" checked>
                                <label for="q6-3">Somewhat Standard</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-4" name="q6" value="4">
                                <label for="q6-4">Standardized</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-5" name="q6" value="5">
                                <label for="q6-5">Highly Standardized</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>7. Context Dependency</h5>
                        <p>How much does your work require understanding unique organizational context?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q7-1" name="q7" value="5">
                                <label for="q7-1">Critical</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-2" name="q7" value="4">
                                <label for="q7-2">Very Important</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-3" name="q7" value="3" checked>
                                <label for="q7-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-4" name="q7" value="2">
                                <label for="q7-4">Some Needed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-5" name="q7" value="1">
                                <label for="q7-5">Minimal</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>8. Feedback Loop Speed</h5>
                        <p>How quickly do you get feedback on work quality?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q8-1" name="q8" value="1">
                                <label for="q8-1">Months/Years</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-2" name="q8" value="2">
                                <label for="q8-2">Weeks</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-3" name="q8" value="3" checked>
                                <label for="q8-3">Days</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-4" name="q8" value="4">
                                <label for="q8-4">Hours</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-5" name="q8" value="5">
                                <label for="q8-5">Minutes/Instant</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>9. Tacit Knowledge</h5>
                        <p>How much of your expertise is documented vs. learned through experience?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q9-1" name="q9" value="5">
                                <label for="q9-1">Mostly Tacit</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-2" name="q9" value="4">
                                <label for="q9-2">Largely Tacit</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-3" name="q9" value="3" checked>
                                <label for="q9-3">Mixed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-4" name="q9" value="2">
                                <label for="q9-4">Largely Documented</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-5" name="q9" value="1">
                                <label for="q9-5">Fully Documented</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>10. Task Reallocation Risk</h5>
                        <p>If your position were eliminated, how easily could your responsibilities be redistributed to existing team members?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q10-1" name="q10" value="1">
                                <label for="q10-1">Nearly impossible - unique expertise/relationships</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-2" name="q10" value="2">
                                <label for="q10-2">Very difficult - would take 6-12 months to transfer</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-3" name="q10" value="3" checked>
                                <label for="q10-3">Moderately difficult - requires 2-6 months training</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-4" name="q10" value="4">
                                <label for="q10-4">Fairly easily - needs 1-2 months knowledge transfer</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-5" name="q10" value="5">
                                <label for="q10-5">Very easily - others already do similar work</label>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <div class="section-category">
                    <h4>Human & Organizational Factors</h4>

                    <div class="question-grid">
                    <div class="question-group">
                        <h5>11. Human Judgment & Relationships</h5>
                        <p>How critical are human relationships, empathy, and trust in your role?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q11-1" name="q11" value="5">
                                <label for="q11-1">Essential</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-2" name="q11" value="4">
                                <label for="q11-2">Very Important</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-3" name="q11" value="3" checked>
                                <label for="q11-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-4" name="q11" value="2">
                                <label for="q11-4">Some Needed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-5" name="q11" value="1">
                                <label for="q11-5">Minimal</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>12. Physical Presence</h5>
                        <p>How much does your work require physical presence?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q12-1" name="q12" value="5">
                                <label for="q12-1">Essential</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-2" name="q12" value="4">
                                <label for="q12-2">Very Important</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-3" name="q12" value="3" checked>
                                <label for="q12-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-4" name="q12" value="2">
                                <label for="q12-4">Some</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-5" name="q12" value="1">
                                <label for="q12-5">None</label>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <div class="section-category">
                    <h4>Company & Industry Context</h4>

                    <div class="question-grid">
                    <div class="question-group">
                        <h5>13. Company AI Adoption Readiness</h5>
                        <p>How prepared is your organization for AI integration?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q13-1" name="q13" value="1">
                                <label for="q13-1">Resistant</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-2" name="q13" value="2">
                                <label for="q13-2">Cautious</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-3" name="q13" value="3" checked>
                                <label for="q13-3">Exploring</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-4" name="q13" value="4">
                                <label for="q13-4">Adopting</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-5" name="q13" value="5">
                                <label for="q13-5">Leading Edge</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>14. Labor Cost Pressure</h5>
                        <p>How cost-sensitive is your employer to labor expenses?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q14-1" name="q14" value="1">
                                <label for="q14-1">Not Sensitive</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-2" name="q14" value="2">
                                <label for="q14-2">Somewhat</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-3" name="q14" value="3" checked>
                                <label for="q14-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-4" name="q14" value="4">
                                <label for="q14-4">Very Sensitive</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-5" name="q14" value="5">
                                <label for="q14-5">Extremely Sensitive</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>15. Labor Market Tightness</h5>
                        <p>How difficult is it to hire people with your skills?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q15-1" name="q15" value="5">
                                <label for="q15-1">Very Difficult</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-2" name="q15" value="4">
                                <label for="q15-2">Difficult</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-3" name="q15" value="3" checked>
                                <label for="q15-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-4" name="q15" value="2">
                                <label for="q15-4">Easy</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-5" name="q15" value="1">
                                <label for="q15-5">Very Easy</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>16. IT Infrastructure</h5>
                        <p>How modern is your organization's technical infrastructure?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q16-1" name="q16" value="1">
                                <label for="q16-1">Very Outdated</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-2" name="q16" value="2">
                                <label for="q16-2">Outdated</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-3" name="q16" value="3" checked>
                                <label for="q16-3">Current</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-4" name="q16" value="4">
                                <label for="q16-4">Modern</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-5" name="q16" value="5">
                                <label for="q16-5">Cutting Edge</label>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <div class="section-category">
                    <h4>Personal Adaptability</h4>

                    <div class="question-grid">
                    <div class="question-group">
                        <h5>17. Skill Transferability</h5>
                        <p>How transferable are your core skills to other roles/industries?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q17-1" name="q17" value="1">
                                <label for="q17-1">Highly Specific</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-2" name="q17" value="2">
                                <label for="q17-2">Somewhat Specific</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-3" name="q17" value="3" checked>
                                <label for="q17-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-4" name="q17" value="4">
                                <label for="q17-4">Transferable</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-5" name="q17" value="5">
                                <label for="q17-5">Highly Transferable</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>18. Adaptability/Learning</h5>
                        <p>How quickly can you learn and adopt new tools/technologies?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q18-1" name="q18" value="1">
                                <label for="q18-1">Very Slow</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-2" name="q18" value="2">
                                <label for="q18-2">Slow</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-3" name="q18" value="3" checked>
                                <label for="q18-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-4" name="q18" value="4">
                                <label for="q18-4">Fast</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-5" name="q18" value="5">
                                <label for="q18-5">Very Fast</label>
                            </div>
                        </div>
                    </div>

                    <div class="question-group">
                        <h5>19. Job Performance</h5>
                        <p>How good are you at your job, relative to your peers?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q19-1" name="q19" value="1">
                                <label for="q19-1">Below Average</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-2" name="q19" value="2">
                                <label for="q19-2">Average</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-3" name="q19" value="3" checked>
                                <label for="q19-3">Above Average</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-4" name="q19" value="4">
                                <label for="q19-4">Excellent</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-5" name="q19" value="5">
                                <label for="q19-5">Top Performer</label>
                            </div>
                        </div>
                    </div>

                    </div>
                </div>
            </div>
                    </div>
                </div>

                <div class="right-column" id="results-column">

            
            <div class="controls-grid">
                <div class="control-group">
                    <h3>Industry Friction</h3>
                    <p>Industry-level friction multiplier. Note: Your questionnaire answers (Q4-Q12) already capture most domain differences.</p>
                    <div class="slider-container">
                        <input type="range" id="industry-pace" min="1.0" max="2.0" step="0.05" value="1.0">
                        <span class="value-display" id="industry-pace-value">1.0x</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>AI Reliability</h3>
                    <p>Success rate required before automation</p>
                    <div class="slider-container">
                        <input type="range" id="ai-reliability" min="50" max="99" step="1" value="95">
                        <span class="value-display" id="ai-reliability-value">95%</span>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>

            <div class="results">
                <div class="result-card" id="median-card">
                    <h4>50% Job Loss Risk</h4>
                    <div class="result-value" id="median-year">-</div>
                </div>
                <div class="result-card" id="high-card">
                    <h4>90% Job Loss Risk</h4>
                    <div class="result-value" id="high-year">-</div>
                </div>
                <div class="result-card" id="risk5-card">
                    <h4>Risk by 2030</h4>
                    <div class="result-value" id="risk-2030">-</div>
                </div>
                <div class="result-card" id="risk10-card">
                    <h4>Risk by 2031</h4>
                    <div class="result-value" id="risk-2031">-</div>
                </div>
                <div class="result-card" id="reemployment-card">
                    <h4>Re-employment Likelihood</h4>
                    <div class="result-value" id="reemployment-value">-</div>
                </div>
            </div>

        <div class="parameter-breakdown">
            <div class="profile-timeline">
                    <h4 class="section-title" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                        <button id="edit-task-buckets" class="header-btn" style="padding:8px 16px; font-size:0.85rem; letter-spacing:0.05em;">
                            Edit task buckets (optional)
                        </button>
                    </h4>
                    <div id="task-bucket-editor" class="additional-questions" style="margin-top:10px;">
                        <div style="background:#fff; border:1px solid #e6e0d4; border-radius:12px; padding:16px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
                                <p style="margin:0; color:#495057; font-size:0.9rem;">Adjust your job's baseline time split across task duration buckets.</p>
                                <label style="display:flex; align-items:center; gap:8px; color:#495057; font-size:0.9rem;">
                                    <input type="checkbox" id="tb-auto" checked>
                                    <span>Follow model (auto)</span>
                                </label>
                            </div>
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                                <label style="display:flex; flex-direction:column; gap:6px;">
                                    <span style="font-weight:600; color:#2a5298;">Under 5 min (L=2.5)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-0" value="25" style="padding:10px; border:1px solid #e0e0e0; border-radius:6px;">
                                </label>
                                <label style="display:flex; flex-direction:column; gap:6px;">
                                    <span style="font-weight:600; color:#2a5298;">5–15 min (L=15)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-1" value="35" style="padding:10px; border:1px solid #e0e0e0; border-radius:6px;">
                                </label>
                                <label style="display:flex; flex-direction:column; gap:6px;">
                                    <span style="font-weight:600; color:#2a5298;">15–60 min (L=60)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-2" value="25" style="padding:10px; border:1px solid #e0e0e0; border-radius:6px;">
                                </label>
                                <label style="display:flex; flex-direction:column; gap:6px;">
                                    <span style="font-weight:600; color:#2a5298;">1–3 hr (L=180)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-3" value="10" style="padding:10px; border:1px solid #e0e0e0; border-radius:6px;">
                                </label>
                                <label style="display:flex; flex-direction:column; gap:6px;">
                                    <span style="font-weight:600; color:#2a5298;">Over 9 hr (L=540)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-4" value="5" style="padding:10px; border:1px solid #e0e0e0; border-radius:6px;">
                                </label>
                            </div>
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
                                <span id="tb-sum" style="color:#666; font-size:0.9rem;">Sum: 100%</span>
                                <div style="display:flex; gap:8px;">
                                    <button id="tb-apply" class="header-btn" style="padding:8px 14px; font-size:0.85rem;">Apply Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Hidden elements to prevent JS errors -->
        <div style="display:none;">
            <div id="personal-timeline"></div>
            <span id="insight-explicitness"></span>
            <span id="insight-theta"></span>
            <span id="insight-friction"></span>
            <span id="insight-alignment"></span>
        </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
    <script src="presets.js"></script>
    <script>
        let selectedRole = null;
        let currentParams = null;
        let chart = null;

        const domainPaceSliderBaseline = 1.0;

        // METR-based capability model parameters
        const METR_DEFAULTS = {
            H50_0: 137,             // Baseline 50% task completion time in minutes (GPT-5, Aug 2025)
            H80_0: 26.372464,       // Baseline 80% reliability horizon in minutes (GPT-5, Aug 2025)
            D_months: 7,            // METR doubling time in months
            r_target: 0.95,         // Reliability target (95%)
            softness: 0.45,         // Logistic softness parameter [0.35, 0.6]
            // Task duration buckets (minutes) and weights (sum to 1.0)
            // Calibrated for corporate production work (longer than METR's research environment)
            taskBuckets: [
                { L: 2.5,  w: 0.25 },   // <5min tasks (center ~2.5m)
                { L: 15,   w: 0.35 },   // 5-15min tasks (upper-midpoint for 95% reliability)
                { L: 60,   w: 0.25 },   // 15-60min tasks (conservative center for production)
                { L: 180,  w: 0.10 },   // 1-3hr tasks (higher threshold for corporate work)
                { L: 540,  w: 0.05 }    // >9hr tasks (highest threshold for complex work)
            ]
        };

        const LOGIT_80 = Math.log(0.8 / 0.2);
        const METR_SIGMA = Math.log(METR_DEFAULTS.H80_0 / METR_DEFAULTS.H50_0) / LOGIT_80;
        const RELIABILITY_GUARD = 1e-6;

        // Dynamic baseline date calculation
        let BASELINE_DATE = null;  // Will be set from SOTA model release date
        let BASELINE_YEAR_DECIMAL = null;  // Decimal year for calculations

        // Current date for calculations (user's access time)
        function getCurrentYearDecimal() {
            const now = new Date();
            const year = now.getFullYear();
            const start = new Date(year, 0, 1);
            const diff = now - start;
            const oneYear = 365.25 * 24 * 60 * 60 * 1000;
            return year + (diff / oneYear);
        }

        // Load SOTA model from benchmark_results.yaml
        async function loadBenchmarkData() {
            try {
                const response = await fetch('benchmark_results.yaml');
                const yamlText = await response.text();
                const data = jsyaml.load(yamlText);

                // Find the SOTA model (GPT-5 or latest)
                let sotaModel = null;
                let sotaDate = null;

                for (const [modelName, modelData] of Object.entries(data.results)) {
                    if (modelData.release_date) {
                        const releaseDate = new Date(modelData.release_date);
                        if (!sotaDate || releaseDate > sotaDate) {
                            // Check if this model has SOTA flag
                            const agentData = Object.values(modelData.agents)[0];
                            if (agentData && agentData.is_sota) {
                                sotaModel = { name: modelName, ...modelData };
                                sotaDate = releaseDate;
                            }
                        }
                    }
                }

                if (sotaModel) {
                    // Update METR_DEFAULTS with SOTA model data
                    const agentData = Object.values(sotaModel.agents)[0];
                    METR_DEFAULTS.H50_0 = agentData.p50_horizon_length.estimate;
                    METR_DEFAULTS.H80_0 = agentData.p80_horizon_length.estimate;

                    // Set baseline date
                    BASELINE_DATE = sotaDate;
                    const year = sotaDate.getFullYear();
                    const start = new Date(year, 0, 1);
                    const diff = sotaDate - start;
                    const oneYear = 365.25 * 24 * 60 * 60 * 1000;
                    BASELINE_YEAR_DECIMAL = year + (diff / oneYear);

                    console.log(`[Benchmark] Loaded SOTA model: ${sotaModel.name}`);
                    console.log(`[Benchmark] Release date: ${BASELINE_DATE.toISOString().split('T')[0]} (${BASELINE_YEAR_DECIMAL.toFixed(2)})`);
                    console.log(`[Benchmark] H50: ${METR_DEFAULTS.H50_0.toFixed(2)} min, H80: ${METR_DEFAULTS.H80_0.toFixed(2)} min`);

                    // Recalculate METR_SIGMA with new values
                    const newSigma = Math.log(METR_DEFAULTS.H80_0 / METR_DEFAULTS.H50_0) / LOGIT_80;
                    Object.defineProperty(window, 'METR_SIGMA', { value: newSigma, writable: false });
                    console.log(`[Benchmark] METR_SIGMA: ${newSigma.toFixed(4)}`);
                }

                return true;
            } catch (error) {
                console.error('[Benchmark] Failed to load benchmark data:', error);
                // Fall back to hardcoded values
                BASELINE_YEAR_DECIMAL = 2025.60;  // ~August 2025
                return false;
            }
        }

        const SENIORITY_PROFILES = [
            { label: 'Level 1: Many layers above',            thetaLift: -0.02, hazardShield: 0.00, delayShift: -0.25, reemploymentBoost: 1.00 },
            { label: 'Level 2: Several layers above',         thetaLift: 0.00,  hazardShield: 0.02, delayShift: -0.05, reemploymentBoost: 1.03 },
            { label: 'Level 3: Few above or mostly peers',    thetaLift: 0.03,  hazardShield: 0.05, delayShift:  0.10, reemploymentBoost: 1.06 },
            { label: 'Level 4: Top of domain',                thetaLift: 0.05,  hazardShield: 0.08, delayShift:  0.20, reemploymentBoost: 1.08 },
            { label: 'Level 5: Unique/irreplaceable owner',   thetaLift: 0.08,  hazardShield: 0.10, delayShift:  0.30, reemploymentBoost: 1.10 }
        ];

        // Seniority-based task weight shifts (shift toward longer tasks for higher levels)
        // Base shifts: Entry-level roles have more short tasks, senior roles have more long tasks
        const SENIORITY_TASK_SHIFTS = [
            [+0.12, +0.08, -0.05, -0.08, -0.07],  // Entry: shift toward short tasks
            [+0.05, +0.03, -0.02, -0.03, -0.03],  // Mid: slight shift toward short tasks
            [ 0.00,  0.00,  0.00,  0.00,  0.00],  // Senior: neutral baseline
            [-0.06, -0.04, +0.03, +0.04, +0.03],  // Lead: shift toward longer tasks
            [-0.12, -0.09, +0.06, +0.08, +0.07]   // Exec: shift toward long tasks
        ];

        // Get task weights for a given seniority level (1-5) and questionnaire answers
        function getTaskWeightsForSeniority(level, answers = null) {
            // Check if user has set custom weights and is in custom mode
            const isCustomMode = (currentParams && currentParams.taskBucketMode === 'custom');
            const userBase = (currentParams && Array.isArray(currentParams.userBaseWeights)) ? currentParams.userBaseWeights : null;

            // If in custom mode with valid user weights, return them exactly as-is (no shifts)
            if (isCustomMode && userBase && userBase.length === METR_DEFAULTS.taskBuckets.length) {
                // Normalize to ensure sum = 1.0 (in case user entered non-normalized values)
                const sum = userBase.reduce((a, b) => a + b, 0);
                if (sum > 0) {
                    const normalized = userBase.map(w => w / sum);
                    console.log('[TaskWeights] Custom mode: using exact user weights (no shifts):', normalized.map(v => v.toFixed(3)));
                    return normalized;
                }
            }

            // Auto mode: start with base weights (either user's or METR defaults)
            const baseWeights = (userBase && userBase.length === METR_DEFAULTS.taskBuckets.length)
                ? userBase
                : METR_DEFAULTS.taskBuckets.map(b => b.w);
            const idx = Math.max(0, Math.min(SENIORITY_TASK_SHIFTS.length - 1, level - 1));
            const seniorityShift = SENIORITY_TASK_SHIFTS[idx];

            // Start with seniority-based shift
            let adjusted = baseWeights.map((w, i) => w + seniorityShift[i]);

            // Apply questionnaire-based adjustments if answers provided
            if (answers) {
                const q5 = typeof answers.Q5 === 'number' ? answers.Q5 : 3;  // Task decomposability
                const q6 = typeof answers.Q6 === 'number' ? answers.Q6 : 3;  // Standardization
                const q7 = typeof answers.Q7 === 'number' ? answers.Q7 : 3;  // Context dependency

                // Q5: Decomposability (1=complex/holistic, 5=highly decomposable)
                // High decomposability → more short tasks
                const q5Shift = (norm(q5) - 0.5) * 0.20;  // -0.10 to +0.10
                adjusted[0] += q5Shift;      // <5min
                adjusted[1] += q5Shift * 0.5;
                adjusted[3] -= q5Shift * 0.5;
                adjusted[4] -= q5Shift;      // >9hr

                // Q6: Standardization (1=bespoke, 5=standardized)
                // High standardization → more short tasks
                const q6Shift = (norm(q6) - 0.5) * 0.15;  // -0.075 to +0.075
                adjusted[0] += q6Shift;
                adjusted[1] += q6Shift * 0.5;
                adjusted[3] -= q6Shift * 0.5;
                adjusted[4] -= q6Shift;

                // Q7: Context dependency (1=low context, 5=high context)
                // High context → more long tasks (harder to automate in pieces)
                const q7Shift = (norm(q7) - 0.5) * 0.18;  // -0.09 to +0.09
                adjusted[0] -= q7Shift;      // <5min
                adjusted[1] -= q7Shift * 0.6;
                adjusted[2] += q7Shift * 0.3;
                adjusted[3] += q7Shift * 0.6;
                adjusted[4] += q7Shift;      // >9hr
            }

            // Ensure all weights are non-negative
            adjusted = adjusted.map(w => Math.max(0.01, w));

            // Normalize to sum to 1.0
            const sum = adjusted.reduce((a, b) => a + b, 0);
            return adjusted.map(w => w / sum);
        }

        // Get softness parameter for a given seniority level and answers
        // Higher seniority and complex tasks → smoother transitions (higher softness)
        function getSoftnessForSeniority(level, answers = null) {
            const baseSoftness = 0.45;

            // Seniority effect: entry-level sharper gates, senior smoother gates
            const seniorityAdjust = (level - 3) * 0.03;  // Range: -0.06 (entry) to +0.06 (exec)

            let questionAdjust = 0;
            if (answers) {
                const q5 = typeof answers.Q5 === 'number' ? answers.Q5 : 3;
                const q6 = typeof answers.Q6 === 'number' ? answers.Q6 : 3;

                // Complex, bespoke tasks → smoother gates (less sharp transitions)
                questionAdjust = (0.5 - norm(q5)) * 0.08 + (0.5 - norm(q6)) * 0.05;
            }

            return clamp(baseSoftness + seniorityAdjust + questionAdjust, 0.25, 0.65);
        }

        const THETA_BASE_ENTRY = 0.50;

        function clamp(value, min = 0, max = 1) {
            return Math.min(max, Math.max(min, value));
        }

        function toScore(raw) {
            if (typeof raw !== 'number' || Number.isNaN(raw)) return 2;
            if (raw >= 1 && raw <= 5) {
                return Math.max(0, Math.min(4, raw - 1));
            }
            return Math.max(0, Math.min(4, raw));
        }

        function norm(value) {
            return clamp(toScore(value) / 4, 0, 1);
        }

        function avg(questionKeys, answers) {
            if (!Array.isArray(questionKeys) || questionKeys.length === 0) {
                return 2;
            }
            const total = questionKeys.reduce((sum, key) => {
                const val = answers && typeof answers[key] === 'number' ? answers[key] : 3;
                return sum + toScore(val);
            }, 0);
            return total / questionKeys.length;
        }

        function inferredExplicitness(answers) {
            // TODO: wire to questionnaire state once answers persist outside analyzeRole
            const sPos = avg(['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q8'], answers);
            const sNeg = avg(['Q7', 'Q9'], answers);
            return clamp(0.65 * norm(sPos) - 0.35 * norm(sNeg) + 0.10, 0, 1);
        }

        function inferredFrictionDecay(answers) {
            // TODO: wire to questionnaire state once answers persist outside analyzeRole
            const get = (key) => (answers && typeof answers[key] === 'number') ? answers[key] : 3;
            let lam = 0.02;
            lam += 0.01 * (norm(get('Q12')) - 0.5);
            lam += 0.01 * (norm(get('Q15')) - 0.5);
            lam += 0.005 * (norm(get('Q13')) - 0.5);
            lam += 0.005 * (norm(get('Q14')) - 0.5);
            lam -= 0.01 * (norm(get('Q11')) - 0.5);
            lam -= 0.01 * (norm(get('Q10')) - 0.5);
            return clamp(lam, 0.005, 0.05);
        }

        function inferredPace(answers) {
            // Map questionnaire responses into a METR pace multiplier.
            const get = (key) => (answers && typeof answers[key] === 'number') ? answers[key] : 3;
            const normDiff = (key) => norm(get(key)) - 0.5;

            let pace = 1.0;

            const acceleratorWeights = {
                Q2: 0.20,   // Data availability accelerates when high
                Q6: 0.10,   // Standardized workflows accelerate automation
                Q8: 0.10,   // Fast feedback loops accelerate iteration
                Q13: 0.15,  // Company adoption culture accelerates
                Q16: 0.15   // Strong IT infrastructure accelerates
            };

            const frictionWeights = {
                Q7: 0.18,   // Context dependence slows automation when high
                Q9: 0.20,   // Tacit knowledge slows transfer
                Q11: 0.24,  // Relationship-heavy work slows automation
                Q12: 0.28   // Physical presence needs slow automation
            };

            for (const [key, weight] of Object.entries(acceleratorWeights)) {
                pace -= weight * normDiff(key);
            }

            for (const [key, weight] of Object.entries(frictionWeights)) {
                pace += weight * normDiff(key);
            }

            return clamp(pace, 0.5, 2.0);
        }

        function resolvedDomainPace() {
            const slider = document.getElementById('industry-pace');
            // Slider now represents friction (1.0 to 2.0, default 1.0)
            // Higher friction = slower automation (software = 1.0, nothing is easier)
            const frictionValue = slider ? parseFloat(slider.value) : domainPaceSliderBaseline;
            const normalized = frictionValue / domainPaceSliderBaseline;
            const base = currentParams && typeof currentParams.domainPace === 'number'
                ? currentParams.domainPace
                : 1.0;
            const combined = base * normalized;
            return clamp(combined, 1.0, 3.0);
        }

        function resolvedReliabilityTarget() {
            const slider = document.getElementById('ai-reliability');
            if (slider) {
                const percentValue = parseInt(slider.value); // 50-99
                return percentValue / 100.0; // Convert to 0.50-0.99
            }
            return METR_DEFAULTS.r_target; // Default 0.95
        }

        

        // METR-based capability functions

        // Reliability adjustment factor fitted to METR empirical data (logistic calibration)
        // Uses f(r) = exp(-σ · logit(r)) where logit(r) = ln(r/(1-r))
        // σ is calibrated from METR's H50_0/H80_0 ratio (137/26.37 ≈ 5.19×)
        // Examples: f(0.50)=1.0×, f(0.80)≈5.2×, f(0.95)≈33.1×, f(0.99)≈235×
        // We DIVIDE H by f(r), so higher reliability → lower H → AI can only handle shorter tasks
        function reliabilityFactor(r) {
            const lower = 0.5 + RELIABILITY_GUARD;
            const upper = 0.99 - RELIABILITY_GUARD;
            const target = clamp(r, lower, upper);
            const odds = target / (1 - target);
            const logit = Math.log(odds);
            return Math.exp(-METR_SIGMA * logit);
        }

        // METR capability: H_r(t) = (H50_0 * 2^(months_elapsed / D_eff)) / f(r)
        // Returns maximum human-equivalent task length (in minutes) AI can handle at time t with reliability r
        // Higher H = better AI (can handle longer/harder tasks that take humans more time)
        // As time progresses, H increases (AI improves and tackles longer tasks)
        // Higher reliability requirement → larger f(r) → lower H → can only automate shorter tasks
        // Lower reliability requirement → smaller f(r) → higher H → can automate longer tasks
        function H_r(tYears, H50_0 = METR_DEFAULTS.H50_0, r = null) {
            // METR doubling time is FIXED - never modified
            const D_months = METR_DEFAULTS.D_months;  // Always 7 months
            const reliability = r !== null ? r : resolvedReliabilityTarget();

            const monthsElapsed = tYears * 12;
            const progress = Math.pow(2, monthsElapsed / D_months);
            const f_r = reliabilityFactor(reliability);

            // Industry friction affects CAPABILITY (via domainPenalty), NOT doubling time
            // domainPenalty > 1 decreases H (makes AI relatively worse for domain-mismatched roles)
            // industryFriction from slider multiplies the penalty
            const industryFriction = resolvedDomainPace();  // From slider
            const rolePenalty = currentParams && typeof currentParams.domainPenalty === 'number'
                ? currentParams.domainPenalty
                : 1.0;
            const totalPenalty = rolePenalty * industryFriction;  // Both layers multiply
            const baselineMinutes = H50_0 / totalPenalty;  // Friction reduces effective capability

            // FIXED: Multiply by progress, divide by f_r
            // - progress increases H over time (AI tackles harder tasks)
            // - f(r) decreases H for higher reliability (more restrictive threshold)
            return (baselineMinutes * progress) / f_r;
        }

        // Logistic gate for single task bucket: G(H, L_i, s) = 1 / (1 + exp(-(ln(H) - ln(L_i)) / s))
        // Returns probability that AI can complete tasks of duration L_i given current capability H
        // H = max task length AI can handle; higher H → better AI → higher readiness
        // When H > L: AI can handle this task → gate opens (high probability)
        // When H < L: AI cannot handle this task → gate closes (low probability)
        function taskGate(H, L, s = METR_DEFAULTS.softness) {
            const logH = Math.log(Math.max(0.01, H));  // Prevent log(0)
            const logL = Math.log(L);
            const exponent = -(logH - logL) / s;  // FIXED: ln(H) - ln(L) so higher H → higher readiness
            return 1.0 / (1.0 + Math.exp(exponent));
        }

        // AI Readiness: A(t) = Σ w_i * G(H_r(t), L_i, s)
        // Returns value in [0, 1] representing fraction of job tasks AI can perform
        // UPDATED: Now uses seniority-based task weights and softness
        function A_job(tYears) {
            const H = H_r(tYears);
            const buckets = METR_DEFAULTS.taskBuckets;

            // Get seniority level and answers from currentParams (default to entry level)
            const seniorityLevel = (currentParams && currentParams.seniority) || 1;
            const answers = (currentParams && currentParams.answers) || null;
            const weights = getTaskWeightsForSeniority(seniorityLevel, answers);
            const s = getSoftnessForSeniority(seniorityLevel, answers);

            let readiness = 0;
            for (let i = 0; i < buckets.length; i++) {
                readiness += weights[i] * taskGate(H, buckets[i].L, s);
            }

            // Ensure bounded [0, 1]
            return Math.max(0, Math.min(1, readiness));
        }

        // Legacy compatibility functions (kept for now but unused)
        // METR model acceptance tests
        function runMETRAcceptanceTests() {
            console.log('\n=== METR MODEL ACCEPTANCE TESTS ===\n');

            // Test 1: A(t) is bounded [0,1]
            console.log('TEST 1: A(t) bounded [0,1]');
            const testTimes = [0, 1, 2, 3, 5, 10, 15, 20];
            let allBounded = true;
            testTimes.forEach(t => {
                const A_t = A_job(t);
                const bounded = A_t >= 0 && A_t <= 1;
                console.log(`  A(${t}yr) = ${A_t.toFixed(4)} ${bounded ? '✓' : '✗ OUT OF BOUNDS'}`);
                if (!bounded) allBounded = false;
            });
            console.log(`  RESULT: ${allBounded ? 'PASS ✓' : 'FAIL ✗'}\n`);

            // Test 2: Increasing r shifts milestones later
            console.log('TEST 2: Increasing r → later milestones');
            const findMilestone = (r_val, targetProb = 0.5) => {
                // Temporarily override reliability
                const origA = A_job;
                window.A_job = function(tYears) {
                    const H = H_r(tYears, METR_DEFAULTS.H50_0, r_val);
                    const buckets = METR_DEFAULTS.taskBuckets;
                    const s = METR_DEFAULTS.softness;
                    let readiness = 0;
                    for (const bucket of buckets) {
                        readiness += bucket.w * taskGate(H, bucket.L, s);
                    }
                    return Math.max(0, Math.min(1, readiness));
                };

                let low = 0, high = 50;
                while (high - low > 0.1) {
                    const mid = (low + high) / 2;
                    const prob = calculateDisplacementProbability(mid);
                    if (prob < targetProb) low = mid;
                    else high = mid;
                }
                window.A_job = origA;
                return (low + high) / 2;
            };

            const milestone_r90 = findMilestone(0.90);
            const milestone_r95 = findMilestone(0.95);
            const milestone_r99 = findMilestone(0.99);
            console.log(`  50% milestone at r=0.90: ${milestone_r90.toFixed(2)} years`);
            console.log(`  50% milestone at r=0.95: ${milestone_r95.toFixed(2)} years`);
            console.log(`  50% milestone at r=0.99: ${milestone_r99.toFixed(2)} years`);
            const shiftCorrect = milestone_r99 > milestone_r95 && milestone_r95 > milestone_r90;
            console.log(`  RESULT: ${shiftCorrect ? 'PASS ✓' : 'FAIL ✗'}\n`);

            // Test 3: Decreasing D_months shifts earlier
            console.log('TEST 3: Decreasing D_months → earlier milestones');
            console.log('  (Tested via slider - lower doubling = earlier automation)\n');

            // Test 4: Blue and Green curves identical except for delay
            console.log('TEST 4: Green = Blue shifted by delay');
            console.log('  Green curve at t=T should equal Blue curve at t=(T-delay)');
            console.log('  This is enforced by updateChart() implementation ✓\n');

            console.log('  Note: implementation now uses dynamic delay(t) = delay0 * exp(-lambda * t)');
            console.log('  Green(t) computed as Blue(max(t - delay(t), 0))');
            // Test 5: Key diagnostic values
            console.log('DIAGNOSTIC VALUES:');
            console.log(`  H_r(0) = ${H_r(0).toFixed(2)} minutes (baseline capability)`);
            console.log(`  H_r(5) = ${H_r(5).toFixed(4)} minutes (more capable → lower time)`);
            console.log(`  A(0) = ${A_job(0).toFixed(4)} (should be near 0)`);
            console.log(`  A(5) = ${A_job(5).toFixed(4)} (should be in [0,1])`);
            console.log(`  reliability factor f(0.95) = ${reliabilityFactor(0.95).toFixed(4)}`);

            console.log('\n=== END ACCEPTANCE TESTS ===\n');
        }

        // Unit tests to guard against regressions from patch
        function runRegressionTests() {
            console.log('\n=== REGRESSION GUARD TESTS (PATCH) ===\n');

            let allPassed = true;

            // Test 1: Gate direction - faster AI (lower H) should give higher readiness
            console.log('TEST 1: Gate direction');
            const s = 0.45, L = 10;
            const gateSlow = taskGate(1, L, s);    // H=1 is slow/low capability AI
            const gateFast = taskGate(100, L, s);  // H=100 is fast/high capability AI
            const gatePass = gateFast > gateSlow;
            console.log(`  taskGate(H=1, L=10) = ${gateSlow.toFixed(4)}`);
            console.log(`  taskGate(H=100, L=10) = ${gateFast.toFixed(4)}`);
            console.log(`  RESULT: ${gatePass ? 'PASS ✓' : 'FAIL ✗'} (faster AI must have higher readiness)`);
            if (!gatePass) allPassed = false;
            console.log('  Note: taskGate increases with higher H at fixed L (direction check)');

            // Test 2: Reliability factor - r=0.95 should be ~13.5×, r=0.99 should be ~69-72×
            console.log('\nTEST 2: Reliability factor');
            console.log('  Expected scale: f(0.95) ~33x, f(0.99) ~235x');
            const f95 = reliabilityFactor(0.95);
            const f99 = reliabilityFactor(0.99);
            const reliabilityPass = (f95 > 25 && f95 < 45) && (f99 > 180 && f99 < 320);
            console.log(`  f(0.95) = ${f95.toFixed(2)} (expected ~33)`);
            console.log(`  f(0.99) = ${f99.toFixed(2)} (expected ~235)`);
            console.log(`  RESULT: ${reliabilityPass ? 'PASS ✓' : 'FAIL ✗'}`);
            if (!reliabilityPass) allPassed = false;

            // Test 3: Green curve clamp - should never sample negative time
            console.log('\nTEST 3: Green curve clamp');
            const delay = 2;
            const blueCurve = (t) => (t <= 0 ? 0 : Math.min(t / 4, 1));
            const greenAt1 = 1 >= delay ? blueCurve(1 - delay) : 0;
            const clampPass = greenAt1 === 0;
            console.log(`  Green(t=1) with delay=2 should = Blue(max(1-2, 0)) = Blue(0) = 0`);
            console.log(`  Actual: ${greenAt1}`);
            console.log(`  RESULT: ${clampPass ? 'PASS ✓' : 'FAIL ✗'}`);
            if (!clampPass) allPassed = false;

            // Test 4: Seniority task weight shift - Executive should shift to longer tasks
            console.log('\nTEST 4: Seniority weight shift');
            const baseWeights = METR_DEFAULTS.taskBuckets.map(b => b.w);
            const execWeights = getTaskWeightsForSeniority(5);  // Executive
            const shiftPass = execWeights[3] > baseWeights[3] &&
                             execWeights[0] < baseWeights[0] &&
                             execWeights[1] < baseWeights[1];
            console.log(`  Base weights (Entry): [${baseWeights.map(w => w.toFixed(2)).join(', ')}]`);
            console.log(`  Exec weights: [${execWeights.map(w => w.toFixed(2)).join(', ')}]`);
            console.log(`  RESULT: ${shiftPass ? 'PASS ✓' : 'FAIL ✗'} (Exec shifts weight to longer tasks)`);
            if (!shiftPass) allPassed = false;

            // Test 5: Doubling dynamics - progress should double in 7 months
            console.log('\nTEST 5: Doubling dynamics');
            const D = 7;
            const months = 7;
            const progress = Math.pow(2, months / D);
            const doublingPass = Math.abs(progress - 2) < 1e-6;
            console.log(`  Progress after 7 months with D=7: ${progress.toFixed(6)}`);
            console.log(`  RESULT: ${doublingPass ? 'PASS ✓' : 'FAIL ✗'} (should be exactly 2.0)`);
            if (!doublingPass) allPassed = false;

            console.log(`\n=== OVERALL: ${allPassed ? 'ALL TESTS PASSED ✓' : 'SOME TESTS FAILED ✗'} ===\n`);
        }

        // WWILMJ PATCH: Regression tests to verify slider direction and weight normalization
        function runPatchRegressionTests() {
            console.log('\n=== WWILMJ PATCH REGRESSION TESTS ===\n');

            let allPassed = true;

            // Helper: Create neutral answers (all 3s)
            const neutralAnswers = {};
            for (let i = 1; i <= 19; i++) neutralAnswers[`Q${i}`] = 3;

            // Test 1: Q5 direction - moving from 1→5 should INCREASE hazardMult
            console.log('TEST 1: Q5 direction (decomposability)');
            const q5Low = { ...neutralAnswers, Q5: 1 };  // Very Complex
            const q5High = { ...neutralAnswers, Q5: 5 }; // Highly Structured
            const { ampMult: ampQ5Low, fricMult: fricQ5Low } = computeHazardMultipliers(q5Low);
            const { ampMult: ampQ5High, fricMult: fricQ5High } = computeHazardMultipliers(q5High);
            const multQ5Low = ampQ5Low * fricQ5Low;
            const multQ5High = ampQ5High * fricQ5High;
            const q5Pass = multQ5High > multQ5Low;
            console.log(`  Q5=1 (complex): hazardMult = ${multQ5Low.toFixed(3)}`);
            console.log(`  Q5=5 (structured): hazardMult = ${multQ5High.toFixed(3)}`);
            console.log(`  RESULT: ${q5Pass ? 'PASS ✓' : 'FAIL ✗'} (moving 1→5 should increase hazard)`);
            if (!q5Pass) allPassed = false;

            // Test 2: Q12 direction - moving from 1→5 should DECREASE hazardMult
            console.log('\nTEST 2: Q12 direction (physical presence)');
            const q12Low = { ...neutralAnswers, Q12: 1 };  // None
            const q12High = { ...neutralAnswers, Q12: 5 }; // Essential
            const { ampMult: ampQ12Low, fricMult: fricQ12Low } = computeHazardMultipliers(q12Low);
            const { ampMult: ampQ12High, fricMult: fricQ12High } = computeHazardMultipliers(q12High);
            const multQ12Low = ampQ12Low * fricQ12Low;
            const multQ12High = ampQ12High * fricQ12High;
            const q12Pass = multQ12High < multQ12Low;
            console.log(`  Q12=1 (none): hazardMult = ${multQ12Low.toFixed(3)}`);
            console.log(`  Q12=5 (essential): hazardMult = ${multQ12High.toFixed(3)}`);
            console.log(`  RESULT: ${q12Pass ? 'PASS ✓' : 'FAIL ✗'} (moving 1→5 should decrease hazard)`);
            if (!q12Pass) allPassed = false;

            // Test 3: Q15 direction - moving from 1→5 should INCREASE delayYears
            console.log('\nTEST 3: Q15 direction (labor market tightness)');
            const q15Easy = { ...neutralAnswers, Q15: 1 };       // Very Easy to hire
            const q15Difficult = { ...neutralAnswers, Q15: 5 };  // Very Difficult to hire
            const delayEasy = calculateImplementationDelay(q15Easy, 1);
            const delayDifficult = calculateImplementationDelay(q15Difficult, 1);
            const q15Pass = delayDifficult > delayEasy;
            console.log(`  Q15=1 (easy to hire): delay = ${delayEasy.toFixed(2)} years`);
            console.log(`  Q15=5 (difficult to hire): delay = ${delayDifficult.toFixed(2)} years`);
            console.log(`  RESULT: ${q15Pass ? 'PASS ✓' : 'FAIL ✗'} (moving 1→5 should increase delay)`);
            if (!q15Pass) allPassed = false;

            // Test 4: Calibration - Max(Q1,Q4,Q6)=5 vs all=3 should yield ≥2.5× hazard
            console.log('\nTEST 4: High-risk amplifier stack (Q1+Q4+Q6 max)');
            const maxRiskAnswers = { ...neutralAnswers, Q1: 5, Q4: 5, Q6: 5 };
            const { ampMult: neutralAmp, fricMult: neutralFric } = computeHazardMultipliers(neutralAnswers);
            const { ampMult: maxAmp, fricMult: maxFric } = computeHazardMultipliers(maxRiskAnswers);
            const neutralMult = neutralAmp * neutralFric;
            const maxMult = maxAmp * maxFric;
            const multRatio = maxMult / neutralMult;
            const calibPass = multRatio >= 2.5;
            console.log(`  Neutral (all 3s): hazardMult = ${neutralMult.toFixed(3)}`);
            console.log(`  Max risk (Q1,Q4,Q6=5): hazardMult = ${maxMult.toFixed(3)}`);
            console.log(`  Ratio: ${multRatio.toFixed(2)}×`);
            console.log(`  RESULT: ${calibPass ? 'PASS ✓' : 'FAIL ✗'} (should be ≥2.5×)`);
            if (!calibPass) allPassed = false;

            // Test 5: Protective stack - Q7=5, Q9=5, Q12=5, Q14=5 should suppress hazard ≤0.5× AND increase delay ≥0.7y
            console.log('\nTEST 5: Protective stack (Q7+Q9+Q12 high friction, Q14 high)');
            const protectiveAnswers = { ...neutralAnswers, Q7: 5, Q9: 5, Q12: 5, Q14: 5 };
            const { ampMult: protAmp, fricMult: protFric } = computeHazardMultipliers(protectiveAnswers);
            const protMult = protAmp * protFric;
            const protRatio = protMult / neutralMult;
            const neutralDelay = calculateImplementationDelay(neutralAnswers, 1);
            const protDelay = calculateImplementationDelay(protectiveAnswers, 1);
            const delayIncrease = protDelay - neutralDelay;
            const protPass = protRatio <= 0.5 && delayIncrease >= 0.7;
            console.log(`  Protective stack: hazardMult = ${protMult.toFixed(3)} (ratio: ${protRatio.toFixed(2)}×)`);
            console.log(`  Neutral delay: ${neutralDelay.toFixed(2)}y, Protective delay: ${protDelay.toFixed(2)}y`);
            console.log(`  Delay increase: ${delayIncrease.toFixed(2)}y`);
            console.log(`  RESULT: ${protPass ? 'PASS ✓' : 'FAIL ✗'} (hazard ≤0.5× AND delay +≥0.7y)`);
            if (!protPass) allPassed = false;

            // Test 6: Q1 min→max swing should produce ≥12pp increase in 2030 risk
            console.log('\nTEST 6: Q1 swing impact on 2030 risk');
            // Helper to compute risk by 2030
            const computeRisk2030 = (answers) => {
                const { ampMult, fricMult } = computeHazardMultipliers(answers);
                const mismatch = computeDomainMismatch(answers);
                const savedParams = currentParams;
                currentParams = {
                    h0: 0.015, theta: 0.50, gamma: 1.2, kappa: 0.3, friction: 3.0,
                    seniority: 1, seniorityProfile: SENIORITY_PROFILES[0],
                    s_e: inferredExplicitness(answers), lambda: inferredFrictionDecay(answers),
                    domainPace: inferredPace(answers),
                    ampMult: ampMult, fricMult: fricMult,
                    domainPenalty: mismatch.penalty, domainAlignment: mismatch.alignment,
                    answers: answers, implementationDelay: 0
                };
                const risk = calculateDisplacementProbability(5.35);
                currentParams = savedParams;
                return risk;
            };
            const q1Min = { ...neutralAnswers, Q1: 1 };
            const q1Max = { ...neutralAnswers, Q1: 5 };
            const riskQ1Min = computeRisk2030(q1Min);
            const riskQ1Max = computeRisk2030(q1Max);
            const q1Delta = (riskQ1Max - riskQ1Min) * 100;
            const q1SwingPass = q1Delta >= 12;
            console.log(`  Q1=1: 2030 risk = ${(riskQ1Min * 100).toFixed(1)}%`);
            console.log(`  Q1=5: 2030 risk = ${(riskQ1Max * 100).toFixed(1)}%`);
            console.log(`  Delta: ${q1Delta.toFixed(1)}pp`);
            console.log(`  RESULT: ${q1SwingPass ? 'PASS ✓' : 'FAIL ✗'} (should be ≥12pp)`);
            if (!q1SwingPass) allPassed = false;

            console.log(`\n=== PATCH TESTS: ${allPassed ? 'ALL PASSED ✓' : 'SOME FAILED ✗'} ===\n`);
            return allPassed;
        }

        // Test new features: task weight personalization and lambda friction decay
        function runFeatureImplementationTests() {
            console.log('\n=== FEATURE IMPLEMENTATION TESTS ===\n');

            let allPassed = true;

            // Helper: Create neutral answers (all 3s)
            const neutralAnswers = {};
            for (let i = 1; i <= 19; i++) neutralAnswers[`Q${i}`] = 3;

            // Test 1: Q5/Q6/Q7 affect task weights
            console.log('TEST 1: Q5/Q6/Q7 affect task weights');
            const structuredAnswers = { ...neutralAnswers, Q5: 5, Q6: 5, Q7: 1 };  // Structured, standardized, low context
            const complexAnswers = { ...neutralAnswers, Q5: 1, Q6: 1, Q7: 5 };     // Complex, bespoke, high context

            const weightsStructured = getTaskWeightsForSeniority(1, structuredAnswers);
            const weightsComplex = getTaskWeightsForSeniority(1, complexAnswers);

            // Structured should have more weight in short tasks (buckets 0,1), less in long tasks (buckets 3,4)
            const shortTasksStructured = weightsStructured[0] + weightsStructured[1];
            const shortTasksComplex = weightsComplex[0] + weightsComplex[1];
            const longTasksStructured = weightsStructured[3] + weightsStructured[4];
            const longTasksComplex = weightsComplex[3] + weightsComplex[4];

            const test1Pass = shortTasksStructured > shortTasksComplex && longTasksStructured < longTasksComplex;
            console.log(`  Structured (Q5=5,Q6=5,Q7=1): short=${(shortTasksStructured*100).toFixed(1)}%, long=${(longTasksStructured*100).toFixed(1)}%`);
            console.log(`  Complex (Q5=1,Q6=1,Q7=5): short=${(shortTasksComplex*100).toFixed(1)}%, long=${(longTasksComplex*100).toFixed(1)}%`);
            console.log(`  RESULT: ${test1Pass ? 'PASS ✓' : 'FAIL ✗'} (structured should have more short tasks)`);
            if (!test1Pass) allPassed = false;

            // Test 2: Seniority affects task weights (Executive vs Entry)
            console.log('\nTEST 2: Seniority affects task weights');
            const weightsEntry = getTaskWeightsForSeniority(1, neutralAnswers);    // Entry
            const weightsExec = getTaskWeightsForSeniority(5, neutralAnswers);     // Executive

            const shortTasksEntry = weightsEntry[0] + weightsEntry[1];
            const shortTasksExec = weightsExec[0] + weightsExec[1];
            const longTasksEntry = weightsEntry[3] + weightsEntry[4];
            const longTasksExec = weightsExec[3] + weightsExec[4];

            const test2Pass = shortTasksEntry > shortTasksExec && longTasksEntry < longTasksExec;
            console.log(`  Entry (seniority=1): short=${(shortTasksEntry*100).toFixed(1)}%, long=${(longTasksEntry*100).toFixed(1)}%`);
            console.log(`  Executive (seniority=5): short=${(shortTasksExec*100).toFixed(1)}%, long=${(longTasksExec*100).toFixed(1)}%`);
            console.log(`  RESULT: ${test2Pass ? 'PASS ✓' : 'FAIL ✗'} (entry should have more short tasks)`);
            if (!test2Pass) allPassed = false;

            // Test 3: Lambda affects dynamic delay
            console.log('\nTEST 3: Lambda affects dynamic implementation delay');
            const lowLambdaAnswers = { ...neutralAnswers, Q11: 5, Q11: 5, Q12: 1, Q15: 1 };  // Low friction decay
            const highLambdaAnswers = { ...neutralAnswers, Q11: 1, Q11: 1, Q12: 5, Q15: 5 }; // High friction decay

            const lambdaLow = inferredFrictionDecay(lowLambdaAnswers);
            const lambdaHigh = inferredFrictionDecay(highLambdaAnswers);

            // Test how lambda affects delay at t=5 years
            const baseDelay = 2.0;
            const dynamicDelayLow = baseDelay * Math.exp(-lambdaLow * 5);
            const dynamicDelayHigh = baseDelay * Math.exp(-lambdaHigh * 5);

            const test3Pass = lambdaHigh > lambdaLow && dynamicDelayHigh < dynamicDelayLow;
            console.log(`  Low friction decay (λ=${lambdaLow.toFixed(3)}): delay at t=5 is ${dynamicDelayLow.toFixed(2)}y`);
            console.log(`  High friction decay (λ=${lambdaHigh.toFixed(3)}): delay at t=5 is ${dynamicDelayHigh.toFixed(2)}y`);
            console.log(`  RESULT: ${test3Pass ? 'PASS ✓' : 'FAIL ✗'} (higher λ should reduce delay faster)`);
            if (!test3Pass) allPassed = false;

            // Test 4: Softness varies by seniority and task complexity
            console.log('\nTEST 4: Softness varies by seniority and task complexity');
            const softnessEntryStructured = getSoftnessForSeniority(1, structuredAnswers);
            const softnessExecComplex = getSoftnessForSeniority(5, complexAnswers);

            const test4Pass = softnessExecComplex > softnessEntryStructured;
            console.log(`  Entry + Structured: softness=${softnessEntryStructured.toFixed(3)} (sharper gates)`);
            console.log(`  Executive + Complex: softness=${softnessExecComplex.toFixed(3)} (smoother gates)`);
            console.log(`  RESULT: ${test4Pass ? 'PASS ✓' : 'FAIL ✗'} (exec+complex should have smoother gates)`);
            if (!test4Pass) allPassed = false;

            console.log(`\n=== FEATURE TESTS: ${allPassed ? 'ALL PASSED ✓' : 'SOME FAILED ✗'} ===\n`);
            return allPassed;
        }

        // Helper: Update sliders based on role preset and seniority
        function updateSlidersFromPreset() {
            if (!selectedRole) {
                console.log('[updateSlidersFromPreset] No role selected');
                return;
            }

            const presets = window.WWILMJ_PRESETS;
            if (!presets) {
                console.error('[updateSlidersFromPreset] WWILMJ_PRESETS not loaded!');
                return;
            }

            const rolePreset = presets.ROLE_PRESETS[selectedRole];
            if (!rolePreset) {
                console.warn('[updateSlidersFromPreset] No preset for role:', selectedRole);
                return;
            }

            // Get current seniority level
            const seniorityChecked = document.querySelector('input[name="seniority"]:checked');
            const seniorityLevel = seniorityChecked ? parseInt(seniorityChecked.value) : 1;

            console.log('[updateSlidersFromPreset] Role:', selectedRole, 'Seniority:', seniorityLevel,
                        'Preset:', rolePreset);

            // Update industry friction slider
            const frictionSlider = document.getElementById('industry-pace');
            if (frictionSlider && rolePreset.friction) {
                frictionSlider.value = rolePreset.friction;
                document.getElementById('industry-pace-value').textContent = rolePreset.friction.toFixed(2) + 'x';
                console.log('[updateSlidersFromPreset] Updated friction to', rolePreset.friction);
            }

            // Update reliability slider (includes seniority adjustment)
            const reliabilitySlider = document.getElementById('ai-reliability');
            if (reliabilitySlider) {
                const recommendedR = presets.recommendReliability(selectedRole, seniorityLevel);
                const percentValue = Math.round(recommendedR * 100);
                reliabilitySlider.value = percentValue;
                document.getElementById('ai-reliability-value').textContent = percentValue + '%';
                console.log('[updateSlidersFromPreset] Updated reliability to', percentValue + '%',
                           '(base:', rolePreset.reliabilityBase, 'seniority adj:',
                           presets.SENIORITY_R_DELTAS[seniorityLevel - 1] || 0, ')');
            }
        }

        // Tests will be run after DOM is ready (see DOMContentLoaded handler below)
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedRole = this.dataset.role;

                updateSlidersFromPreset();
                analyzeRole();
                // Refresh bucket editor for new role context
                try { initTaskBucketEditor(); } catch (e) {}
            });
        });

        // Add event listeners to all radio buttons to auto-update
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // If seniority changed, update sliders (reliability adjusts by seniority)
                if (this.name === 'seniority') {
                    updateSlidersFromPreset();
                }
                analyzeRole();
                try { initTaskBucketEditor(); } catch (e) {}
            });
        });

        function getQuestionValue(questionNum) {
            const checked = document.querySelector(`input[name="q${questionNum}"]:checked`);
            return checked ? parseFloat(checked.value) : 3;
        }

        // Per-question log-hazard multipliers for TECHNICAL FEASIBILITY (Blue Curve)
        // ONLY factors that determine when AI CAN technically do the job
        // All sliders: 1→−2, 3→0, 5→+2 (coded uniformly). Direction comes from weight sign.
        const QUESTION_WEIGHTS = {
            // BLUE: Technical feasibility (amp increases risk, fric protects)
            Q1:  { amp: +0.50 },  // Current AI Performance (reduced from 0.80 to prevent over-weighting subjective assessment)
            Q2:  { amp: +0.40 },  // Data Availability
            Q3:  { amp: +0.35 },  // Benchmark Clarity
            Q4:  { amp: +0.55 },  // Task Digitization
            Q5:  { amp: +0.50 },  // Task Decomposability
            Q6:  { amp: +0.45 },  // Task Standardization
            Q7:  { fric: -0.50 }, // Context Dependency
            Q8:  { amp: +0.45 },  // Feedback Loop Speed
            Q9:  { fric: -0.40 }, // Tacit Knowledge
            Q11: { fric: -0.45 }, // Human Judgment & Relationships
            Q12: { fric: -0.60 }, // Physical Presence (strongest barrier - embodiment)
            // Q13-Q15: Company/Industry context - affects implementation delay only
            // Q17, Q17: Re-employment factors - affects job search success only
            // Q19: Job retention factor - affects implementation delay and re-employment (dual purpose)
        };

        const DOMAIN_ALIGNMENT_WEIGHTS = {
            Q4: +0.28,  // Task digitization
            Q5: +0.24,  // Task decomposability
            Q6: +0.22,  // Task standardization
            Q7: -0.32,  // Context dependency
            Q9: -0.28,  // Tacit knowledge
            Q11: -0.34, // Human judgment & relationships
            Q12: -0.38  // Physical presence
        };

        function computeDomainMismatch(answers) {
            let weightedSum = 0;
            for (const [qid, weight] of Object.entries(DOMAIN_ALIGNMENT_WEIGHTS)) {
                const raw = answers && Object.prototype.hasOwnProperty.call(answers, qid) ? answers[qid] : 3;
                const x = codeAnswer(qid, raw);
                weightedSum += weight * x;
            }
            weightedSum = Math.max(-3.0, Math.min(3.0, weightedSum));
            const penalty = clamp(Math.exp(-weightedSum), 0.5, 3.0);
            const alignment = clamp(0.5 + 0.18 * weightedSum, 0, 1);
            return { penalty, alignment, weightedSum };
        }


        // Implementation delay weights - delays actual job loss from technical feasibility (Green Curve)
        // Formula: delay = 1.75 - (delayScore * 1.25)
        // To get MORE delay when value is LOW, we need POSITIVE weight (converts negative coded value to negative score)
        const IMPLEMENTATION_WEIGHTS = {
            // Company/Industry Context (Q13-Q15)
            Q13: +0.40,  // Company AI adoption: 1=Resistant (more delay), 5=Leading Edge (less delay)
            Q14: +0.30,  // Labor cost pressure: 1=Not Sensitive (more delay), 5=Extremely Sensitive (less delay)
            Q15: -0.35,  // Labor market tightness: 5=Very Difficult (more delay), 1=Very Easy (less delay)
            Q16: +0.35,  // IT infrastructure: 1=Very Outdated (more delay), 5=Cutting Edge (less delay)
            // Job Retention Factor (Q19)
            Q19: -0.20,  // Job performance: 5=Top 10% (more delay), 1=Below Average (less delay) - reduced weight; also modulates seniority shift
        };

        // Re-employment probability weights (Q17, Q17, Q18) - affects ability to find new job
        const REEMPLOYMENT_WEIGHTS = {
            Q17: +0.50,  // Skill transferability: 5=Highly Transferable (higher re-employment), 1=Highly Specific (lower)
            Q18: +0.50,  // Adaptability: 5=Very Fast (higher re-employment), 1=Very Slow (lower)
            Q19: +0.30,  // Job performance: 5=Top 10% (higher re-employment), 1=Below Average (lower re-employment)
        };

        // Code raw answers to numeric x_i, aiming for symmetric effects
        // Likert 1..5 -> -2..+2; booleans -> +/-1; fallback 0.
        function codeAnswer(qid, raw) {
            if (typeof raw === 'number' && raw >= 1 && raw <= 5) return raw - 3;
            if (raw === true) return +1;
            if (raw === false) return -1;
            return 0;
        }

        // Compute hazard multipliers from all answers
        function computeHazardMultipliers(answers) {
            let sumAmp = 0, sumFric = 0;
            for (const [qid, raw] of Object.entries(answers)) {
                const w = QUESTION_WEIGHTS[qid];
                if (!w) continue;
                const x = codeAnswer(qid, raw);
                if (w.amp)  sumAmp  += w.amp  * x;
                if (w.fric) sumFric += w.fric * x;
            }
            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
            sumAmp  = clamp(sumAmp,  -2.0, +2.0);  // ≈ 0.14× .. 7.4×
            sumFric = clamp(sumFric, -2.0, +2.0);
            return { ampMult: Math.exp(sumAmp), fricMult: Math.exp(sumFric) };
        }

        // Calculate implementation delay in years (0.5 - 3 years), scaled by seniority
        function calculateImplementationDelay(answers, seniority, seniorityProfile = SENIORITY_PROFILES[seniority - 1] || SENIORITY_PROFILES[0]) {
            let delayScore = 0;
            for (const [qid, weight] of Object.entries(IMPLEMENTATION_WEIGHTS)) {
                const raw = answers[qid];
                const x = codeAnswer(qid, raw);
                delayScore += weight * x;
            }
            delayScore = clamp(delayScore, -2.0, +2.0);
            let delay = 1.75 - 1.25 * delayScore;
            delay = clamp(delay, 0.5, 3.0);
            // Performance-modulated seniority shift (sign-aware)
            const q19Raw = (answers && typeof answers.Q19 === 'number') ? answers.Q19 : 3;
            const q19Norm = (q19Raw - 1) / 4; // in [0,1]
            const baseShift = seniorityProfile ? (seniorityProfile.delayShift || 0) : 0;
            const s = Math.sign(baseShift) || 1;
            const perfAdj = 1 + 0.5 * (q19Norm - 0.5) * s; // factor in [0.75, 1.25]
            const effectiveShift = baseShift * perfAdj;
            delay += effectiveShift;
            return clamp(delay, 0.3, 4.0);
        }

        // Calculate re-employment probability (0-1 scale)
        // Dependent on technical feasibility timing and seniority
        function calculateReemploymentProbability(answers, seniority, medianTechYears) {
            let reemployScore = 0;
            for (const [qid, weight] of Object.entries(REEMPLOYMENT_WEIGHTS)) {
                const raw = answers[qid];
                const x = codeAnswer(qid, raw);
                reemployScore += weight * x;
            }
            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
            reemployScore = clamp(reemployScore, -2.0, +2.0);

            // Base probability from adaptability factors
            let probability = 0.6 + (reemployScore * 0.2);

            // Penalize based on how soon automation happens (sooner = harder to find work)
            // If median is <3 years: -30%, 3-7 years: -15%, 7-12 years: -5%, >12 years: 0%
            let timingPenalty = 0;
            if (medianTechYears < 3) timingPenalty = 0.30;
            else if (medianTechYears < 7) timingPenalty = 0.15;
            else if (medianTechYears < 12) timingPenalty = 0.05;
            probability -= timingPenalty;

            const seniorityProfile = SENIORITY_PROFILES[seniority - 1] || SENIORITY_PROFILES[0];
            probability *= seniorityProfile.reemploymentBoost;

            return clamp(probability, 0.1, 0.85); // Cap at 85% - no one is guaranteed
        }

        // Optional timing shift via capability gate steepness k (affects BLUE curve only)
        function kEff(baseK, answers) {
            let sumK = 0;
            const K_WEIGHTS = {
                // Accelerators (higher = faster/earlier automation)
                Q1: +0.20, Q2: +0.10, Q3: +0.10, Q4: +0.15, Q8: +0.12,
                // Decelerators (higher = slower/later automation)
                Q5: -0.20, Q6: -0.20, Q7: -0.20, Q9: -0.15, Q10: -0.15, Q11: -0.15
                // Q13-Q15: Company/Industry - affects GREEN curve only
                // Q17, Q17: Re-employment - affects re-employment metric only
                // Q19: Job retention - affects GREEN curve and re-employment (dual purpose)
            };
            for (const [qid, raw] of Object.entries(answers)) {
                const x = codeAnswer(qid, raw);
                if (K_WEIGHTS[qid]) sumK += K_WEIGHTS[qid] * x;
            }
            sumK = Math.max(-1.0, Math.min(+1.0, sumK));
            return baseK * Math.exp(sumK);
        }

        function analyzeRole() {
            if (!selectedRole) {
                return;
            }

            const prevParams = currentParams;
            const roleName = selectedRole === 'custom' ?
                'Other/Custom' :
                document.querySelector(`.preset-btn[data-role="${selectedRole}"]`).textContent.trim();

            // Collect all answers
            const answers = {};
            for (let i = 1; i <= 19; i++) {
                answers[`Q${i}`] = getQuestionValue(i);
            }

            // Get seniority level (1=Entry, 2=Mid, 3=Senior, 4=Lead, 5=Executive)
            const seniorityChecked = document.querySelector('input[name="seniority"]:checked');
            const seniority = seniorityChecked ? parseFloat(seniorityChecked.value) : 1;

            // Compute hazard multipliers from question weights
            const { ampMult, fricMult } = computeHazardMultipliers(answers);

            // Compute section scores for display purposes only (not used in hazard calculation)
            const aiReadiness = (getQuestionValue(1) + getQuestionValue(2) +
                                getQuestionValue(3) + getQuestionValue(4)) / 4;

            const taskAdapt = (getQuestionValue(5) + getQuestionValue(6) + getQuestionValue(7) +
                              getQuestionValue(8) + getQuestionValue(9)) / 5;

            const friction = (getQuestionValue(10) + getQuestionValue(11)) / 2;

            const firmReadiness = (getQuestionValue(12) + getQuestionValue(13) +
                                  getQuestionValue(14) + getQuestionValue(15)) / 4;

            const personalAdapt = (getQuestionValue(16) + getQuestionValue(17) +
                                  getQuestionValue(18)) / 3;

            // Baseline parameters (will be modified by question multipliers)
            const h0_base = 0.015;
            const thetaBase = THETA_BASE_ENTRY;  // Baseline coverage bar before role/domain adjustments
            const gammaBase = 8.0;               // Capability sensitivity to surplus (logistic gate steepness)
            const kappa = 0.3;                   // Baseline friction damping retained for other multipliers
            const frictionValue = 3.0;

            const s_e = inferredExplicitness(answers);
            const lambda = inferredFrictionDecay(answers);
            const domainPace = inferredPace(answers);
            const { penalty: domainPenalty, alignment: domainAlignment } = computeDomainMismatch(answers);

            const seniorityProfile = SENIORITY_PROFILES[seniority - 1] || SENIORITY_PROFILES[0];
            const thetaProfileBase = thetaBase + (seniorityProfile.thetaLift || 0);
            const alignmentShift = 0.12 * (0.5 - domainAlignment);
            const explicitnessShift = 0.10 * (0.5 - s_e);
            const thetaCandidate = thetaProfileBase + alignmentShift + explicitnessShift;
            const thetaEffective = clamp(thetaCandidate, 0.35, 0.72);

            // Apply optional timing shift (capability gate steepness adjustment)
            const gammaEffective = kEff(gammaBase, answers);
            const gammaClamped = clamp(gammaEffective, 3.0, 16.0);

            // Calculate implementation delay (scaled by seniority)
            const implementationDelay = calculateImplementationDelay(answers, seniority, seniorityProfile);

            currentParams = {
                name: roleName,
                h0: h0_base,
                theta: thetaEffective,
                gamma: gammaClamped,
                kappa: kappa,
                friction: frictionValue,
                seniority: seniority,
                seniorityLabel: seniorityProfile.label,
                seniorityProfile: seniorityProfile,
                s_e: s_e,
                lambda: lambda,
                domainPace: domainPace,
                domainPenalty: domainPenalty,
                domainAlignment: domainAlignment,
                aiReadiness: aiReadiness,
                taskAdapt: taskAdapt,
                friction_score: friction,
                firmReadiness: firmReadiness,
                personalAdapt: personalAdapt,
                ampMult: ampMult,
                fricMult: fricMult,
                answers: answers,
                implementationDelay: implementationDelay,
                userBaseWeights: (prevParams && Array.isArray(prevParams.userBaseWeights)) ? prevParams.userBaseWeights : null
            };

            updatePersonalTimeline();
            initChart();
            updateChart();
            initTaskBucketEditor();
        }

        function updatePersonalTimeline() {
            const timeline = document.getElementById('personal-timeline');
            const events = [];
            
            const risk25 = findYearForProbability(0.25, currentParams);
            const risk50 = findYearForProbability(0.5, currentParams);
            const risk75 = findYearForProbability(0.75, currentParams);
            const risk90 = findYearForProbability(0.9, currentParams);
            
            const currentYear = 2025.65;
            
            if (risk25 < 10) {
                events.push({
                    date: (currentYear + risk25).toFixed(1),
                    description: '25% risk AI can technically automate role'
                });
            }
            if (risk50 < 15) {
                events.push({
                    date: (currentYear + risk50).toFixed(1),
                    description: '50% risk AI can technically automate role'
                });
            }
            if (risk75 < 20) {
                events.push({
                    date: (currentYear + risk75).toFixed(1),
                    description: '75% risk AI can technically automate role'
                });
            }
            if (risk90 < 25) {
                events.push({
                    date: (currentYear + risk90).toFixed(1),
                    description: '90% risk AI can technically automate role'
                });
            }
            
            timeline.innerHTML = events.map(e => `
                <div class="timeline-event">
                    <span class="timeline-date">${e.date}</span>
                    <span class="timeline-description">${e.description}</span>
                </div>
            `).join('');
        }

        function resetAnalysis() {
            selectedRole = null;
            currentParams = null;
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            // Reset to default checked values
            document.querySelectorAll('input[type="radio"][value="3"]').forEach(r => r.checked = true);
        }

        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Technical Feasibility of Automation',
                        data: [],
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Actual Job Loss',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${(context.parsed.y * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years from Now'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Compute user multipliers from questions (bounded to 0.33x - 3.0x overall)
        // PATCH: Apply seniority AFTER question product (hazardMult *= (1 - hazardShield))
        // PATCH: Widened from [0.5, 2.0] to [0.33, 3.0] to eliminate dead zones
        function getUserMultiplier() {
            if (!currentParams) return 1.0;

            // Step 1: Compute question-based hazard multiplier (ampMult * fricMult)
            const questionMultiplier = currentParams.ampMult * currentParams.fricMult;

            // Step 2: Apply seniority hazard shield AFTER question multiplier
            const profiles = SENIORITY_PROFILES;
            const idx = Math.max(0, Math.min(profiles.length - 1, (currentParams.seniority || 1) - 1));
            const profile = profiles[idx] || profiles[0];
            const hazardMult = questionMultiplier * (1 - (profile.hazardShield || 0));

            // Step 3: Bound overall multiplier to [0.33, 3.0] (wider band for better slider responsiveness)
            return Math.max(0.33, Math.min(3.0, hazardMult));
        }

        // New logistic gate hazard: lambdaAI(t) = hAI / (1 + exp(-gamma * (A(t) - theta)))
        // No internal time decay (removed e^(-lambda*t))
        // UPDATED: Now uses seniority-based theta (base θ_0 + thetaLift)
        function hazardAI(tYears) {
            if (!currentParams) return 0;

            const hAI = 0.40;           // Max base annual hazard (40% per year at full automation)
            const gammaDefault = 8.0;   // Steepness of logistic gate baseline

            const seniorityLevel = currentParams.seniority || 1;
            const idx = Math.max(0, Math.min(SENIORITY_PROFILES.length - 1, seniorityLevel - 1));
            const profile = SENIORITY_PROFILES[idx];
            const thetaCandidate = typeof currentParams.theta === 'number'
                ? currentParams.theta
                : THETA_BASE_ENTRY + (profile.thetaLift || 0);
            const theta = clamp(thetaCandidate, 0.35, 0.72);

            const gamma = (currentParams && typeof currentParams.gamma === 'number')
                ? currentParams.gamma
                : gammaDefault;

            const A_t = A_job(tYears);
            const logisticArg = -gamma * (A_t - theta);
            const baseHazard = hAI / (1.0 + Math.exp(logisticArg));

            const userMult = getUserMultiplier();
            const hazard = baseHazard * userMult;

            // Diagnostic logging at t=0 for debugging
            if (tYears === 0 && currentParams.taskBucketMode === 'custom') {
                console.log('[Hazard Debug] t=0 with custom buckets:');
                console.log(`  A_job(0) = ${A_t.toFixed(3)}`);
                console.log(`  theta = ${theta.toFixed(3)}`);
                console.log(`  gamma = ${gamma.toFixed(1)}`);
                console.log(`  baseHazard = ${baseHazard.toFixed(3)} (before multiplier)`);
                console.log(`  userMult = ${userMult.toFixed(3)} (ampMult=${currentParams.ampMult.toFixed(2)} × fricMult=${currentParams.fricMult.toFixed(2)})`);
                console.log(`  final hazard = ${hazard.toFixed(3)}`);
            }

            return Math.min(0.95, hazard);
        }

        // Workforce Compression Hazard - job loss via task reallocation to amplified seniors
        // This hazard activates EARLIER than full automation (lower threshold)
        // Only affects GREEN curve (actual job loss), not BLUE curve (technical feasibility)
        function compressionHazard(tYears) {
            if (!currentParams) return 0;

            const seniorityLevel = currentParams.seniority || 1;

            // Protection handled by hierarchy vulnerability scaling (Level 4→0.4, Level 5→0.2)

            const answers = currentParams.answers || {};

            // Helper function to normalize answers
            const norm = (val) => {
                if (typeof val !== 'number') return 0.5;
                return (val - 1) / 4;  // 1→0, 3→0.5, 5→1
            };

            // 1. Task Reallocation Feasibility Score
            // Higher score = easier for others to absorb your work
            const q10 = answers.Q10 || 3;  // New reallocation question
            const q5 = answers.Q5 || 3;    // Decomposability
            const q6 = answers.Q6 || 3;    // Standardization
            const q7 = answers.Q7 || 3;    // Context dependency
            const q9 = answers.Q9 || 3;    // Tacit knowledge
            const q12 = answers.Q12 || 3;  // Physical presence

            const reallocationScore = (
                norm(q10) * 0.50 +           // Direct reallocation feasibility (increased weight)
                norm(q5) * 0.18 +            // Decomposable = easier to split
                norm(q6) * 0.12 +            // Standardized = others can pick up
                (1 - norm(q7)) * 0.08 +      // Low context = portable
                (1 - norm(q9)) * 0.10 +      // Low tacit = teachable
                (1 - norm(q12)) * 0.02       // Low physical presence = easier remote reallocation
            );

            // 2. Senior Productivity Amplification (only for AI-learnable digital work)
            const q1 = answers.Q1 || 3;    // Current AI performance
            const q4 = answers.Q4 || 3;    // Task digitization
            // q5, q6, q7, q9 already declared above for reallocation score

            const A_current = A_job(tYears); // Current task readiness

            // Raw digitization (digital deliverables)
            const rawDigitalFraction = norm(q4);

            // Learnability discount: factors that make digital work less AI-trainable
            // High context, high tacit knowledge, low decomposability, and low standardization
            // all reduce how much AI can learn from observing the digital work
            const contextPenalty = norm(q7);           // High context = work requires understanding not in the data
            const tacitPenalty = norm(q9);             // High tacit = work requires experience not codifiable
            const variabilityPenalty = 1 - norm(q5);   // Low decomposability = work is integrated/holistic
            const customizationPenalty = 1 - norm(q6); // Low standardization = each instance is unique

            const learnabilityDiscount = 1 - (
                0.35 * contextPenalty +
                0.30 * tacitPenalty +
                0.20 * variabilityPenalty +
                0.15 * customizationPenalty
            );

            // Effective digital fraction: only digital work that AI can actually learn from
            const effectiveDigitalFraction = rawDigitalFraction * Math.max(0.1, learnabilityDiscount);

            const aiCapability = norm(q1) * A_current;

            // Amplification ranges from 0 to 2.0 (can double senior productivity)
            // But only applies to work that is both digital AND AI-learnable
            const amplificationBoost = effectiveDigitalFraction * aiCapability * 2.0;

            // 3. Compression Readiness (hybrid: 70% immediate + 30% time-dependent)
            // This gives Q10 immediate effect while preserving growth as AI improves
            const compressionReadiness = reallocationScore * (0.7 + 0.3 * (1.0 + amplificationBoost));

            // 4. Compression Hazard Gate (lower threshold than automation)
            const h_max_compression = 0.40;  // Equal to automation's 0.40 - AI-driven compression is equally serious
            const gamma_compression = 6.0;   // Gentler slope than automation's 8.0
            const theta_compression = 0.35;  // Lower threshold than automation's ~0.50

            const logisticArg = -gamma_compression * (compressionReadiness - theta_compression);
            const baseCompressionHazard = h_max_compression / (1.0 + Math.exp(logisticArg));

            // 5. Scale by Hierarchy Vulnerability
            // Level 1 = 1.0 (fully vulnerable), Level 5 = 0.2 (protected)
            const hierarchyVuln = (6 - seniorityLevel) / 5;

            const finalCompressionHazard = baseCompressionHazard * hierarchyVuln;

            // Diagnostic logging at t=0
            if (tYears === 0 && compressionReadiness > 0.2) {
                console.log('[Compression Debug] t=0:');
                console.log(`  reallocationScore = ${reallocationScore.toFixed(3)}`);
                console.log(`  rawDigital = ${rawDigitalFraction.toFixed(2)}, learnabilityDiscount = ${learnabilityDiscount.toFixed(2)}`);
                console.log(`  effectiveDigital = ${effectiveDigitalFraction.toFixed(2)} (AI-learnable fraction)`);
                console.log(`  amplificationBoost = ${amplificationBoost.toFixed(3)} (AI capability=${aiCapability.toFixed(2)})`);
                console.log(`  compressionReadiness = ${compressionReadiness.toFixed(3)}`);
                console.log(`  hierarchyVuln = ${hierarchyVuln.toFixed(2)} (level ${seniorityLevel})`);
                console.log(`  compression hazard = ${finalCompressionHazard.toFixed(3)}/year`);
            }

            return finalCompressionHazard;
        }

        // Cumulative risk from hazard series using survival function
        function cumulativeRiskFromHazard(hSeries, dtYears) {
            let cum = 0;
            return hSeries.map(h => {
                cum += h * dtYears;
                return 1 - Math.exp(-cum);
            });
        }

        // Calibration tests - run these to verify question weights have expected impact
        function runCalibrationTests() {
            const tests = [];

            // Helper to compute risk by 2030 (t=5.35 years from 2024.65)
            const computeRisk2030 = (answers) => {
                const { ampMult, fricMult } = computeHazardMultipliers(answers);
                const mismatch = computeDomainMismatch(answers);
                const savedParams = currentParams;
                currentParams = {
                    h0: 0.015,
                    theta: 0.50,
                    gamma: 1.2,
                    kappa: 0.3,
                    friction: 3.0,
                    seniority: 1,
                    s_e: inferredExplicitness(answers),
                    lambda: inferredFrictionDecay(answers),
                    domainPace: inferredPace(answers),
                    ampMult: ampMult,
                    fricMult: fricMult,
                    domainPenalty: mismatch.penalty,
                    domainAlignment: mismatch.alignment
                };
                const risk = calculateDisplacementProbability(5.35);
                currentParams = savedParams;
                return risk;
            };

            // Neutral baseline: all answers = 3
            const neutralAnswers = {};
            for (let i = 1; i <= 19; i++) neutralAnswers[`Q${i}`] = 3;

            // Test 1: Q1 min->max should increase Risk by 2030 by ≥ +12 percentage points
            const q1MinAnswers = { ...neutralAnswers, Q1: 1 };
            const q1MaxAnswers = { ...neutralAnswers, Q1: 5 };
            const riskQ1Min = computeRisk2030(q1MinAnswers);
            const riskQ1Max = computeRisk2030(q1MaxAnswers);
            const q1Delta = (riskQ1Max - riskQ1Min) * 100;
            tests.push({
                name: 'Q1 min->max increases Risk by 2030 by ≥12pp',
                pass: q1Delta >= 12,
                actual: q1Delta.toFixed(1) + 'pp',
                expected: '≥12pp'
            });

            // Test 2: Q1+Q4+Q6 max yields ≥2.5× hazard vs neutral
            const maxRiskAnswers = { ...neutralAnswers, Q1: 5, Q4: 5, Q6: 5 };
            const { ampMult: neutralAmpMult, fricMult: neutralFricMult } = computeHazardMultipliers(neutralAnswers);
            const { ampMult: maxAmpMult, fricMult: maxFricMult } = computeHazardMultipliers(maxRiskAnswers);
            const neutralMult = neutralAmpMult * neutralFricMult;
            const maxMult = maxAmpMult * maxFricMult;
            const multRatio = maxMult / neutralMult;
            tests.push({
                name: 'Q1+Q4+Q6 max yields ≥2.5× hazard vs neutral',
                pass: multRatio >= 2.5,
                actual: multRatio.toFixed(2) + '×',
                expected: '≥2.5×'
            });

            // Test 3: Protective stack (Q5+Q7+Q8+Q15 high) suppresses hazard by ≥50%
            const protectiveAnswers = { ...neutralAnswers, Q5: 5, Q7: 5, Q8: 5, Q15: 5 };
            const { ampMult: protAmpMult, fricMult: protFricMult } = computeHazardMultipliers(protectiveAnswers);
            const protMult = protAmpMult * protFricMult;
            const suppression = (1 - protMult / neutralMult) * 100;
            tests.push({
                name: 'Protective stack suppresses hazard by ≥50%',
                pass: suppression >= 50,
                actual: suppression.toFixed(1) + '%',
                expected: '≥50%'
            });

            // Log results to console
            console.log('=== CALIBRATION TEST RESULTS ===');
            tests.forEach(t => {
                const status = t.pass ? '✓ PASS' : '✗ FAIL';
                console.log(`${status} - ${t.name}`);
                console.log(`  Expected: ${t.expected}, Actual: ${t.actual}`);
            });
            const allPassed = tests.every(t => t.pass);
            console.log(`\nOverall: ${allPassed ? '✓ ALL TESTS PASSED' : '✗ SOME TESTS FAILED'}`);

            return tests;
        }

        // BLUE CURVE: Technical feasibility only (pure AI automation hazard)
        function calculateDisplacementProbability(t) {
            const n = 100;
            const dt = t / n;
            let integral = 0;

            for (let i = 0; i <= n; i++) {
                const s = i * dt;
                const rate = hazardAI(s);

                if (i === 0 || i === n) {
                    integral += rate;
                } else if (i % 2 === 1) {
                    integral += 4 * rate;
                } else {
                    integral += 2 * rate;
                }
            }

            integral = integral * dt / 3;
            return 1 - Math.exp(-integral);
        }

        // GREEN CURVE: Actual job loss (automation + compression)
        function calculateActualJobLossProbability(t) {
            const n = 100;
            const dt = t / n;
            let integral = 0;

            for (let i = 0; i <= n; i++) {
                const s = i * dt;
                const automationRate = hazardAI(s);
                const compressionRate = compressionHazard(s);

                // Combined hazard (capped at 0.60/year)
                const totalRate = Math.min(automationRate + compressionRate, 0.60);

                if (i === 0 || i === n) {
                    integral += totalRate;
                } else if (i % 2 === 1) {
                    integral += 4 * totalRate;
                } else {
                    integral += 2 * totalRate;
                }
            }

            integral = integral * dt / 3;
            return 1 - Math.exp(-integral);
        }

        function updateChart() {
            if (!currentParams || !chart) return;

            const years = [];
            const technicalFeasibility = [];
            const actualJobLoss = [];
            const maxYears = 20;
            const delay = currentParams.implementationDelay || 0;

            for (let t = 0; t <= maxYears; t += 0.25) {
                years.push(t);
                // Blue curve: Technical feasibility - Risk_tech(t) = 1 - exp(-∫ lambdaAI(u) du)
                technicalFeasibility.push(calculateDisplacementProbability(t));

                // Green curve: Actual job loss with dynamic friction decay + compression hazard
                // Implementation delay decreases exponentially as capability grows: delay(t) = delay_0 * exp(-lambda * t)
                // This models how organizational barriers diminish as AI capability increases
                // PLUS workforce compression hazard (task reallocation to AI-amplified seniors)
                const lambda = currentParams.lambda || 0.02;
                const dynamicDelay = delay * Math.exp(-lambda * t);
                const effectiveTime = Math.max(t - dynamicDelay, 0);
                actualJobLoss.push(effectiveTime > 0 ? calculateActualJobLossProbability(effectiveTime) : 0);
            }

            chart.data.labels = years;
            chart.data.datasets[0].data = technicalFeasibility;
            chart.data.datasets[1].data = actualJobLoss;
            chart.update();
            updateResults();

            // Debug: Log key metrics
            console.log('[METR] Blue curve at t=5:', technicalFeasibility[20].toFixed(3));  // t=5 is index 20 (0.25 step)
            console.log('[METR] Green curve at t=5:', actualJobLoss[20].toFixed(3));
            console.log('[METR] Implementation delay:', delay.toFixed(2), 'years');
        }

        function findYearForProbability(targetProb) {
            let low = 0;
            let high = 50;
            let mid;

            while (high - low > 0.1) {
                mid = (low + high) / 2;
                const prob = calculateDisplacementProbability(mid);

                if (prob < targetProb) {
                    low = mid;
                } else {
                    high = mid;
                }
            }

            return mid;
        }

        function findYearForProbabilityWithDynamicDelay(targetProb, delay, lambda) {
            let low = 0;
            let high = 50;
            let mid;

            while (high - low > 0.1) {
                mid = (low + high) / 2;
                // Calculate probability with dynamic delay + compression: delay(t) = delay_0 * exp(-lambda * t)
                const dynamicDelay = delay * Math.exp(-lambda * mid);
                const effectiveTime = Math.max(mid - dynamicDelay, 0);
                const prob = effectiveTime > 0 ? calculateActualJobLossProbability(effectiveTime) : 0;

                if (prob < targetProb) {
                    low = mid;
                } else {
                    high = mid;
                }
            }

            return mid;
        }

        function describeExplicitness(se) {
            if (typeof se !== 'number') return '-';
            let note;
            if (se >= 0.7) {
                note = 'heavy explicit work pulls timelines forward.';
            } else if (se <= 0.35) {
                note = 'tacit-heavy mix slows capability transfer.';
            } else {
                note = 'mixed tasks keep the acceleration moderate.';
            }
            return `${se.toFixed(2)} - ${note}`;
        }

        function describeTheta(theta, seniority) {
            if (typeof theta !== 'number') return '-';
            const profiles = SENIORITY_PROFILES;
            const idx = Math.max(0, Math.min(profiles.length - 1, (seniority || 1) - 1));
            const profile = profiles[idx] || { label: 'Entry', thetaLift: 0 };
            const baseTheta = THETA_BASE_ENTRY + (profile.thetaLift || 0);
            const pct = theta * 100;
            const basePct = baseTheta * 100;
            const delta = pct - basePct;
            let note;
            if (delta > 3) {
                note = `${profile.label} coverage lifts by ~${delta.toFixed(1)} pts due to tacit or compliance load.`;
            } else if (delta < -3) {
                note = `${profile.label} coverage drops by ~${Math.abs(delta).toFixed(1)} pts thanks to explicit digital tasks.`;
            } else {
                note = `${profile.label} coverage bar is close to the baseline expectations.`;
            }
            return `${pct.toFixed(1)}% - ${note}`;
        }


        function describePace(pace) {
            if (typeof pace !== 'number' || !Number.isFinite(pace)) return '-';
            const multiplier = pace.toFixed(2);
            if (pace > 1.05) {
                return `~${multiplier}x METR doubling time - slower capability transfer.`;
            }
            if (pace < 0.95) {
                return `~${multiplier}x METR doubling time - faster than the trend.`;
            }
            return `~${multiplier}x METR doubling time - close to baseline.`;
        }

        function describeFriction(lambda) {
            if (typeof lambda !== 'number') return '-';
            let band;
            if (lambda >= 0.035) {
                band = 'fast rollout';
            } else if (lambda <= 0.015) {
                band = 'slow rollout';
            } else {
                band = 'medium rollout';
            }
            return `lambda = ${lambda.toFixed(3)} - ${band} damping.`;
        }

        function describeAlignment(alignment, penalty) {
            if (typeof alignment !== 'number' || typeof penalty !== 'number' || !Number.isFinite(penalty)) {
                return '-';
            }
            const alignmentPct = alignment * 100;
            let note;
            if (alignment >= 0.7) {
                note = 'close to METR software tasks.';
            } else if (alignment >= 0.4) {
                note = 'mixed workflows; slower transfer from METR.';
            } else {
                note = 'tacit/physical heavy; METR trend damped.';
            }
            return `${alignmentPct.toFixed(0)}% aligned, horizon penalty ${penalty.toFixed(2)}x - ${note}`;
        }

        function updateResults() {
            const delay = currentParams.implementationDelay || 0;
            const lambda = currentParams.lambda || 0.02;

            // Technical feasibility timeline
            const medianTech = findYearForProbability(0.5);
            const highTech = findYearForProbability(0.9);

            // Actual job loss timeline with dynamic friction decay
            const medianActual = findYearForProbabilityWithDynamicDelay(0.5, delay, lambda);
            const highActual = findYearForProbabilityWithDynamicDelay(0.9, delay, lambda);

            // Calculate years from now to 2030 and 2031 with dynamic delay
            const currentYear = getCurrentYearDecimal();
            const yearsTo2030 = 2030.0 - currentYear;
            const yearsTo2031 = 2031.0 - currentYear;
            const dynamicDelay2030 = delay * Math.exp(-lambda * yearsTo2030);
            const dynamicDelay2031 = delay * Math.exp(-lambda * yearsTo2031);
            const effectiveTime2030 = Math.max(yearsTo2030 - dynamicDelay2030, 0);
            const effectiveTime2031 = Math.max(yearsTo2031 - dynamicDelay2031, 0);
            const risk2030 = yearsTo2030 > 0 && effectiveTime2030 > 0 ? calculateActualJobLossProbability(effectiveTime2030) : (yearsTo2030 <= 0 ? 1.0 : 0);
            const risk2031 = yearsTo2031 > 0 && effectiveTime2031 > 0 ? calculateActualJobLossProbability(effectiveTime2031) : (yearsTo2031 <= 0 ? 1.0 : 0);

            document.getElementById('median-year').textContent =
                medianActual < 50 ? `${medianActual.toFixed(1)} years` : 'Beyond 2050';
            document.getElementById('high-year').textContent =
                highActual < 50 ? `${highActual.toFixed(1)} years` : 'Beyond 2050';
            document.getElementById('risk-2030').textContent =
                `${(Math.max(0, risk2030) * 100).toFixed(1)}%`;
            document.getElementById('risk-2031').textContent =
                `${(Math.max(0, risk2031) * 100).toFixed(1)}%`;

            // Re-employment likelihood (calculated here with medianTech timing)
            const reemployProb = calculateReemploymentProbability(
                currentParams.answers,
                currentParams.seniority,
                medianTech
            );
            const reemployPct = (reemployProb * 100).toFixed(0);
            let reemployLabel = 'Moderate';
            if (reemployProb >= 0.7) reemployLabel = 'Good';
            else if (reemployProb >= 0.5) reemployLabel = 'Moderate';
            else if (reemployProb >= 0.3) reemployLabel = 'Low';
            else reemployLabel = 'Very Low';
            document.getElementById('reemployment-value').textContent =
                `${reemployLabel} (${reemployPct}%)`;

            document.getElementById('insight-explicitness').textContent = describeExplicitness(currentParams.s_e);
            document.getElementById('insight-theta').textContent = describeTheta(currentParams.theta, currentParams.seniority);
            document.getElementById('insight-friction').textContent = describeFriction(currentParams.lambda);
            document.getElementById('insight-alignment').textContent =
                describeAlignment(currentParams.domainAlignment, currentParams.domainPenalty);

            // Update personal timeline table
            updatePersonalTimeline();
        }

        if (false) document.getElementById('ai-doubling')?.addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('ai-doubling-value').textContent = value + ' mo';
            console.log('[Slider] AI Doubling:', value, 'months → expect', value < 7 ? 'FASTER' : 'SLOWER', 'automation');
            updateChart();
        });

        document.getElementById('industry-pace')?.addEventListener('input', function() {
            const frictionValue = parseFloat(this.value);
            document.getElementById('industry-pace-value').textContent = frictionValue.toFixed(1) + 'x';
            console.log('[Slider] Industry Friction:', frictionValue.toFixed(1) + 'x',
                       '→ expect', frictionValue > 1.0 ? 'SLOWER' : 'FASTER', 'automation');
            updateChart();
        });

        document.getElementById('ai-reliability')?.addEventListener('input', function() {
            const reliabilityValue = parseInt(this.value);
            document.getElementById('ai-reliability-value').textContent = reliabilityValue + '%';
            console.log('[Slider] AI Reliability:', reliabilityValue + '%',
                       '→ expect', reliabilityValue > 95 ? 'SLOWER' : 'FASTER', 'automation');
            updateChart();
        });

        // Task bucket editor logic
        function getBaseTaskWeights() {
            const userBase = (currentParams && Array.isArray(currentParams.userBaseWeights)) ? currentParams.userBaseWeights : null;
            if (userBase && userBase.length === METR_DEFAULTS.taskBuckets.length) return userBase;
            return METR_DEFAULTS.taskBuckets.map(b => b.w);
        }

        function initTaskBucketEditor() {
            const panel = document.getElementById('task-bucket-editor');
            const btn = document.getElementById('edit-task-buckets');
            if (!panel || !btn) return;

            const ids = ['tb-bucket-0','tb-bucket-1','tb-bucket-2','tb-bucket-3','tb-bucket-4'];
            const inputs = ids.map(id => document.getElementById(id)).filter(Boolean);
            const sumEl = document.getElementById('tb-sum');
            const applyBtn = document.getElementById('tb-apply');
            const autoChk = document.getElementById('tb-auto');

            // Prefill from current base weights
            const toPct = (x) => Math.max(0, Math.min(100, Math.round(x * 100)));
            function setInputsFromArray(arr){ inputs.forEach((inp, i) => { inp.value = toPct(arr[i] || 0); }); }

            function updateSum() {
                const total = inputs.reduce((s, inp) => s + (parseFloat(inp.value) || 0), 0);
                if (sumEl) sumEl.textContent = `Sum: ${Math.round(total)}%`;
                return total;
            }

            inputs.forEach(inp => inp.addEventListener('input', updateSum));

            btn.onclick = () => {
                panel.classList.toggle('expanded');
                refreshTaskBucketEditor();
            };

            applyBtn && (applyBtn.onclick = () => {
                let raw = inputs.map(inp => Math.max(0, parseFloat(inp.value) || 0));
                const total = raw.reduce((a,b)=>a+b,0);
                if (total <= 0) {
                    console.warn('[TaskBuckets] Sum is zero; ignoring apply');
                    return;
                }
                const normalized = raw.map(v => v / total);
                if (!currentParams) return;
                currentParams.userBaseWeights = normalized;
                console.log('[TaskBuckets] Applied user base weights:', normalized.map(v=>v.toFixed(3)));
                updateChart();
            });

            function refreshTaskBucketEditor(){
                if (!currentParams) return;
                const mode = currentParams.taskBucketMode === 'custom' ? 'custom' : 'auto';
                if (autoChk) autoChk.checked = (mode === 'auto');
                const disable = (mode === 'auto');
                inputs.forEach(inp => inp.disabled = disable);
                applyBtn && (applyBtn.disabled = disable);

                const seniorityLevel = (currentParams && currentParams.seniority) || 1;
                const answers = (currentParams && currentParams.answers) || null;

                if (mode === 'auto') {
                    // In auto mode, always show the current model-computed weights
                    const effectiveWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                    setInputsFromArray(effectiveWeights);
                    updateSum();
                } else {
                    // In custom mode, show user's custom weights if they exist
                    // Otherwise show model-computed weights as starting point
                    if (currentParams.userBaseWeights && currentParams.userBaseWeights.length === METR_DEFAULTS.taskBuckets.length) {
                        setInputsFromArray(currentParams.userBaseWeights);
                    } else {
                        const modelWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                        setInputsFromArray(modelWeights);
                    }
                    updateSum();
                }
            }

            autoChk && (autoChk.onchange = () => {
                if (!currentParams) return;
                const wasAuto = (currentParams.taskBucketMode !== 'custom');
                currentParams.taskBucketMode = autoChk.checked ? 'auto' : 'custom';

                // If switching FROM custom TO auto, reset to model values and update chart
                if (!wasAuto && autoChk.checked) {
                    const seniorityLevel = (currentParams && currentParams.seniority) || 1;
                    const answers = (currentParams && currentParams.answers) || null;
                    const modelWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                    // Clear user overrides and recalculate from model
                    currentParams.userBaseWeights = null;
                    setInputsFromArray(modelWeights);
                    updateSum();
                    console.log('[TaskBuckets] Switched to auto mode, reset to model weights:', modelWeights.map(v=>v.toFixed(3)));
                    updateChart();
                }

                // If switching FROM auto TO custom, populate with current model-computed values
                // This gives users the current model calculation as their starting point for editing
                if (wasAuto && !autoChk.checked) {
                    const seniorityLevel = (currentParams && currentParams.seniority) || 1;
                    const answers = (currentParams && currentParams.answers) || null;
                    const modelWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                    // Don't set userBaseWeights yet - let them click Apply to commit
                    setInputsFromArray(modelWeights);
                    updateSum();
                }

                refreshTaskBucketEditor();
            });

            refreshTaskBucketEditor();
        }

        // Auto-initialize: load benchmark data, then select custom role and trigger analysis on page load
        window.addEventListener('DOMContentLoaded', async function() {
            // Load benchmark data first
            await loadBenchmarkData();

            const currentYear = getCurrentYearDecimal();
            console.log(`[System] Current date: ${new Date().toISOString().split('T')[0]} (${currentYear.toFixed(2)})`);
            console.log(`[System] Years since baseline: ${(currentYear - BASELINE_YEAR_DECIMAL).toFixed(2)}`);
            console.log(`[System] Years to 2030: ${(2030.0 - currentYear).toFixed(2)}`);

            const customBtn = document.querySelector('.preset-btn[data-role="custom"]');
            if (customBtn) {
                customBtn.click();
            }

            // Run tests after initial analysis completes
            setTimeout(() => {
                runMETRAcceptanceTests();
                runRegressionTests();
                runPatchRegressionTests();
                runFeatureImplementationTests();
                runCalibrationTests();
                initTaskBucketEditor();
            }, 500);
        });
    </script>
    <script src="navigation.js"></script>
</body>
</html>
