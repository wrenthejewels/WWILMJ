<!DOCTYPE html>
<html lang="en">
    <!-- TEMP: wrap test -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Bebas+Neue&display=swap" rel="stylesheet">
    <title>Don't Lose Your Job</title>
    <style>
        :root {
            /* Warm neutral palette */
            --bg-page: #FAF8F5;
            --bg-card: #FFFFFF;
            --bg-subtle: #F5F2EE;
            --bg-hover: #F0EDE8;

            /* Text hierarchy */
            --text-primary: #1A1917;
            --text-secondary: #5C5850;
            --text-tertiary: #8A8578;

            /* Accent - blue to match page theme */
            --accent: #2a5298;
            --accent-hover: #1e3c72;
            --accent-subtle: rgba(42, 82, 152, 0.08);

            /* Borders */
            --border-light: #E8E4DE;
            --border-medium: #D9D4CC;

            /* Spacing scale */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;
            --space-6: 32px;
            --space-7: 48px;
            --space-8: 64px;

            /* Typography scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 2rem;

            /* Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Prevent horizontal overflow on mobile */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        .setup-wizard {
            background: #ffffff;
            padding: 0;
            border-radius: 0;
            margin-bottom: 0;
            margin-top: 0;
        }

        .backend-controls {
            display: none;
        }
        
        .setup-section {
            margin-bottom: 30px;
        }
        
        .setup-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        /* Category styles - collapsible sections from index-test-3 */
        .category {
            border-bottom: 1px solid var(--border-light);
            padding-bottom: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .category:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) 0;
            cursor: pointer;
            user-select: none;
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-count {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-tertiary);
            background: var(--bg-subtle);
            padding: 2px 8px;
            border-radius: var(--radius-full);
        }

        .category-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            transition: transform 0.1s ease;
        }

        .category-toggle.open {
            transform: rotate(180deg);
        }

        .category-content {
            padding-top: var(--space-4);
        }

        .category-content.hidden {
            display: none;
        }

        /* Legacy section-category kept for compatibility */
        .section-category {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }

        .section-category h4 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: var(--text-lg);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-category h4:hover {
            color: var(--accent-hover);
        }

        .expand-icon {
            font-size: 0.9em;
            transition: transform 0.15s;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 16px;
        }

        @media (max-width: 1000px) and (min-width: 769px) {
            .question-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) and (min-width: 361px) {
            .question-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 360px) {
            .question-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        .additional-questions {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.15s ease-out;
        }

        .additional-questions.expanded {
            max-height: 2000px;
        }

        .model-tuning-panel {
            margin-top: 8px;
            padding: 0;
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            background: var(--bg-subtle);
            opacity: 0;
            pointer-events: none;
            transition: max-height 0.15s ease-out, opacity 0.1s ease-out, padding 0.1s ease-out, border-color 0.1s ease-out;
        }

        .model-tuning-panel.expanded {
            max-height: 5000px;
            padding: 16px;
            border-color: #e5e7eb;
            opacity: 1;
            pointer-events: auto;
        }

        .tuning-note {
            font-size: 0.9em;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .tuning-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tuning-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px;
        }

        .tuning-grid,
        .tuning-card,
        .tuning-field,
        .tuning-field > div {
            min-width: 0;
            box-sizing: border-box;
        }

        .tuning-split-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 6px;
        }

        .tuning-split-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
        }

        .tuning-split-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
        }

        .tuning-subgrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .tuning-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .tuning-card h5 {
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #111827;
        }

        .tuning-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .tuning-field label {
            font-size: 0.85em;
            color: #475569;
        }

        .tuning-field input {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .tuning-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tuning-table th,
        .tuning-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.85em;
            text-align: left;
        }

        .tuning-table input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .tuning-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .tuning-toggle {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.9em;
            color: #1f2937;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 8px 10px;
            line-height: 1.35;
            min-height: 44px;
            min-width: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }

        .tuning-toggle input {
            margin-top: 2px;
        }
        
        .role-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.95em;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }
        
        
        
        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .preset-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }

        .tuning-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: #f8fafc;
            color: #1f2937;
            transition: background 0.12s ease, border-color 0.12s ease, color 0.12s ease;
        }

        .tuning-action-btn:hover {
            border-color: #cbd5e1;
            background: #eef2f7;
        }


        .tuning-preset-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.1s ease;
            min-height: 36px;
            line-height: 1.3;
        }

        .tuning-preset-btn:hover {
            border-color: var(--border-medium);
            color: var(--text-primary);
        }

        .tuning-preset-btn.active {
            background: var(--text-primary);
            border-color: var(--text-primary);
            color: var(--bg-card);
        }
        
        /* Question bubble styling from index-test-3 */
        .question, .question-group {
            padding: var(--space-4);
            background: var(--bg-subtle);   /* Light beige from index-test-3 */
            border-radius: var(--radius-md);
            margin-bottom: 0;              /* Spacing handled by grid gap */
        }

        .question-group h5 {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: var(--text-sm);
            font-weight: 500;
            line-height: 1.4;
        }

        .question-group p {
            font-family: 'Inter', sans-serif;
            color: var(--text-secondary);
            font-size: var(--text-sm);
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        /* Radio buttons styled like index-test-3 */
        .radio-group, .options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .radio-option, .option {
            flex: 1 1 auto;
            min-width: 60px;
        }

        .radio-option input[type="radio"], .option input {
            display: none;
        }

        .radio-option label, .option label {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-2) var(--space-3);
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.075s ease;
            text-align: center;
            min-height: 36px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .radio-option label:hover, .option label:hover {
            border-color: var(--border-medium);
            color: var(--text-primary);
        }

        .radio-option input[type="radio"]:checked + label, .option input:checked + label {
            background: var(--text-primary);
            border-color: var(--text-primary);
            color: var(--bg-card);
        }
        
        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.15s;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
        }
        
        .two-column-layout {
            display: block;
            margin-top: 0;
        }

        .left-column {
            min-width: 0;
            width: 100%;
        }

        .right-column {
            min-width: 0;
            width: 100%;
            position: static;
            align-self: start;
        }

        .legacy-wizard {
            margin-top: 0;
            padding-top: 0;
            margin-bottom: 32px;
        }
        
        .parameter-breakdown {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.05);
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .parameter-breakdown h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .profile-scores {
            display: flex;
            flex-direction: column;
        }

        .profile-timeline {
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 1em;
            margin-bottom: 12px;
            color: #1f1c18;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #e6e0d4;
        }

        .parameter-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .parameter-item:last-child {
            border-bottom: none;
        }
        
        .parameter-label {
            color: #666;
            font-size: 1em;
        }

        .parameter-value {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }
        
        .timeline-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .timeline-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .timeline-card h4 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Minimal top-step flow */
        .progression {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 28px;
        }

        .step-card {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 18px;
            padding: 22px 24px;
            box-shadow: 0 18px 48px rgba(15, 23, 42, 0.08);
            position: relative;
            overflow: hidden;
        }

        .progress-track {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .track-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #d7cfbf;
            transition: background 0.1s ease, transform 0.1s ease;
        }

        .track-dot.active {
            background: #2a5298;
            transform: scale(1.15);
        }

        .step-inline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            align-items: stretch;
            justify-items: stretch;
        }

        .step-block {
            background: #fffaf2;
            border: 1px solid #e6e0d4;
            border-radius: 14px;
            padding: 14px 16px 16px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }

        .step-heading {
            font-weight: 700;
            color: #2a5298;
            margin: 0;
            font-size: 1.2rem;
            letter-spacing: -0.01em;
            padding-bottom: 6px;
        }

        .step-inline select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.02rem;
            box-shadow: 0 10px 24px rgba(42, 82, 152, 0.08);
            transition: box-shadow 0.1s ease, border-color 0.1s ease;
        }

        .step-inline select:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 12px 30px rgba(42, 82, 152, 0.14);
        }

        .step-desc {
            color: #5c564f;
            font-size: 0.95rem;
            line-height: 1.45;
            margin: 0;
        }

        .step-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .step-actions .header-btn {
            padding: 10px 14px;
            font-size: 1.05rem;
            width: auto;
            justify-content: center;
            align-self: flex-start;
        }

        .hidden-block {
            display: none !important;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .explainer-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin: 18px 0 10px;
        }

        /* Hide old explainer bubbles - using footer nav instead */
        .explainer-row {
            display: none !important;
        }

        .explainer-bubble {
            display: none;
        }

        /* Minimal footer navigation */
        .minimal-footer {
            text-align: center;
            padding: 24px 0 48px;
        }

        .footer-link {
            color: #2a5298;
            text-decoration: none;
            font-size: 1.0rem;
            font-weight: 500;
            transition: color 0.1s ease;
        }

        .footer-link:hover {
            color: #1a3f78;
            text-decoration: underline;
        }

        .footer-divider {
            margin: 0 16px;
            color: #1f1c18;
        }

        .explainer-eyebrow {
            font-size: 0.95rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 6px;
            font-weight: 700;
        }

        .explainer-bubble p {
            color: #3f392f;
            margin-bottom: 10px;
        }

        .explainer-btn {
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .timeline-event {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 8px;
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            flex: 0 0 auto;
        }
        
        .timeline-date {
            font-weight: 600;
            color: #2a5298;
            margin-right: 10px;
            min-width: 65px;
            font-size: 0.9em;
        }

        .timeline-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin: 8px 0 20px;
        }
        
        .control-group {
            background: var(--bg-card);
            padding: var(--space-5);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }
        
        .control-group h3 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .control-group p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2a5298;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #2a5298;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .value-display {
            min-width: 60px;
            text-align: right;
            font-weight: bold;
            color: #333;
        }
        
        /* Chart container styles moved to main section below */

        canvas {
            max-width: 100%;
            display: block;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }

        /* Let re-employment bubble fill the leftover horizontal slot */
        #reemployment-card {
            grid-column: span 2;
        }
        
        .result-card.critical {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .result-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: bold;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 18px;
            align-items: start;
            margin-bottom: 8px;
        }

        .section-title--with-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .header-btn--compact {
            padding: 8px 16px;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        .task-bucket-editor {
            margin-top: 10px;
        }

        .task-bucket-panel {
            background: var(--bg-subtle);
            border: 1px solid #e5e7eb;
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .task-bucket-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .task-bucket-description {
            margin: 0;
            color: #4b5563;
            font-size: 0.9rem;
        }

        .task-bucket-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #4b5563;
            font-size: 0.9rem;
        }

        .task-bucket-toggle input {
            accent-color: #2a5298;
        }

        .task-bucket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .task-bucket-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .task-bucket-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-bucket-input {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fff;
            color: var(--text-primary);
        }

        .task-bucket-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
        }

        .task-bucket-sum {
            color: #4b5563;
            font-size: 0.9rem;
        }

        .task-bucket-actions {
            display: flex;
            gap: 8px;
        }

        .model-insights {
            margin-top: 20px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px 20px;
            line-height: 1.4;
        }

        .model-insights p {
            margin: 4px 0;
            color: #495057;
            font-size: 0.95em;
        }

        .progress-indicator {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            transition: width 0.15s;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .content-wrapper {
                width: 100%;
                padding: 24px 0;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .two-column-layout {
                gap: 24px;
            }

            .model-explanation {
                padding: 15px !important;
            }

            .model-explanation h3 {
                font-size: 1.1em;
            }

            .ai-equation-display {
                padding: 15px !important;
                font-size: 0.9em;
            }

            .ai-equation-display h3 {
                font-size: 1em;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 12px;
            }

            .subtitle {
                font-size: 1.1em;
                margin-bottom: 0;
            }
            .setup-wizard {
                padding: 15px;
            }

            .setup-section h3 {
                font-size: 1em;
            }

            .role-presets {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }

            .preset-btn {
                padding: 10px 12px;
                font-size: 0.85em;
            }

            .section-category {
                padding: 12px;
                margin-bottom: 16px;
            }

            .section-category h4 {
                font-size: 1em;
                margin-bottom: 12px;
            }

            .question-group {
                padding: 10px;
                margin-bottom: 10px;
            }

            .question-group h5 {
                font-size: 0.85em;
                margin-bottom: 5px;
                line-height: 1.3;
            }

            .question-group p {
                font-size: 0.75em;
                margin-bottom: 7px;
                line-height: 1.4;
            }

            .radio-group {
                flex-direction: column;
                gap: 6px;
            }

            .radio-option {
                min-width: auto;
            }

            .radio-option label {
                padding: 8px;
                font-size: 0.78em;
            }

            .timeline-comparison {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .timeline-card {
                padding: 15px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .control-group {
                padding: 15px;
            }

            .control-group h3 {
                font-size: 1em;
            }

            .control-group p {
                font-size: 0.85em;
            }

            .chart-container {
                padding: 12px;
            }

            .chart-container canvas {
                min-height: 250px;
                max-height: 280px;
            }

            canvas {
                width: 100% !important;
                display: block;
            }

            .results {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }

            .result-card {
                padding: 15px;
            }

            .result-card h4 {
                font-size: 0.8em;
            }

            .result-value {
                font-size: 1.5em;
            }

            .analyze-btn {
                padding: 12px;
                font-size: 1em;
            }

            .parameter-breakdown {
                padding: 15px;
            }

            .parameter-breakdown h3 {
                font-size: 1em;
            }

            .profile-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .parameter-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .parameter-label,
            .parameter-value {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.3em;
            }

            .role-presets {
                grid-template-columns: 1fr;
            }

            .results {
                grid-template-columns: 1fr;
            }

            .slider-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .value-display {
                text-align: left;
            }
        }

        /* Clean minimal design */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FAF8F5;
            color: #1A1917;
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px 120px;
            background: transparent;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 18px 96px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 14px 64px;
            }
        }

        /* Hero - from index-test-3 */
        .hero, .hero-section, .article-hero {
            text-align: center;
            padding: 62px 0 32px;
            max-width: 720px;
            margin: 0 auto 48px;
            background: transparent;
            border-bottom: 1px solid #e6e0d4;
        }

        .hero h1, .hero-section h1, .article-hero h1 {
            font-family: 'Inter', sans-serif;
            font-size: clamp(1.9rem, 3vw, 2.6rem);
            letter-spacing: -0.015em;
            font-weight: 600;
            margin-top: 18px;
        }

        .hero p, .hero-section p, .article-hero p {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 540px;
            margin: 6px auto 0;
            line-height: 1.55;
        }

        .lede {
            color: #5c564f;
            max-width: 48ch;
            margin-top: 12px;
            font-size: 0.98rem;
        }

        .meta-line {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 24px;
            font-size: 0.85rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #8c857d;
        }

        .subtitle {
            color: #5c564f;
            font-size: 1.15rem;
            margin-top: 16px;
            max-width: 32ch;
        }

        .content-wrapper {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        .narrow-content {
            width: 100%;
            margin: 0 auto;
        }

        p {
            margin-bottom: 1.2em;
            color: #3f392f;
        }

        h2,
        h3,
        h4 {
            font-family: 'Inter', sans-serif;
            color: #1f1c18;
            font-weight: 600;
        }

        /* Header - non-sticky version of index-test-3 */
        .site-header, .header {
            position: static;
            background: var(--bg-page);
            border-bottom: 1px solid var(--border-light);
            z-index: 100;
        }

        .centered-header {
            border-bottom: 1px solid var(--border-light);
            padding: 0;
        }

        .centered-header .header-inner {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            text-align: left;
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-4) var(--space-5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-5);
        }

        .brand, .header-brand {
            display: flex;
            align-items: center;
        }

        .centered-brand {
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .centered-header .header-brand {
            flex: 1;
            align-items: flex-start;
        }

        .brand-name, .publication-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            line-height: 1;
            padding: var(--space-3) 0;
        }

        .brand-tagline, .publication-tagline {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            letter-spacing: 0.03em;
        }

        .nav {
            display: flex;
            gap: var(--space-2);
        }

        .centered-header .nav {
            margin-left: auto;
        }

        .nav-link {
            padding: 14px 30px;
            font-size: 1.05rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: var(--radius-full);
            transition: all 0.075s ease;
            text-decoration: none;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-subtle);
        }

        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-card);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            text-decoration: underline;
        }

        /* Removed duplicate .header-brand - using unified style above */

        .header-actions {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-btn {
            background: #fdf8f0;
            color: #1f1c18;
            border: 1px solid #e6e0d4;
            border-radius: 6px;
            padding: 14px 32px;
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .header-btn:hover {
            background: #f5eee0;
            border-color: #d9d2c4;
            color: #000000;
        }

        .header-btn.active {
            background: #1f1c18;
            color: #ffffff;
            border-color: #1f1c18;
            box-shadow: 0 12px 28px rgba(31, 28, 24, 0.2);
        }

        .publication-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
            letter-spacing: 0.05em;
            font-weight: 400;
            text-transform: uppercase;
            color: #1A1917;
        }

        .author-name-header {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            letter-spacing: 0.01em;
            text-transform: none;
            font-style: italic;
            color: #8A8578;
            font-weight: 400;
        }

        /* Author social links */
        .author-social {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }

        .social-divider {
            color: #d9d2c4;
            font-size: 0.85rem;
        }

        .publication-tagline,
        .author-link {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 600;
            line-height: 1.1;
        }

        .publication-tagline {
            color: #5c564f;
        }

        .author-link {
            color: #6ba3d4;
            text-decoration: none;
            transition: color 0.15s;
        }

        .author-link:hover {
            color: #4a8bc2;
        }

        /* Centered header styling */
        .centered-header .header-inner {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            text-align: left;
        }

        .centered-brand {
            align-items: center;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: #5c564f;
            margin: 6px 0 0 0;
            font-weight: 400;
            letter-spacing: 0.02em;
        }

        /* Section dividers - very subtle */
        .section-divider {
            border: none;
            border-top: 1px solid #f0f0f0;
            margin: 48px auto;
            max-width: 900px;
        }

        /* Hide top divider for cleaner look */
        .section-divider:first-of-type {
            display: none;
        }

        .chart-divider {
            margin-top: 48px;
            margin-bottom: 48px;
        }

        .footer-divider {
            margin-top: 96px;
            margin-bottom: 48px;
        }

        /* Horizontal sequence layout */
        .horizontal-sequence {
            padding: 32px 0 18px;
            width: 100%;
            background: transparent;
            border: none;
            box-shadow: none;
            margin: 8px auto 24px;
        }

        .sequence-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: stretch;
        }

        /* Dropdown styling for plane items */
        .plane-dropdown {
            width: 100%;
            min-height: 64px;
            background: #f5f0e8;
            border: 2px solid #d4cdbf;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            color: #1f1c18;
            font-weight: 500;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%232a5298' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
        }

        .plane-dropdown:hover {
            border-color: #2a5298;
            background-color: #e8f0fe;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(42, 82, 152, 0.2);
        }

        .plane-dropdown:focus {
            outline: none;
            border-color: #2a5298;
            background-color: #e8f0fe;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .plane-dropdown.selected {
            border-color: #2a5298;
            background: #e8f0fe;
        }

        /* Button styling for plane items and guide/methodology */
        .step-button {
            width: 100%;
            min-height: 64px;
            background: #f5f0e8;
            border: 2px solid #d4cdbf;
            border-radius: 8px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            color: #1f1c18;
            font-weight: 500;
        }

        .step-button:hover {
            border-color: #2a5298;
            background: #e8f0fe;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(42, 82, 152, 0.2);
        }

        .step-button.active {
            border-color: #2a5298;
            background: #e8f0fe;
        }

        .step-label {
            font-size: 1.05rem;
            font-weight: 500;
            color: #1f1c18;
            line-height: 1.3;
        }

        .step-value {
            font-size: 0.9rem;
            color: #666;
            font-weight: 400;
        }

        .step-sublabel {
            font-size: 0.85rem;
            color: #666;
            font-weight: 400;
        }

        /* Steps row - horizontal layout */
        .steps-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            padding: 0;
            flex-wrap: nowrap;
            background: transparent;
        }

        .step {
            flex: 0 0 240px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 6px;
            min-width: 240px;
        }

        .step-card {
            min-height: 70px;
            border: 2px solid #c9c2b4;
            border-radius: 10px;
            background: #f5f0e8;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            color: #1f1c18;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .step-card:hover {
            border-color: #2a5298;
            background: #e8f0fe;
            box-shadow: 0 6px 16px rgba(42, 82, 152, 0.2);
            transform: translateY(-2px);
        }

        /* Make dropdowns fit properly inside step-card */
        .step-card .plane-dropdown {
            border: none;
            background: transparent;
            min-height: auto;
            padding: 12px 32px 12px 10px;
            width: 100%;
            height: auto;
            box-sizing: border-box;
            white-space: normal;
            line-height: 1.4;
        }

        .step-card .plane-dropdown:hover,
        .step-card .plane-dropdown:focus {
            background: transparent;
            border: none;
            transform: none;
            box-shadow: none;
        }

        .step-card .plane-dropdown.selected {
            background: transparent;
            border: none;
        }

        /* Button inside step-card */
        .step-card .step-button {
            border: none;
            background: transparent;
            min-height: auto;
            padding: 10px 12px;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .step-card .step-button:hover {
            background: transparent;
            border: none;
            transform: none;
            box-shadow: none;
        }


        .sequence-item {
            opacity: 1;
            transform: none;
            transition: none;
        }

        .sequence-item.is-visible {
            opacity: 1;
            transform: none;
        }

        .step-caption {
            font-size: 0.9rem;
            color: #1f1c18;
            line-height: 1.5;
            text-align: left;
            margin-top: 4px;
        }

        .arrow-text {
            font-size: 0.92rem;
            color: #1f1c18;
            line-height: 1.5;
            max-width: 260px;
            text-align: left;
        }

        .resources-divider {
            margin: 12px auto 6px;
            width: 120px;
            border: 0;
            border-top: 1px solid #e0e0e0;
        }

        .resources-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: stretch;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .resource-card {
            flex: 1 1 260px;
            max-width: 320px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 18px 16px;
            text-align: left;
            cursor: pointer;
            transition: box-shadow 0.1s ease, transform 0.1s ease, border-color 0.1s ease;
        }

        .resource-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
            border-color: #d0d0d0;
        }

        .resource-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f1c18;
            margin-bottom: 6px;
        }

        .resource-desc {
            font-size: 14px;
            color: #4a4a4a;
            line-height: 1.5;
        }

        .step-badge {
            background: #eef2f7;
            color: #1f1c18;
            font-size: 0.68rem;
            font-weight: 500;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            padding: 3px 6px;
            border-radius: 10px;
            display: inline-block;
            align-self: flex-start;
            margin-bottom: 4px;
        }

        @media (max-width: 1100px) {
            .sequence-container {
                grid-template-columns: 1fr;
                gap: 32px;
            }

        }

        @media (max-width: 900px) {
            .horizontal-sequence {
                padding: 24px 0 28px;
                margin: 8px auto 32px;
            }

            .steps-row {
                flex-wrap: wrap;
                padding: 16px;
            }

            .step {
                flex: 1 1 200px;
            }

            .step-caption {
                text-align: center;
            }

        }

        /* Minimal card - remove heavy styling */
        .minimal-card {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 64px 0;
            text-align: left;
        }

        /* Clean navigation links */
        .nav-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin: 32px 0 48px;
            font-size: 0.95rem;
        }

        .nav-link-btn {
            background: transparent;
            border: none;
            color: #2a5298;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.1s ease;
            padding: 0;
            font-size: inherit;
        }

        .nav-link-btn:hover {
            color: #1a3f78;
            text-decoration: underline;
        }

        .nav-divider {
            color: #d9d2c4;
        }

        /* Larger, more prominent dropdowns in minimal card */
        .minimal-card .step-inline {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 80px;
        }

        .minimal-card select {
            width: 100%;
            font-size: 1.05rem;
            padding: 14px 16px;
            font-weight: 400;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: #fafafa;
            color: #1f1c18;
            transition: border-color 0.1s ease, background 0.1s ease;
            box-shadow: none;
        }

        .minimal-card select:focus {
            outline: none;
            border-color: #2a5298;
            background: #ffffff;
        }

        .minimal-card select:hover {
            border-color: #a0a0a0;
        }

        .minimal-card .step-heading {
            font-size: 1.25rem;
            margin-bottom: 16px;
            font-weight: 400;
            color: #1f1c18;
            letter-spacing: -0.01em;
        }

        .minimal-card .step-block {
            text-align: left;
        }

        /* Questionnaire text - inline after hierarchy */
        .questionnaire-text {
            margin-top: 20px;
            font-size: 0.98rem;
            color: #666;
            font-weight: 400;
        }

        .text-link-btn {
            background: none;
            border: none;
            color: #2a5298;
            font-size: inherit;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
            text-decoration: none;
            transition: color 0.1s ease;
        }

        .text-link-btn.inline-link {
            display: inline;
        }

        .text-link-btn:hover {
            color: #1a3f78;
            text-decoration: underline;
        }

        /* Staggered animation delays for each section */
        .minimal-card .step-inline > .step-block:nth-child(1) {
            animation-delay: 0.1s;
        }

        .minimal-card .step-inline > .step-block:nth-child(2) {
            animation-delay: 0.5s;
        }

        /* Drop-in keyframes animation */
        @keyframes dropIn {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(5px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-actions {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-button {
            border: 1px solid #1f1c18;
            background: #1f1c18;
            color: #ffffff;
            padding: 10px 24px;
            border-radius: 999px;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-weight: 600;
            transition: all 0.1s ease;
        }

        .header-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(31, 28, 24, 0.15);
        }

        .header-button--ghost {
            background: transparent;
            color: #1f1c18;
        }

        .eyebrow {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #1f1c18;
            font-weight: 600;
        }

        .model-explanation {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.05);
            margin-bottom: 16px;
        }

        .model-explanation h2 {
            margin-bottom: 1rem;
        }

        .ai-equation {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.05);
            margin: 72px 0 64px;
            overflow: hidden;
            max-width: 100%;
        }

        .section-intro {
            margin-bottom: 24px;
        }

        .section-intro p {
            color: #5c564f;
        }

        .equation-callout {
            margin: 24px 0;
            padding: 20px 24px;
            border-left: 4px solid #d2c7b8;
            background: #fefbf5;
            border-radius: 18px;
            overflow: hidden;
            max-width: 100%;
        }

        .callout-label {
            display: block;
            font-size: 0.8rem;
            letter-spacing: 0.12em;
            color: #3b3326;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .equation-callout code {
            font-family: 'IBM Plex Mono', 'Menlo', monospace;
            font-size: 0.95rem;
            color: #3b3326;
            background: transparent;
        }

        .equation-display {
            font-size: 1.1rem;
            color: #3b3326;
            overflow-x: auto;
            padding: 8px 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .factor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin: 32px 0;
            list-style: none;
            padding: 0;
        }

        .factor-grid li {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 16px;
            padding: 16px 18px;
            font-size: 0.95rem;
            color: #3f392f;
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.04);
        }

        .factor-grid--compact {
            margin-top: 24px;
        }

        .note {
            font-size: 0.85rem;
            color: #8c857d;
            font-style: italic;
        }

        .inline-link {
            color: var(--accent);
            text-decoration: underline;
            transition: color 0.1s ease;
        }

        .inline-link:hover {
            color: var(--accent-hover);
        }
        .setup-wizard {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-7);
            box-shadow: 0 32px 80px rgba(15, 23, 42, 0.05);
        }

        .setup-section {
            padding-top: 16px;
            margin-top: 16px;
        }

        .setup-section:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        .role-presets {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .preset-btn {
            border-radius: 16px;
            border: 1px solid #d9d2c4;
            background: #fdfaf4;
            padding: 14px 18px;
            font-weight: 500;
            color: #4b453c;
            transition: all 0.1s ease;
        }

        .preset-btn:hover,
        .preset-btn.active {
            background: #1f1c18;
            color: #ffffff;
            border-color: #1f1c18;
            box-shadow: 0 12px 28px rgba(31, 28, 24, 0.2);
        }

        label {
            color: #3f392f;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            border-radius: 14px;
            border: 1px solid #d9d2c4;
            padding: 12px 14px;
            font-size: 0.95rem;
            background: #fdfaf4;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid rgba(31, 28, 24, 0.25);
        }

        input[type="range"] {
            accent-color: #1f1c18;
        }

        .progress-indicator {
            display: flex;
            flex-direction: column;
            gap: 12px;
            color: #3b3326;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 16px;
            margin-top: -12px;
        }

        .progress-bar {
            height: 6px;
            background: #f1eadf;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-fill {
            background: #1f1c18;
            width: 0;
            height: 100%;
            border-radius: inherit;
        }

        .timeline-comparison {
            display: grid;
            gap: 20px;
            margin: 48px 0;
        }

        .timeline-card {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 18px 48px rgba(15, 23, 42, 0.05);
        }

        .timeline-card h4 {
            margin-bottom: 12px;
        }

        .timeline-event {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
            color: #3f392f;
        }

        .timeline-date {
            font-weight: 600;
            font-family: 'IBM Plex Mono', 'Menlo', monospace;
            color: var(--accent);
        }

        .controls-grid {
            display: grid;
            gap: 24px;
            margin: 8px 0 16px;
        }

        .control-group {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 16px 42px rgba(15, 23, 42, 0.05);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .value-display {
            font-family: 'IBM Plex Mono', 'Menlo', monospace;
            color: #8c857d;
            font-size: 0.9rem;
        }

        .chart-container {
            background: #ffffff;
            border: 1px solid #e6e0d4;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.05);
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
        }

        .chart-container canvas {
            flex: 1;
            min-height: 480px;
            max-height: 580px;
        }

        .chart-header {
            text-align: center;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .chart-header-top {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 4px;
            position: relative;
        }

        .chart-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .chart-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .pin-checkbox-label {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
            color: var(--text-tertiary);
            cursor: pointer;
            white-space: nowrap;
        }

        .pin-checkbox-label input {
            cursor: pointer;
        }

        /* Default pinnable section - chart left, metrics right */
        .pinnable-section {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .pinnable-section .chart-container {
            flex: 1;
            min-width: 0;
            margin-bottom: 0;
        }

        .pinnable-section .results {
            flex: 0 0 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 0;
            justify-content: center;
        }

        .pinnable-section .result-card {
            padding: 16px;
        }

        /* Container transitions */
        .container {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-wrapper {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* When pinned - shift content left, chart on right */
        body.chart-pinned .container {
            max-width: none;
            margin: 0;
            padding-left: 40px;
            padding-right: 40px;
            display: flex;
            gap: 48px;
            align-items: flex-start;
        }

        body.chart-pinned .content-wrapper {
            flex: 1 1 0;
            max-width: 1200px;
        }

        body.chart-pinned .container > .pinnable-section {
            position: sticky;
            top: 110px;
            flex: 1 1 0;
            min-width: 520px;
            max-width: 1200px;
            align-self: flex-start;
            flex-direction: column;
            max-height: calc(100vh - 130px);
            overflow: auto;
        }

        body.chart-pinned .container > .pinnable-section .chart-container {
            width: 100%;
            flex: none;
            margin-bottom: 24px;
        }

        body.chart-pinned .container > .pinnable-section .results {
            flex: none;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        /* Responsive - hide pin on smaller screens */
        @media (max-width: 1600px) {
            .pin-checkbox-label {
                display: none;
            }
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-top: 48px;
        }

        .result-card {
            border-radius: 20px;
            border: 1px solid #e6e0d4;
            background: linear-gradient(180deg, #ffffff 0%, #fdf8f0 100%);
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.05);
            padding: 24px;
            text-align: left;
        }

        .result-card h4 {
            font-size: 0.95rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: #8c857d;
        }

        .result-value {
            font-family: 'Inter', sans-serif;
            font-size: 2rem;
            color: #1f1c18;
            margin-top: 8px;
        }

        /* .result-card.critical styling intentionally removed */

        .footer-note {
            color: #8c857d;
            font-size: 0.85rem;
            margin-top: 32px;
        }

        .parameter-summary,
        .parameter-item {
            color: #3f392f;
        }

        /* Match Guide header width on tablets */
        @media (max-width: 900px) {
            .header-inner {
                width: 94%;
            }
        }

        @media (max-width: 640px) {
            .header-inner {
                flex-direction: column;
                align-items: center;
                gap: 16px;
                text-align: center;
            }

            .centered-header .header-brand {
                align-items: center;
            }

            .centered-header .nav {
                margin-left: 0;
                justify-content: center;
                width: 100%;
            }

            .header-actions {
                width: 100%;
            }

            .header-btn {
                flex: 1;
            }

            .hero, .hero-section, .article-hero {
                padding: 56px 16px 32px;
            }

            .hero h1, .hero-section h1, .article-hero h1 {
                font-size: clamp(1.8rem, 6vw, 2.4rem);
                margin-top: 12px;
                letter-spacing: -0.01em;
            }

            .lede {
                font-size: 1.0rem;
                max-width: 100%;
                line-height: 1.6;
            }

            .model-explanation,
            .ai-equation,
            .setup-wizard {
                padding: 32px 24px;
            }

            /* Stack equation grids on mobile - but not question grids */
            .ai-equation-display [style*="grid-template-columns: 1fr 1fr"],
            .model-explanation [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Mobile nav should stack and center */
            .nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .nav-link {
                padding: 12px 18px;
                font-size: 0.95rem;
            }

            .centered-header .header-inner {
                flex-direction: column;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
            }

            .publication-title {
                font-size: 1.1rem;
            }

            /* Prevent horizontal overflow */
            .horizontal-sequence {
                padding: 16px 0;
                margin: 0 auto 24px;
            }

            .sequence-container {
                padding: 0 8px;
            }

            .steps-row {
                flex-direction: column;
                gap: 16px;
                padding: 12px;
            }

            .step {
                flex: none;
                width: 100%;
            }

            .step-number {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .step-caption h4 {
                font-size: 0.95rem;
            }

            .step-caption p {
                font-size: 0.85rem;
            }

            /* Minimal card mobile */
            .minimal-card {
                padding: 32px 0;
            }

            .minimal-card .step-inline {
                gap: 48px;
            }

            .minimal-card .step-heading {
                font-size: 1.1rem;
            }

            /* Pinnable section should stack vertically on mobile */
            .pinnable-section {
                flex-direction: column;
                gap: 24px;
            }

            .pinnable-section .chart-container {
                flex: none;
                width: 100%;
                margin-bottom: 0;
            }

            .pinnable-section .results {
                flex: none;
                width: 100%;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            /* Chart container mobile */
            .chart-container {
                padding: 12px;
                border-radius: 12px;
            }

            .chart-container canvas {
                min-height: 250px;
                max-height: 300px;
            }

            /* Results grid mobile */
            .results {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-top: 0;
            }

            .result-card {
                padding: 16px;
                border-radius: 12px;
            }

            .result-card h4 {
                font-size: 0.75rem;
            }

            .result-value {
                font-size: 1.4rem;
            }

            /* Parameter breakdown mobile */
            .parameter-breakdown {
                padding: 16px;
                border-radius: 12px;
            }

            .profile-grid {
                grid-template-columns: 1fr;
            }

            /* Advanced Model Tuning mobile fixes */
            .model-tuning-panel {
                padding: 12px !important;
            }

            .tuning-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .tuning-split-2,
            .tuning-split-3,
            .tuning-split-4 {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .tuning-subgrid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .tuning-checkbox-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .tuning-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tuning-table {
                min-width: 100%;
                font-size: 0.8em;
            }

            .tuning-table th,
            .tuning-table td {
                padding: 4px 6px;
                font-size: 0.8em;
            }

            .tuning-note {
                font-size: 0.85em;
            }

            .tuning-actions {
                flex-direction: column;
                gap: 8px;
            }

            .tuning-action-btn {
                width: 100%;
                font-size: 0.9em;
            }

            .tuning-presets {
                gap: 6px;
            }

            .tuning-preset-btn {
                font-size: 0.8em;
                padding: 6px 10px;
            }

            /* Override grid-column span on mobile */
            .tuning-card[style*="grid-column"] {
                grid-column: span 1 !important;
            }

            /* Ensure tables don't overflow */
            .tuning-card {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .section-title--with-actions {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }

            .section-title--with-actions span {
                margin-left: 0 !important;
            }
        }

        /* Extra small screens */
        @media (max-width: 380px) {
            .container {
                padding: 0 10px 48px;
            }

            .nav-link {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            h1 {
                font-size: 1.5rem !important;
            }

            .hero p, .hero-section p {
                font-size: 0.92rem;
                margin-top: 6px;
            }

            .model-explanation,
            .ai-equation,
            .setup-wizard {
                padding: 20px 16px;
            }

            .result-value {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header class="site-header centered-header">
        <div class="header-inner">
            <div class="header-brand centered-brand">
                <span class="publication-title">Don't Lose Your Job</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link active">Model</a>
                <a href="/guide" class="nav-link">Guide</a>
                <a href="/method" class="nav-link">Methodology</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="content-wrapper">
            <button id="step-open-survey" type="button" class="visually-hidden" aria-hidden="true">Open survey</button>
            <svg width="0" height="0" aria-hidden="true" focusable="false" style="position:absolute;">
                <defs>
                    <marker id="arrowhead-blue" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                        <path d="M0,0 L0,8 L8,4 Z" fill="#0b4fa5"></path>
                    </marker>
                </defs>
            </svg>

            <section class="hero">
                <h1>Job Displacement Model</h1>
                <p>Estimate when AI might affect your role based on METR's task horizon research and your specific job characteristics.</p>
            </section>

            <section class="horizontal-sequence" id="progression">
            <div class="sequence-container">
                <div class="steps-row">
                    <div class="step">
                        <div class="step-badge sequence-item" data-seq="1">Step 1</div>
                        <div class="step-card sequence-item" data-seq="2">
                            <select id="role-select" class="plane-dropdown">
                                <option value="">Select role</option>
                                <option value="software">Software/Tech</option>
                                <option value="admin">Administrative</option>
                                <option value="customer-service">Customer Service</option>
                                <option value="data-analysis">Data Analysis</option>
                                <option value="finance">Finance/Accounting</option>
                                <option value="sales">Sales/Marketing</option>
                                <option value="creative">Creative/Design</option>
                                <option value="legal">Legal/Compliance</option>
                                <option value="product-management">Product Management</option>
                                <option value="consulting">Consulting/Strategy</option>
                                <option value="hr">HR/People Ops</option>
                                <option value="content-writing">Content Writing</option>
                                <option value="journalism">Journalism</option>
                                <option value="engineering">Engineering (Non-Software)</option>
                                <option value="operations">Operations Management</option>
                                <option value="custom">Other/Custom</option>
                            </select>
                        </div>
                        <div class="step-caption sequence-item" data-seq="7">Choose your role to set baseline automation risk.</div>
                    </div>

                    <div class="step">
                        <div class="step-badge sequence-item" data-seq="3">Step 2</div>
                        <div class="step-card sequence-item" data-seq="4">
                            <select id="hierarchy-select" class="plane-dropdown">
                                <option value="">Select hierarchy level</option>
                                <option value="1">Level 1: Many layers above me (4+ people who do similar work)</option>
                                <option value="2">Level 2: Several layers above (2-3 people/levels)</option>
                                <option value="3">Level 3: Few above (1-2 people) or mostly peers</option>
                                <option value="4">Level 4: Top of my domain (no one above can do my work)</option>
                                <option value="5">Level 5: Unique/irreplaceable (own entire function/system)</option>
                            </select>
                        </div>
                        <div class="step-caption sequence-item" data-seq="7">Select your hierarchy level based on how many people <strong>above you</strong> could realistically do your job. This differs from total seniority: someone may outrank you but be unable to perform your core duties. If you're the sole owner of a product, system, or program, you're likely Level 4–5.</div>
                    </div>

                    <div class="step">
                        <div class="step-badge sequence-item" data-seq="5">Step 3</div>
                        <div class="step-card step-card-button sequence-item" data-seq="6" style="min-height:70px;">
                            <button id="questionnaire-button" class="step-button" style="width:100%; height:100%;">Personalize attributes</button>
                        </div>
                        <div class="step-caption sequence-item" data-seq="7">Fine-tune hazard and compression weights for accuracy.</div>
                    </div>
                </div>
                <hr class="resources-divider">
                <div class="resources-row">
                    <div class="resource-card nav-button sequence-item" data-page="/guide" data-seq="8">
                        <div class="resource-title">Guide</div>
                        <div class="resource-desc">Actionable checklist to interpret results and plan next steps.</div>
                    </div>
                    <div class="resource-card nav-button sequence-item" data-page="/method" data-seq="9">
                        <div class="resource-title">Methodology</div>
                        <div class="resource-desc">Deep dive into the math behind hazard and compression models.</div>
                    </div>
                </div>
            </div>
            </section>

            <div class="two-column-layout">
                <div class="left-column legacy-wizard hidden-block">
                    <div class="setup-wizard" id="setup-wizard">
            <div class="visually-hidden backend-controls" aria-hidden="true">
                <div class="setup-section">
                    <h3>Step 1: Select Your Role Category</h3>
                    <div class="role-presets">
                        <button class="preset-btn" data-role="software">
                            Software/Tech
                        </button>
                        <button class="preset-btn" data-role="admin">
                            Administrative
                        </button>
                        <button class="preset-btn" data-role="customer-service">
                            Customer Service
                        </button>
                        <button class="preset-btn" data-role="data-analysis">
                            Data Analysis
                        </button>
                        <button class="preset-btn" data-role="finance">
                            Finance/Accounting
                        </button>
                        <button class="preset-btn" data-role="sales">
                            Sales/Marketing
                        </button>
                        <button class="preset-btn" data-role="creative">
                            Creative/Design
                        </button>
                        <button class="preset-btn" data-role="legal">
                            Legal/Compliance
                        </button>
                        <button class="preset-btn" data-role="product-management">
                            Product Management
                        </button>
                        <button class="preset-btn" data-role="consulting">
                            Consulting/Strategy
                        </button>
                        <button class="preset-btn" data-role="hr">
                            HR/People Ops
                        </button>
                        <button class="preset-btn" data-role="content-writing">
                            Content Writing
                        </button>
                        <button class="preset-btn" data-role="journalism">
                            Journalism
                        </button>
                        <button class="preset-btn" data-role="engineering">
                            Engineering (Non-Software)
                        </button>
                        <button class="preset-btn" data-role="operations">
                            Operations Management
                        </button>
                        <button class="preset-btn" data-role="custom">Other/Custom</button>
                    </div>
                </div>

                <div class="setup-section">
                    <h3>Step 2: Your Hierarchy Position</h3>
                    <div class="question">
                        <p>Select based on how many people <strong>above you in your specific workflow</strong> could absorb your responsibilities if your role were eliminated. A senior engineer who owns a system has no one above (Level 4-5), while a VP with C-suite above might be Level 2-3.</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="seniority-1" name="seniority" value="1" checked>
                                <label for="seniority-1">Level 1: Many layers above me (4+ people who do similar work)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="seniority-2" name="seniority" value="2">
                                <label for="seniority-2">Level 2: Several layers above (2-3 people/levels)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="seniority-3" name="seniority" value="3">
                                <label for="seniority-3">Level 3: Few above (1-2 people) or mostly peers</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="seniority-4" name="seniority" value="4">
                                <label for="seniority-4">Level 4: Top of my domain (no one above can do my work)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="seniority-5" name="seniority" value="5">
                                <label for="seniority-5">Level 5: Unique/irreplaceable (own entire function/system)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setup-section">
                <div class="card">
                    <div class="card-header">
                        <div class="section-title--with-actions">
                            <div>
                                <h2 class="card-title">Job characteristics</h2>
                                <p class="card-description">Answer these questions to calibrate the model for your specific role.</p>
                            </div>
                            <label class="task-bucket-toggle" style="margin-left:auto;">
                                <input type="checkbox" id="prefill-questions">
                                <span>Prefill from inferred role + hierarchy characteristics</span>
                            </label>
                        </div>
                    </div>

                <div class="category">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">
                            AI Technical Readiness
                            <span class="category-count">4 questions</span>
                        </div>
                        <div class="category-toggle">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="category-content">
                        <div class="question-grid">
                    <div class="question">
                        <h5>1. Current AI Performance</h5>
                        <p>How well can AI already perform core tasks in your field?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q1-1" name="q1" value="1">
                                <label for="q1-1">Very Poor</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-2" name="q1" value="2">
                                <label for="q1-2">Limited</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-3" name="q1" value="3" checked>
                                <label for="q1-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-4" name="q1" value="4">
                                <label for="q1-4">Good</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q1-5" name="q1" value="5">
                                <label for="q1-5">Near-Human</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>2. Data Availability</h5>
                        <p>How much example work and documentation about your type of role is available (training materials, online guides, industry examples, case studies)?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q2-1" name="q2" value="1">
                                <label for="q2-1">Very Limited</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-2" name="q2" value="2">
                                <label for="q2-2">Limited</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-3" name="q2" value="3" checked>
                                <label for="q2-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-4" name="q2" value="4">
                                <label for="q2-4">Abundant</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q2-5" name="q2" value="5">
                                <label for="q2-5">Very Abundant</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>3. Benchmark Clarity</h5>
                        <p>How easily can success in your role be measured objectively?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q3-1" name="q3" value="1">
                                <label for="q3-1">Very Hard</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-2" name="q3" value="2">
                                <label for="q3-2">Difficult</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-3" name="q3" value="3" checked>
                                <label for="q3-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-4" name="q3" value="4">
                                <label for="q3-4">Fairly Easy</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q3-5" name="q3" value="5">
                                <label for="q3-5">Very Easy</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>4. Task Digitization</h5>
                        <p>What percentage of your work inputs and outputs currently exist in digital/text format?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q4-1" name="q4" value="1">
                                <label for="q4-1">0-20%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-2" name="q4" value="2">
                                <label for="q4-2">21-40%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-3" name="q4" value="3" checked>
                                <label for="q4-3">41-60%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-4" name="q4" value="4">
                                <label for="q4-4">61-80%</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q4-5" name="q4" value="5">
                                <label for="q4-5">81-100%</label>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div><!-- End category-content -->
                </div><!-- End category -->

                <div class="category">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">
                            Task Structure & Adaptability
                            <span class="category-count">6 questions</span>
                        </div>
                        <div class="category-toggle">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="category-content">
                        <div class="question-grid">
                    <div class="question">
                        <h5>5. Task Decomposability</h5>
                        <p>Can your work be broken into discrete, measurable tasks?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q5-1" name="q5" value="1">
                                <label for="q5-1">Very Complex</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-2" name="q5" value="2">
                                <label for="q5-2">Complex</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-3" name="q5" value="3" checked>
                                <label for="q5-3">Mixed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-4" name="q5" value="4">
                                <label for="q5-4">Structured</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q5-5" name="q5" value="5">
                                <label for="q5-5">Highly Structured</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>6. Task Standardization</h5>
                        <p>How standardized are procedures/workflows in your role?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q6-1" name="q6" value="1">
                                <label for="q6-1">Highly Variable</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-2" name="q6" value="2">
                                <label for="q6-2">Variable</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-3" name="q6" value="3" checked>
                                <label for="q6-3">Somewhat Standard</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-4" name="q6" value="4">
                                <label for="q6-4">Standardized</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q6-5" name="q6" value="5">
                                <label for="q6-5">Highly Standardized</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>7. Context Dependency</h5>
                        <p>How much does your work require understanding unique organizational context?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q7-1" name="q7" value="5">
                                <label for="q7-1">Critical</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-2" name="q7" value="4">
                                <label for="q7-2">Very Important</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-3" name="q7" value="3" checked>
                                <label for="q7-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-4" name="q7" value="2">
                                <label for="q7-4">Some Needed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q7-5" name="q7" value="1">
                                <label for="q7-5">Minimal</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>8. Feedback Loop Speed</h5>
                        <p>How quickly do you get feedback on work quality?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q8-1" name="q8" value="1">
                                <label for="q8-1">Months/Years</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-2" name="q8" value="2">
                                <label for="q8-2">Weeks</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-3" name="q8" value="3" checked>
                                <label for="q8-3">Days</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-4" name="q8" value="4">
                                <label for="q8-4">Hours</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q8-5" name="q8" value="5">
                                <label for="q8-5">Minutes/Instant</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>9. Tacit Knowledge</h5>
                        <p>How much of your expertise is documented vs. learned through experience?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q9-1" name="q9" value="5">
                                <label for="q9-1">Mostly Tacit</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-2" name="q9" value="4">
                                <label for="q9-2">Largely Tacit</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-3" name="q9" value="3" checked>
                                <label for="q9-3">Mixed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-4" name="q9" value="2">
                                <label for="q9-4">Largely Documented</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q9-5" name="q9" value="1">
                                <label for="q9-5">Fully Documented</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>10. Task Reallocation Risk</h5>
                        <p>If your position were eliminated, how easily could your responsibilities be redistributed to existing team members?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q10-1" name="q10" value="1">
                                <label for="q10-1">Nearly impossible - unique expertise/relationships</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-2" name="q10" value="2">
                                <label for="q10-2">Very difficult - would take 6-12 months to transfer</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-3" name="q10" value="3" checked>
                                <label for="q10-3">Moderately difficult - requires 2-6 months training</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-4" name="q10" value="4">
                                <label for="q10-4">Fairly easily - needs 1-2 months knowledge transfer</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q10-5" name="q10" value="5">
                                <label for="q10-5">Very easily - others already do similar work</label>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div><!-- End category-content -->
                </div><!-- End category -->

                <div class="category">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">
                            Human & Organizational Factors
                            <span class="category-count">2 questions</span>
                        </div>
                        <div class="category-toggle">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="category-content">
                        <div class="question-grid">
                    <div class="question">
                        <h5>11. Human Judgment & Relationships</h5>
                        <p>How critical are human relationships, empathy, and trust in your role?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q11-1" name="q11" value="5">
                                <label for="q11-1">Essential</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-2" name="q11" value="4">
                                <label for="q11-2">Very Important</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-3" name="q11" value="3" checked>
                                <label for="q11-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-4" name="q11" value="2">
                                <label for="q11-4">Some Needed</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q11-5" name="q11" value="1">
                                <label for="q11-5">Minimal</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>12. Physical Presence</h5>
                        <p>How much does your work require physical presence?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q12-1" name="q12" value="5">
                                <label for="q12-1">Essential</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-2" name="q12" value="4">
                                <label for="q12-2">Very Important</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-3" name="q12" value="3" checked>
                                <label for="q12-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-4" name="q12" value="2">
                                <label for="q12-4">Some</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q12-5" name="q12" value="1">
                                <label for="q12-5">None</label>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div><!-- End category-content -->
                </div><!-- End category -->

                <div class="category">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">
                            Company & Industry Context
                            <span class="category-count">4 questions</span>
                        </div>
                        <div class="category-toggle">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="category-content">
                        <div class="question-grid">
                    <div class="question">
                        <h5>13. Company AI Adoption Readiness</h5>
                        <p>How prepared is your organization for AI integration?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q13-1" name="q13" value="1">
                                <label for="q13-1">Resistant</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-2" name="q13" value="2">
                                <label for="q13-2">Cautious</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-3" name="q13" value="3" checked>
                                <label for="q13-3">Exploring</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-4" name="q13" value="4">
                                <label for="q13-4">Adopting</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q13-5" name="q13" value="5">
                                <label for="q13-5">Leading Edge</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>14. Labor Cost Pressure</h5>
                        <p>How cost-sensitive is your employer to labor expenses?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q14-1" name="q14" value="1">
                                <label for="q14-1">Not Sensitive</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-2" name="q14" value="2">
                                <label for="q14-2">Somewhat</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-3" name="q14" value="3" checked>
                                <label for="q14-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-4" name="q14" value="4">
                                <label for="q14-4">Very Sensitive</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q14-5" name="q14" value="5">
                                <label for="q14-5">Extremely Sensitive</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>15. Labor Market Tightness</h5>
                        <p>How difficult is it to hire people with your skills?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q15-1" name="q15" value="5">
                                <label for="q15-1">Very Difficult</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-2" name="q15" value="4">
                                <label for="q15-2">Difficult</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-3" name="q15" value="3" checked>
                                <label for="q15-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-4" name="q15" value="2">
                                <label for="q15-4">Easy</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q15-5" name="q15" value="1">
                                <label for="q15-5">Very Easy</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>16. IT Infrastructure</h5>
                        <p>How modern is your organization's technical infrastructure?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q16-1" name="q16" value="1">
                                <label for="q16-1">Very Outdated</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-2" name="q16" value="2">
                                <label for="q16-2">Outdated</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-3" name="q16" value="3" checked>
                                <label for="q16-3">Current</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-4" name="q16" value="4">
                                <label for="q16-4">Modern</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q16-5" name="q16" value="5">
                                <label for="q16-5">Cutting Edge</label>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div><!-- End category-content -->
                </div><!-- End category -->

                <div class="category">
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">
                            Personal Adaptability
                            <span class="category-count">3 questions</span>
                        </div>
                        <div class="category-toggle">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <div class="category-content">
                        <div class="question-grid">
                    <div class="question">
                        <h5>17. Skill Transferability</h5>
                        <p>How transferable are your core skills to other roles/industries?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q17-1" name="q17" value="1">
                                <label for="q17-1">Highly Specific</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-2" name="q17" value="2">
                                <label for="q17-2">Somewhat Specific</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-3" name="q17" value="3" checked>
                                <label for="q17-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-4" name="q17" value="4">
                                <label for="q17-4">Transferable</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q17-5" name="q17" value="5">
                                <label for="q17-5">Highly Transferable</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>18. Adaptability/Learning</h5>
                        <p>How quickly can you learn and adopt new tools/technologies?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q18-1" name="q18" value="1">
                                <label for="q18-1">Very Slow</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-2" name="q18" value="2">
                                <label for="q18-2">Slow</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-3" name="q18" value="3" checked>
                                <label for="q18-3">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-4" name="q18" value="4">
                                <label for="q18-4">Fast</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q18-5" name="q18" value="5">
                                <label for="q18-5">Very Fast</label>
                            </div>
                        </div>
                    </div>

                    <div class="question">
                        <h5>19. Job Performance</h5>
                        <p>How good are you at your job, relative to your peers?</p>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="q19-1" name="q19" value="1">
                                <label for="q19-1">Below Average</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-2" name="q19" value="2">
                                <label for="q19-2">Average</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-3" name="q19" value="3" checked>
                                <label for="q19-3">Above Average</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-4" name="q19" value="4">
                                <label for="q19-4">Excellent</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="q19-5" name="q19" value="5">
                                <label for="q19-5">Top Performer</label>
                            </div>
                        </div>
                    </div>

                    </div>
                    </div><!-- End category-content -->
                </div><!-- End category -->

                </div><!-- End card -->
            </div><!-- End setup-section -->
                    </div>
                </div>

                <div class="right-column hidden-block" id="results-column">

            <div class="pinnable-section" id="pinnable-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-header-top">
                            <h3 class="chart-title">Displacement Probability Over Time</h3>
                            <label class="pin-checkbox-label">
                                <input type="checkbox" id="pin-chart-toggle">
                                <span>Pin to side</span>
                            </label>
                        </div>
                        <p class="chart-subtitle" id="chart-subtitle">-</p>
                    </div>
                    <canvas id="chart"></canvas>
                </div>
                <div class="results">
                    <div class="result-card" id="median-card">
                        <h4>50% Job Loss Risk</h4>
                        <div class="result-value" id="median-year">-</div>
                    </div>
                    <div class="result-card" id="high-card">
                        <h4>90% Job Loss Risk</h4>
                        <div class="result-value" id="high-year">-</div>
                    </div>
                    <div class="result-card" id="risk5-card">
                        <h4>Risk by 2030</h4>
                        <div class="result-value" id="risk-2030">-</div>
                    </div>
                    <div class="result-card" id="risk10-card">
                        <h4>Risk by 2031</h4>
                        <div class="result-value" id="risk-2031">-</div>
                    </div>
                    <div class="result-card" id="reemployment-card">
                        <h4>Re-employment Likelihood</h4>
                        <div class="result-value" id="reemployment-value">-</div>
                    </div>
                </div>
            </div>

            <div class="controls-grid">
                <div class="control-group">
                    <h3>Industry Friction</h3>
                    <p>Industry-level friction multiplier. Note: Your questionnaire answers (Q4-Q12) already capture most domain differences.</p>
                    <div class="slider-container">
                        <input type="range" id="industry-pace" min="1.0" max="2.0" step="0.05" value="1.0">
                        <span class="value-display" id="industry-pace-value">1.0x</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>AI Reliability</h3>
                    <p>Success rate required before automation</p>
                    <div class="slider-container">
                        <input type="range" id="ai-reliability" min="50" max="99" step="1" value="95">
                        <span class="value-display" id="ai-reliability-value">95%</span>
                    </div>
                </div>
            </div>

        <div class="parameter-breakdown">
            <div class="profile-timeline">
                    <h4 class="section-title section-title--with-actions">
                        <button id="edit-task-buckets" class="header-btn header-btn--compact">
                            Edit task buckets (optional)
                        </button>
                    </h4>
                    <div id="task-bucket-editor" class="additional-questions task-bucket-editor">
                        <div class="task-bucket-panel">
                            <div class="task-bucket-header">
                                <p class="task-bucket-description">Adjust your job's baseline time split across the model's task duration buckets: &lt;10 min, 10-45 min, 45-180 min, 3-8 hr, &gt;12 hr.</p>
                                <label class="task-bucket-toggle">
                                    <input type="checkbox" id="tb-auto" checked>
                                    <span>Follow model (auto)</span>
                                </label>
                            </div>
                            <div class="task-bucket-grid">
                                <label class="task-bucket-field">
                                    <span class="task-bucket-label">&lt;10 min (L=5)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-0" value="25" class="task-bucket-input">
                                </label>
                                <label class="task-bucket-field">
                                    <span class="task-bucket-label">10-45 min (L=30)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-1" value="35" class="task-bucket-input">
                                </label>
                                <label class="task-bucket-field">
                                    <span class="task-bucket-label">45-180 min (L=120)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-2" value="25" class="task-bucket-input">
                                </label>
                                <label class="task-bucket-field">
                                    <span class="task-bucket-label">3-8 hr (L=360)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-3" value="10" class="task-bucket-input">
                                </label>
                                <label class="task-bucket-field">
                                    <span class="task-bucket-label">&gt;12 hr (L=720)</span>
                                    <input type="number" min="0" max="100" step="1" id="tb-bucket-4" value="5" class="task-bucket-input">
                                </label>
                            </div>
                            <div class="task-bucket-footer">
                                <span id="tb-sum" class="task-bucket-sum">Sum: 100%</span>
                                <div class="task-bucket-actions">
                                    <button id="tb-apply" class="header-btn header-btn--compact">Apply Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <div class="parameter-breakdown">
            <div class="profile-timeline">
                    <h4 class="section-title section-title--with-actions">
                        <button id="toggle-model-tuning" class="header-btn header-btn--compact">
                            Advanced model tuning (expert)
                        </button>
                        <span style="font-size:0.85em; color:#4b5563; margin-left:8px;">See <a href="/method" class="link" style="text-decoration:underline;">methodology</a> for math</span>
                    </h4>
                    <div id="model-tuning-panel" class="additional-questions model-tuning-panel">
                        <p class="tuning-note">Fine-tune every coefficient, clamp, and question weight used in the hazard/compression model. Toggle questions off to remove them from calculations.</p>
                        <p class="tuning-note">
                            Note: Extreme inputs (i.e., 1-day doubling) are still gated by domain misalignment, task thresholds, hazard caps, and implementation delay. If you want fast-takeoff behavior, loosen these guards (lower thresholds/penalties, raise caps) and keep other sliders realistic.
                        </p>
                        <div class="tuning-actions" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
                            <button id="reset-model-tuning" class="tuning-action-btn">Reset to defaults</button>
                            <button id="apply-model-tuning" class="tuning-action-btn">Apply tuning</button>
                        </div>
                        <div class="tuning-presets" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                            <button class="tuning-preset-btn" id="preset-conservative" data-preset="conservative">Conservative</button>
                            <button class="tuning-preset-btn active" id="preset-baseline" data-preset="baseline">Baseline</button>
                            <button class="tuning-preset-btn" id="preset-fast" data-preset="fast">Fast-Takeoff</button>
                        </div>
                        <div id="model-tuning-form"></div>
                    </div>
            </div>
        </div>

        <!-- Hidden elements to prevent JS errors -->
        <div style="display:none;">
            <div id="personal-timeline"></div>
            <span id="insight-explicitness"></span>
            <span id="insight-theta"></span>
            <span id="insight-friction"></span>
            <span id="insight-alignment"></span>
        </div>

                </div>
            </div>
        </div>

    </main>

    <footer style="margin:48px 0 16px; text-align:center;">
        <div class="author-social">
            <a href="https://twitter.com/wrenclay" target="_blank" class="author-link">Twitter</a>
            <span class="social-divider">•</span>
            <a href="https://www.linkedin.com/in/clay-wren-13105b221/" target="_blank" class="author-link">LinkedIn</a>
        </div>
    </footer>

    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
    <script src="presets.js"></script>
    <script>
        // Category collapse/expand function
        function toggleCategory(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.category-toggle');
            content.classList.toggle('hidden');
            toggle.classList.toggle('open');
        }

        let selectedRole = null;
        let currentParams = null;
        let chart = null;

        const domainPaceSliderBaseline = 1.0;

        // Baseline timing offsets
        let BASELINE_PROGRESS = 1.0;  // multiplier for capability from elapsed time since SOTA release

        const QUESTION_LABELS = {
            Q1: 'Current AI Performance',
            Q2: 'Data Availability',
            Q3: 'Benchmark Clarity',
            Q4: 'Task Digitization',
            Q5: 'Task Decomposability',
            Q6: 'Task Standardization',
            Q7: 'Context Dependency',
            Q8: 'Feedback Loop Speed',
            Q9: 'Tacit Knowledge',
            Q10: 'Task Reallocation Risk',
            Q11: 'Human Judgment & Relationships',
            Q12: 'Physical Presence',
            Q13: 'Company AI Adoption Readiness',
            Q14: 'Labor Cost Pressure',
            Q15: 'Labor Market Tightness',
            Q16: 'IT Infrastructure',
            Q17: 'Skill Transferability',
            Q18: 'Adaptability/Learning',
            Q19: 'Job Performance'
        };
        const QUESTION_IDS = Object.keys(QUESTION_LABELS);
        const DOMAIN_PENALTY_BIAS = 1.20; // Slightly reduced baseline misalignment to tighten domain spread

        // METR-based capability model parameters
        const METR_DEFAULTS = {
            H50_0: 137,             // Baseline 50% task completion time in minutes (GPT-5, Aug 2025)
            H80_0: 26.372464,       // Baseline 80% reliability horizon in minutes (GPT-5, Aug 2025)
            D_months: 7,            // METR doubling time in months
            r_target: 0.95,         // Reliability target (95%)
            softness: 0.35,         // Logistic softness parameter [0.20, 0.55] (sharper gate to delay saturation)
            // Task duration buckets (minutes) and weights (sum to 1.0)
            // Calibrated for corporate production work (longer than METR's research environment)
            taskBuckets: [
                { L: 5,    w: 0.15 },   // <10min tasks
                { L: 30,   w: 0.30 },   // 10-45min tasks
                { L: 120,  w: 0.30 },   // 45-180min tasks
                { L: 360,  w: 0.15 },   // 3-8hr tasks
                { L: 720,  w: 0.10 }    // >12hr tasks
            ]
        };
        const DAYS_PER_MONTH = 30.4375; // Average days per month for calendar conversion
        let METR_DOUBLING_DAYS_DEFAULT = METR_DEFAULTS.D_months * DAYS_PER_MONTH; // Default doubling time in days (may be updated from METR data)
        let CURRENT_DOUBLING_DAYS = METR_DOUBLING_DAYS_DEFAULT;

        // Centralized, user-tunable model coefficients (defaults cloned on reset)
        const MODEL_DEFAULTS = {
            metr: {
                doublingDays: METR_DOUBLING_DAYS_DEFAULT
            },
            baseline: {
                thetaBaseEntry: 0.50,
                gammaBase: 8.0,
                h0: 0.015,
                kappa: 0.3,
                frictionValue: 3.0
            },
            hazardGates: {
                hAI: 0.45,
                gammaDefault: 8.0,
                hazardCap: 0.95,
                thetaClampMin: 0.50,
                thetaClampMax: 0.82,
                gammaClampMin: 3.0,
                gammaClampMax: 16.0,
                hazardFloor: 0.03
            },
            domainPenaltyClamp: { min: 0.8, max: 1.6 },
            thetaAdjustments: {
                alignmentShift: 0.09,
                explicitnessShift: 0.08
            },
            softness: {
                base: 0.35,
                senioritySlope: 0.03,
                q5Weight: 0.08,
                q6Weight: 0.05,
                min: 0.20,
                max: 0.55
            },
            taskAdjustmentWeights: {
                q5: 0.20,
                q6: 0.15,
                q7: 0.18
            },
            explicitnessWeights: {
                positive: 0.65,
                negative: -0.35,
                bias: 0.10
            },
            frictionDecayWeights: {
                base: 0.02,
                Q12: 0.01,
                Q15: 0.01,
                Q13: 0.005,
                Q14: 0.005,
                Q11: -0.01,
                Q10: -0.01,
                min: 0.005,
                max: 0.05
            },
            paceWeights: {
                accelerators: { Q2: 0.20, Q6: 0.10, Q8: 0.10, Q13: 0.15, Q16: 0.15 },
                frictions: { Q7: 0.18, Q9: 0.20, Q11: 0.24, Q12: 0.28 },
                min: 0.5,
                max: 2.0
            },
            delay: {
                base: 1.75,
                scale: 1.25,
                preShiftMin: 0.5,
                preShiftMax: 3.0,
                finalMin: 0.3,
                finalMax: 4.0,
                performanceSensitivity: 0.5,
                lambdaKnee: 0.025,
                lambdaSaturationBoost: 0.6,
                lambdaCapabilityGain: 0.8
            },
            questionWeights: {
                Q1:  { amp: +0.50 },
                Q2:  { amp: +0.40 },
                Q3:  { amp: +0.35 },
                Q4:  { amp: +0.55 },
                Q5:  { amp: +0.50 },
                Q6:  { amp: +0.45 },
                Q7:  { fric: -0.50 },
                Q8:  { amp: +0.45 },
                Q9:  { fric: -0.40 },
                Q11: { fric: -0.45 },
                Q12: { fric: -0.60 }
            },
            domainAlignmentWeights: {
                Q4: +0.20,
                Q5: +0.18,
                Q6: +0.16,
                Q7: -0.24,
                Q9: -0.22,
                Q11: -0.26,
                Q12: -0.28
            },
            implementationWeights: {
                Q13: +0.40,
                Q14: +0.30,
                Q15: -0.35,
                Q16: +0.35,
                Q19: -0.20
            },
            reemploymentWeights: {
                Q17: +0.50,
                Q18: +0.50,
                Q19: +0.30
            },
            reemploymentConfig: {
                base: 0.6,
                scale: 0.2,
                timingPenalties: { fast: 0.30, medium: 0.15, slow: 0.05 },
                timingThresholds: { fast: 3, medium: 7, slow: 12 },
                min: 0.1,
                max: 0.85
            },
            residualHumanFloor: 0.03,
            kWeights: {
                Q1: +0.20, Q2: +0.10, Q3: +0.10, Q4: +0.15, Q8: +0.12,
                Q5: -0.20, Q6: -0.20, Q7: -0.20, Q9: -0.15, Q10: -0.15, Q11: -0.15
            },
            compressionWeights: {
                reallocation: { Q10: 0.50, Q5: 0.18, Q6: 0.12, Q7: 0.08, Q9: 0.10, Q12: 0.02 },
                learnabilityDiscount: { context: 0.35, tacit: 0.30, variability: 0.20, customization: 0.15, min: 0.1 },
                amplificationFactor: 2.0,
                readinessMix: { immediate: 0.7, capability: 0.3 },
                capabilityGain: 1.1,
                gate: { hMax: 0.45, gamma: 6.0, theta: 0.33 },
                hierarchy: { min: 0.3, max: 1.0 },
                readinessFloor: 0.15
            },
            seniorityProfiles: [
                { label: 'Level 1: Many layers above',            thetaLift: -0.015, hazardShield: 0.00, delayShift: -0.10, reemploymentBoost: 1.00 },
                { label: 'Level 2: Several layers above',         thetaLift: 0.00,   hazardShield: 0.02, delayShift: -0.03, reemploymentBoost: 1.03 },
                { label: 'Level 3: Few above or mostly peers',    thetaLift: 0.020,  hazardShield: 0.04, delayShift:  0.06, reemploymentBoost: 1.05 },
                { label: 'Level 4: Top of domain',                thetaLift: 0.035,  hazardShield: 0.05, delayShift:  0.10, reemploymentBoost: 1.07 },
                { label: 'Level 5: Unique/irreplaceable owner',   thetaLift: 0.040,  hazardShield: 0.05, delayShift:  0.12, reemploymentBoost: 1.09 }
            ],
            seniorityTaskShifts: [
                [+0.12, +0.08, -0.05, -0.08, -0.07],
                [+0.05, +0.03, -0.02, -0.03, -0.03],
                [ 0.00,  0.00,  0.00,  0.00,  0.00],
                [-0.06, -0.04, +0.03, +0.04, +0.03],
                [-0.12, -0.09, +0.06, +0.08, +0.07]
            ],
            disabledQuestions: {}
        };
        const TUNING_PRESETS = {
            conservative() {
                const cfg = deepClone(MODEL_DEFAULTS);
                cfg.metr.doublingDays = METR_DOUBLING_DAYS_DEFAULT * 1.3; // slower growth
                cfg.hazardGates.hAI = 0.30;
                cfg.hazardGates.thetaClampMin = 0.60;
                cfg.hazardGates.thetaClampMax = 0.90;
                cfg.hazardGates.hazardCap = 0.85;
                cfg.softness.base = 0.40;
                cfg.softness.min = 0.25;
                cfg.softness.max = 0.65;
                cfg.delay.base = 2.25;
                cfg.delay.scale = 1.50;
                return cfg;
            },
            baseline() {
                return deepClone(MODEL_DEFAULTS);
            },
            fast() {
                const cfg = deepClone(MODEL_DEFAULTS);
                cfg.metr.doublingDays = METR_DOUBLING_DAYS_DEFAULT * 0.7; // faster growth
                cfg.hazardGates.hAI = 0.60;
                cfg.hazardGates.thetaClampMin = 0.40;
                cfg.hazardGates.thetaClampMax = 0.80;
                cfg.hazardGates.hazardCap = 0.99;
                cfg.softness.base = 0.25;
                cfg.softness.min = 0.18;
                cfg.softness.max = 0.50;
                cfg.delay.base = 1.00;
                cfg.delay.scale = 1.00;
                return cfg;
            }
        };

        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        let modelConfig = deepClone(MODEL_DEFAULTS);
        let THETA_BASE_ENTRY = modelConfig.baseline.thetaBaseEntry;
        let SENIORITY_PROFILES = deepClone(modelConfig.seniorityProfiles);
        let SENIORITY_TASK_SHIFTS = deepClone(modelConfig.seniorityTaskShifts);

        function syncModelStateFromConfig() {
            THETA_BASE_ENTRY = modelConfig.baseline.thetaBaseEntry;
            SENIORITY_PROFILES = deepClone(modelConfig.seniorityProfiles);
            SENIORITY_TASK_SHIFTS = deepClone(modelConfig.seniorityTaskShifts);
            METR_DEFAULTS.softness = modelConfig.softness.base;
            const days = resolvedDoublingDays();
            CURRENT_DOUBLING_DAYS = days;
            METR_DEFAULTS.D_months = days / DAYS_PER_MONTH;
            updateBaselineProgress();
            updateDoublingTimeUI();
        }

        const LOGIT_80 = Math.log(0.8 / 0.2);
        let METR_SIGMA = Math.log(METR_DEFAULTS.H80_0 / METR_DEFAULTS.H50_0) / LOGIT_80;
        function recomputeMETRSigma() {
            METR_SIGMA = Math.log(METR_DEFAULTS.H80_0 / METR_DEFAULTS.H50_0) / LOGIT_80;
        }
        const RELIABILITY_GUARD = 1e-6;

        function computeDoublingMonthsFromBenchmark(data) {
            if (!data || !data.results) return null;
            const entries = [];
            for (const [name, model] of Object.entries(data.results)) {
                const release = model.release_date;
                if (!release) continue;
                const dt = new Date(release);
                if (Number.isNaN(dt.getTime())) continue;
                const agent = model.agents ? Object.values(model.agents)[0] : null;
                if (!agent || !agent.is_sota) continue;
                const p50 = agent.p50_horizon_length?.estimate;
                if (!Number.isFinite(p50) || p50 <= 0) continue;
                entries.push({ date: dt, p50 });
            }
            if (entries.length < 2) return null;
            entries.sort((a, b) => a.date - b.date);
            const baseDate = entries[0].date.getTime();
            const monthsSinceBase = (d) => (d.getTime() - baseDate) / (1000 * 60 * 60 * 24 * 365.25) * 12;
            const xs = entries.map(e => monthsSinceBase(e.date));
            const ys = entries.map(e => Math.log2(e.p50));
            const xbar = xs.reduce((a, b) => a + b, 0) / xs.length;
            const ybar = ys.reduce((a, b) => a + b, 0) / ys.length;
            let num = 0, den = 0;
            for (let i = 0; i < xs.length; i++) {
                num += (xs[i] - xbar) * (ys[i] - ybar);
                den += Math.pow(xs[i] - xbar, 2);
            }
            if (den === 0) return null;
            const slope = num / den;
            if (slope <= 0) return null;
            return 1 / slope; // months per doubling
        }

        // Dynamic baseline date calculation
        let BASELINE_DATE = null;  // Will be set from SOTA model release date
        let BASELINE_YEAR_DECIMAL = null;  // Decimal year for calculations

        // Current date for calculations (user's access time)
        function getCurrentYearDecimal() {
            const now = new Date();
            const year = now.getFullYear();
            const start = new Date(year, 0, 1);
            const diff = now - start;
            const oneYear = 365.25 * 24 * 60 * 60 * 1000;
            return year + (diff / oneYear);
        }

        function resolvedDoublingDays() {
            const daysFromConfig = modelConfig?.metr?.doublingDays;
            if (Number.isFinite(daysFromConfig) && daysFromConfig > 0) return daysFromConfig;
            if (Number.isFinite(CURRENT_DOUBLING_DAYS) && CURRENT_DOUBLING_DAYS > 0) return CURRENT_DOUBLING_DAYS;
            return METR_DOUBLING_DAYS_DEFAULT;
        }

        function resolvedDoublingMonths() {
            return resolvedDoublingDays() / DAYS_PER_MONTH;
        }

        function updateBaselineProgress() {
            if (BASELINE_YEAR_DECIMAL === null) {
                BASELINE_PROGRESS = 1.0;
                return;
            }
            const deltaYears = Math.max(0, getCurrentYearDecimal() - BASELINE_YEAR_DECIMAL);
            const monthsElapsed = deltaYears * 12;
            const progress = Math.pow(2, monthsElapsed / resolvedDoublingMonths());
            BASELINE_PROGRESS = progress;
        }
        // Initialize derived state now that baseline variables are declared
        syncModelStateFromConfig();

        const BENCHMARK_FILE = 'benchmark_results.yaml';
        const USE_EMBEDDED_BENCHMARK = false;  // Set false to try loading from YAML first; falls back to embedded data

        // Embedded SOTA historical data for doubling time regression (extracted from benchmark_results.yaml)
        // Only includes models with is_sota: true, sorted by release date
        const EMBEDDED_SOTA_HISTORY = [
            { name: 'gpt2', release_date: '2019-02-14', p50: 0.039744, p80: 0.005646 },
            { name: 'davinci_002', release_date: '2020-05-28', p50: 0.148821, p80: 0.034119 },
            { name: 'gpt_3_5_turbo_instruct', release_date: '2022-03-15', p50: 0.604384, p80: 0.173085 },
            { name: 'gpt_4', release_date: '2023-03-14', p50: 5.364045, p80: 0.965175 },
            { name: 'gpt_4_1106', release_date: '2023-11-06', p50: 8.557433, p80: 1.453006 },
            { name: 'gpt_4o', release_date: '2024-05-13', p50: 9.17045, p80: 1.689572 },
            { name: 'claude_3_5_sonnet', release_date: '2024-06-20', p50: 18.216831, p80: 3.19928 },
            { name: 'o1_preview', release_date: '2024-09-12', p50: 22.095267, p80: 4.61942 },
            { name: 'claude_3_5_sonnet_20241022', release_date: '2024-10-22', p50: 28.983512, p80: 4.640773 },
            { name: 'o1_elicited', release_date: '2024-12-05', p50: 39.206576, p80: 5.973358 },
            { name: 'claude_3_7_sonnet', release_date: '2025-02-24', p50: 54.226342, p80: 15.156049 },
            { name: 'o3', release_date: '2025-04-16', p50: 92.179215, p80: 20.389159 },
            { name: 'grok_4', release_date: '2025-07-09', p50: 110.075251, p80: 14.91113 },
            { name: 'gpt_5', release_date: '2025-08-07', p50: 137.318539, p80: 26.372464 },
            { name: 'gpt_5_1_codex_max', release_date: '2025-11-19', p50: 161.753349, p80: 31.306248 }
        ];

        // Current SOTA for baseline capability (last entry in history)
        const EMBEDDED_SOTA = EMBEDDED_SOTA_HISTORY[EMBEDDED_SOTA_HISTORY.length - 1];

        // Compute doubling time from embedded SOTA history (used when YAML fetch fails)
        function computeDoublingMonthsFromEmbeddedHistory() {
            const entries = EMBEDDED_SOTA_HISTORY.map(m => ({
                date: new Date(m.release_date),
                p50: m.p50
            })).filter(e => e.p50 > 0);

            if (entries.length < 2) return null;
            entries.sort((a, b) => a.date - b.date);

            const baseDate = entries[0].date.getTime();
            const monthsSinceBase = (d) => (d.getTime() - baseDate) / (1000 * 60 * 60 * 24 * 365.25) * 12;
            const xs = entries.map(e => monthsSinceBase(e.date));
            const ys = entries.map(e => Math.log2(e.p50));

            const xbar = xs.reduce((a, b) => a + b, 0) / xs.length;
            const ybar = ys.reduce((a, b) => a + b, 0) / ys.length;
            let num = 0, den = 0;
            for (let i = 0; i < xs.length; i++) {
                num += (xs[i] - xbar) * (ys[i] - ybar);
                den += Math.pow(xs[i] - xbar, 2);
            }
            if (den === 0) return null;
            const slope = num / den;
            if (slope <= 0) return null;
            return 1 / slope; // months per doubling
        }

        // Load SOTA model from benchmark_results.yaml (or embedded data when fetch fails)
        async function loadBenchmarkData() {
            let data = null;
            let usingEmbedded = false;

            if (!USE_EMBEDDED_BENCHMARK) {
                try {
                    const resp = await fetch(encodeURI(BENCHMARK_FILE));
                    if (resp.ok) {
                        const yamlText = await resp.text();
                        data = jsyaml.load(yamlText);
                        console.log(`[Benchmark] Loaded YAML from ${BENCHMARK_FILE}`);
                    }
                } catch (e) {
                    console.warn(`[Benchmark] Fetch failed for ${BENCHMARK_FILE}:`, e.message || e);
                }
            }

            // Fall back to embedded data if fetch failed or was disabled
            if (!data || !data.results) {
                usingEmbedded = true;
                console.log('[Benchmark] Using embedded SOTA history data');
                // Convert embedded history to the same format as YAML data
                data = { results: {} };
                for (const m of EMBEDDED_SOTA_HISTORY) {
                    data.results[m.name] = {
                        release_date: m.release_date,
                        agents: {
                            default: {
                                p50_horizon_length: { estimate: m.p50 },
                                p80_horizon_length: { estimate: m.p80 },
                                is_sota: true
                            }
                        }
                    };
                }
            }

            // Find the SOTA model (latest is_sota by release date)
            let sotaModel = null;
            let sotaDate = null;
            for (const [modelName, modelData] of Object.entries(data.results)) {
                const releaseDate = modelData.release_date ? new Date(modelData.release_date) : null;
                const firstAgent = modelData.agents ? Object.values(modelData.agents)[0] : null;
                const isSota = firstAgent && firstAgent.is_sota;
                if (!releaseDate || !isSota) continue;
                if (!sotaDate || releaseDate > sotaDate) {
                    sotaModel = { name: modelName, ...modelData };
                    sotaDate = releaseDate;
                }
            }

            // If no is_sota flagged, pick latest by date as fallback
            if (!sotaModel) {
                for (const [modelName, modelData] of Object.entries(data.results)) {
                    const releaseDate = modelData.release_date ? new Date(modelData.release_date) : null;
                    if (!releaseDate) continue;
                    if (!sotaDate || releaseDate > sotaDate) {
                        sotaModel = { name: modelName, ...modelData };
                        sotaDate = releaseDate;
                    }
                }
            }

            if (sotaModel) {
                const agentData = Object.values(sotaModel.agents)[0];
                if (agentData.p50_horizon_length?.estimate) {
                    METR_DEFAULTS.H50_0 = agentData.p50_horizon_length.estimate;
                }
                if (agentData.p80_horizon_length?.estimate) {
                    METR_DEFAULTS.H80_0 = agentData.p80_horizon_length.estimate;
                }

                // Set baseline date
                BASELINE_DATE = sotaDate;
                const year = sotaDate.getFullYear();
                const start = new Date(year, 0, 1);
                const diff = sotaDate - start;
                const oneYear = 365.25 * 24 * 60 * 60 * 1000;
                BASELINE_YEAR_DECIMAL = year + (diff / oneYear);
                updateBaselineProgress();

                console.log(`[Benchmark] Loaded SOTA model: ${sotaModel.name}`);
                console.log(`[Benchmark] Release date: ${BASELINE_DATE.toISOString().split('T')[0]} (${BASELINE_YEAR_DECIMAL.toFixed(2)})`);
                console.log(`[Benchmark] H50: ${METR_DEFAULTS.H50_0.toFixed(2)} min, H80: ${METR_DEFAULTS.H80_0.toFixed(2)} min`);

                // Recalculate METR_SIGMA with new values
                recomputeMETRSigma();
                console.log(`[Benchmark] METR_SIGMA: ${METR_SIGMA.toFixed(4)}`);

                // Compute doubling time (use embedded history function if using embedded data)
                const computedDoubling = usingEmbedded
                    ? computeDoublingMonthsFromEmbeddedHistory()
                    : computeDoublingMonthsFromBenchmark(data);

                if (Number.isFinite(computedDoubling) && computedDoubling > 0) {
                    METR_DEFAULTS.D_months = computedDoubling;
                    METR_DOUBLING_DAYS_DEFAULT = METR_DEFAULTS.D_months * DAYS_PER_MONTH;
                    CURRENT_DOUBLING_DAYS = METR_DOUBLING_DAYS_DEFAULT;
                    MODEL_DEFAULTS.metr.doublingDays = METR_DOUBLING_DAYS_DEFAULT;
                    modelConfig.metr.doublingDays = METR_DOUBLING_DAYS_DEFAULT;
                    syncModelStateFromConfig();
                    console.log(`[Benchmark] Doubling time from METR data: ${METR_DEFAULTS.D_months.toFixed(2)} months`);
                } else {
                    console.log('[Benchmark] Doubling time fallback: using default 7 months (no slope computed)');
                }
                return true;
            } else {
                console.error('[Benchmark] No SOTA model found in data; using fallback baseline year');
                BASELINE_YEAR_DECIMAL = 2025.60;
                updateBaselineProgress();
                return false;
            }
        }

        // Get task weights for a given seniority level (1-5) and questionnaire answers
        function getTaskWeightsForSeniority(level, answers = null) {
            // Check if user has set custom weights and is in custom mode
            const isCustomMode = (currentParams && currentParams.taskBucketMode === 'custom');
            const userBase = (currentParams && Array.isArray(currentParams.userBaseWeights)) ? currentParams.userBaseWeights : null;

            // If in custom mode with valid user weights, return them exactly as-is (no shifts)
            if (isCustomMode && userBase && userBase.length === METR_DEFAULTS.taskBuckets.length) {
                // Normalize to ensure sum = 1.0 (in case user entered non-normalized values)
                const sum = userBase.reduce((a, b) => a + b, 0);
                if (sum > 0) {
                    const normalized = userBase.map(w => w / sum);
                    console.log('[TaskWeights] Custom mode: using exact user weights (no shifts):', normalized.map(v => v.toFixed(3)));
                    return normalized;
                }
            }

            // Auto mode: start with base weights (either user's or METR defaults)
            const baseWeights = (userBase && userBase.length === METR_DEFAULTS.taskBuckets.length)
                ? userBase
                : METR_DEFAULTS.taskBuckets.map(b => b.w);
            const idx = Math.max(0, Math.min(SENIORITY_TASK_SHIFTS.length - 1, level - 1));
            const seniorityShift = SENIORITY_TASK_SHIFTS[idx];

            // Start with seniority-based shift
            let adjusted = baseWeights.map((w, i) => w + seniorityShift[i]);

            // Apply questionnaire-based adjustments if answers provided
            if (answers) {
                const q5 = getAnswerValue(answers, 'Q5');  // Task decomposability
                const q6 = getAnswerValue(answers, 'Q6');  // Standardization
                const q7 = getAnswerValue(answers, 'Q7');  // Context dependency

                // Q5: Decomposability (1=complex/holistic, 5=highly decomposable)
                // High decomposability → more short tasks
                const q5Shift = (norm(q5) - 0.5) * modelConfig.taskAdjustmentWeights.q5;  // -0.10 to +0.10
                adjusted[0] += q5Shift;      // <5min
                adjusted[1] += q5Shift * 0.5;
                adjusted[3] -= q5Shift * 0.5;
                adjusted[4] -= q5Shift;      // >9hr

                // Q6: Standardization (1=bespoke, 5=standardized)
                // High standardization → more short tasks
                const q6Shift = (norm(q6) - 0.5) * modelConfig.taskAdjustmentWeights.q6;  // -0.075 to +0.075
                adjusted[0] += q6Shift;
                adjusted[1] += q6Shift * 0.5;
                adjusted[3] -= q6Shift * 0.5;
                adjusted[4] -= q6Shift;

                // Q7: Context dependency (1=low context, 5=high context)
                // High context → more long tasks (harder to automate in pieces)
                const q7Shift = (norm(q7) - 0.5) * modelConfig.taskAdjustmentWeights.q7;  // -0.09 to +0.09
                adjusted[0] -= q7Shift;      // <5min
                adjusted[1] -= q7Shift * 0.6;
                adjusted[2] += q7Shift * 0.3;
                adjusted[3] += q7Shift * 0.6;
                adjusted[4] += q7Shift;      // >9hr
            }

            // Ensure all weights are non-negative
            adjusted = adjusted.map(w => Math.max(0.01, w));

            // Normalize to sum to 1.0
            const sum = adjusted.reduce((a, b) => a + b, 0);
            return adjusted.map(w => w / sum);
        }

        // Get softness parameter for a given seniority level and answers
        // Higher seniority and complex tasks → smoother transitions (higher softness)
        function getSoftnessForSeniority(level, answers = null) {
            const baseSoftness = modelConfig.softness.base;

            // Seniority effect: entry-level sharper gates, senior smoother gates
            const seniorityAdjust = (level - 3) * modelConfig.softness.senioritySlope;  // Range: -0.06 (entry) to +0.06 (exec)

            let questionAdjust = 0;
            if (answers) {
                const q5 = getAnswerValue(answers, 'Q5');
                const q6 = getAnswerValue(answers, 'Q6');

                // Complex, bespoke tasks → smoother gates (less sharp transitions)
                questionAdjust = (0.5 - norm(q5)) * modelConfig.softness.q5Weight +
                                 (0.5 - norm(q6)) * modelConfig.softness.q6Weight;
            }

            return clamp(baseSoftness + seniorityAdjust + questionAdjust, modelConfig.softness.min, modelConfig.softness.max);
        }

        function clamp(value, min = 0, max = 1) {
            return Math.min(max, Math.max(min, value));
        }

        function isQuestionEnabled(qid) {
            return !(modelConfig.disabledQuestions && modelConfig.disabledQuestions[qid]);
        }

        function getAnswerValue(answers, qid, fallback = 3) {
            if (!isQuestionEnabled(qid)) return fallback;
            const raw = answers && typeof answers[qid] === 'number' ? answers[qid] : fallback;
            return raw;
        }

        function getConfigValue(path, fallback = '') {
            if (!path) return fallback;
            const parts = path.split('.');
            let val = modelConfig;
            for (const part of parts) {
                const key = Number.isNaN(Number(part)) ? part : Number(part);
                if (val && Object.prototype.hasOwnProperty.call(val, key)) {
                    val = val[key];
                } else {
                    return fallback;
                }
            }
            return val ?? fallback;
        }

        function setConfigValue(path, value) {
            if (!path) return;
            const parts = path.split('.');
            let obj = modelConfig;
            for (let i = 0; i < parts.length - 1; i++) {
                const key = Number.isNaN(Number(parts[i])) ? parts[i] : Number(parts[i]);
                const nextKey = Number.isNaN(Number(parts[i + 1])) ? parts[i + 1] : Number(parts[i + 1]);
                if (!Object.prototype.hasOwnProperty.call(obj, key) || obj[key] === null) {
                    obj[key] = Number.isNaN(Number(nextKey)) ? {} : [];
                }
                obj = obj[key];
            }
            const lastKey = Number.isNaN(Number(parts[parts.length - 1])) ? parts[parts.length - 1] : Number(parts[parts.length - 1]);
            obj[lastKey] = value;
        }

        function onModelConfigChange({ rerunAnalysis = true } = {}) {
            syncModelStateFromConfig();
            if (rerunAnalysis) {
                if (!selectedRole) {
                    // Ensure a role is set so updates (like doubling time) always re-run
                    selectedRole = 'custom';
                }
                analyzeRole();
                try { initTaskBucketEditor(); } catch (e) {}
            }
        }

        function toScore(raw) {
            if (typeof raw !== 'number' || Number.isNaN(raw)) return 2;
            if (raw >= 1 && raw <= 5) {
                return Math.max(0, Math.min(4, raw - 1));
            }
            return Math.max(0, Math.min(4, raw));
        }

        function norm(value) {
            return clamp(toScore(value) / 4, 0, 1);
        }

        function avg(questionKeys, answers) {
            if (!Array.isArray(questionKeys) || questionKeys.length === 0) {
                return 2;
            }
            const enabledKeys = questionKeys.filter(isQuestionEnabled);
            if (enabledKeys.length === 0) {
                return 2;
            }
            const total = enabledKeys.reduce((sum, key) => {
                const val = getAnswerValue(answers, key);
                return sum + toScore(val);
            }, 0);
            return total / enabledKeys.length;
        }

        function inferredExplicitness(answers) {
            const sPos = avg(['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q8'], answers);
            const sNeg = avg(['Q7', 'Q9'], answers);
            const w = modelConfig.explicitnessWeights;
            return clamp((w.positive * norm(sPos)) + (w.negative * norm(sNeg)) + w.bias, 0, 1);
        }

        function inferredFrictionDecay(answers) {
            const get = (key) => getAnswerValue(answers, key);
            const w = modelConfig.frictionDecayWeights;
            let lam = w.base;
            lam += w.Q12 * (norm(get('Q12')) - 0.5);
            lam += w.Q15 * (norm(get('Q15')) - 0.5);
            lam += w.Q13 * (norm(get('Q13')) - 0.5);
            lam += w.Q14 * (norm(get('Q14')) - 0.5);
            lam += w.Q11 * (norm(get('Q11')) - 0.5);
            lam += w.Q10 * (norm(get('Q10')) - 0.5);
            return clamp(lam, w.min, w.max);
        }

        function inferredPace(answers) {
            // Map questionnaire responses into a METR pace multiplier.
            const get = (key) => getAnswerValue(answers, key);
            const normDiff = (key) => norm(get(key)) - 0.5;

            let pace = 1.0;

            const acceleratorWeights = modelConfig.paceWeights.accelerators;
            const frictionWeights = modelConfig.paceWeights.frictions;

            for (const [key, weight] of Object.entries(acceleratorWeights)) {
                pace -= weight * normDiff(key);
            }

            for (const [key, weight] of Object.entries(frictionWeights)) {
                pace += weight * normDiff(key);
            }

            return clamp(pace, modelConfig.paceWeights.min, modelConfig.paceWeights.max);
        }

        function resolvedDomainPace() {
            const slider = document.getElementById('industry-pace');
            // Slider now represents friction (1.0 to 2.0, default 1.0)
            // Higher friction = slower automation (software = 1.0, nothing is easier)
            const frictionValue = slider ? parseFloat(slider.value) : domainPaceSliderBaseline;
            const normalized = frictionValue / domainPaceSliderBaseline;
            const base = currentParams && typeof currentParams.domainPace === 'number'
                ? currentParams.domainPace
                : 1.0;
            const combined = base * normalized;
            return clamp(combined, 1.0, 3.0);
        }

        function resolvedReliabilityTarget() {
            const slider = document.getElementById('ai-reliability');
            if (slider) {
                const percentValue = parseInt(slider.value); // 50-99
                return percentValue / 100.0; // Convert to 0.50-0.99
            }
            return METR_DEFAULTS.r_target; // Default 0.95
        }

        function updateDoublingTimeUI() {
            const note = document.getElementById('doubling-days-note');
            if (!note) return;
            const days = resolvedDoublingDays();
            const months = resolvedDoublingMonths();
            note.textContent = `${days.toFixed(0)}d (~${months.toFixed(2)} mo)`;
        }


        // Advanced tuning UI builders (populated on load)
        function renderModelTuningUI() {
            const form = document.getElementById('model-tuning-form');
            if (!form) return;

            const fmt = (v) => (v === undefined || v === null ? '' : v);
            const buildWeightTable = (weights, prefix, labelMap = QUESTION_LABELS) => {
                return Object.keys(weights)
                    .sort((a, b) => a.localeCompare(b))
                    .map(key => {
                        const label = labelMap[key] || key;
                        return `<tr>
                            <td>${key}: ${label}</td>
                            <td><input type="number" step="0.01" data-config-path="${prefix}.${key}" value="${fmt(weights[key])}"></td>
                        </tr>`;
                    }).join('');
            };

            const hazardRows = QUESTION_IDS.map(qid => {
                const w = modelConfig.questionWeights[qid] || {};
                const label = QUESTION_LABELS[qid] || qid;
                return `<tr>
                    <td>${qid}: ${label}</td>
                    <td><input type="number" step="0.01" data-config-path="questionWeights.${qid}.amp" value="${fmt(w.amp)}"></td>
                    <td><input type="number" step="0.01" data-config-path="questionWeights.${qid}.fric" value="${fmt(w.fric)}"></td>
                </tr>`;
            }).join('');

            const implementationRows = buildWeightTable(modelConfig.implementationWeights, 'implementationWeights');
            const reemploymentRows = buildWeightTable(modelConfig.reemploymentWeights, 'reemploymentWeights');
            const kRows = buildWeightTable(modelConfig.kWeights, 'kWeights');

            const compCfg = modelConfig.compressionWeights;
            const compressionReallocRows = buildWeightTable(compCfg.reallocation, 'compressionWeights.reallocation');
            const compressionLearnRows = ['context', 'tacit', 'variability', 'customization'].map(key => `
                <tr>
                    <td>${key}</td>
                    <td><input type="number" step="0.01" data-config-path="compressionWeights.learnabilityDiscount.${key}" value="${fmt(compCfg.learnabilityDiscount[key])}"></td>
                </tr>
            `).join('');

            const questionToggles = QUESTION_IDS.map(qid => {
                const checked = !(modelConfig.disabledQuestions && modelConfig.disabledQuestions[qid]);
                return `<label class="tuning-toggle">
                    <input type="checkbox" data-question-toggle="${qid}" ${checked ? 'checked' : ''}>
                    ${qid}: ${QUESTION_LABELS[qid] || ''}
                </label>`;
            }).join('');

            const seniorityRows = modelConfig.seniorityProfiles.map((profile, idx) => `
                <tr>
                    <td>${profile.label || 'Level ' + (idx + 1)}</td>
                    <td><input type="number" step="0.01" data-config-path="seniorityProfiles.${idx}.thetaLift" value="${fmt(profile.thetaLift)}"></td>
                    <td><input type="number" step="0.01" data-config-path="seniorityProfiles.${idx}.hazardShield" value="${fmt(profile.hazardShield)}"></td>
                    <td><input type="number" step="0.01" data-config-path="seniorityProfiles.${idx}.delayShift" value="${fmt(profile.delayShift)}"></td>
                    <td><input type="number" step="0.01" data-config-path="seniorityProfiles.${idx}.reemploymentBoost" value="${fmt(profile.reemploymentBoost)}"></td>
                </tr>
            `).join('');

            const bucketLabels = METR_DEFAULTS.taskBuckets.map(b => b.L);
            const taskShiftRows = modelConfig.seniorityTaskShifts.map((row, idx) => `
                <tr>
                    <td>Level ${idx + 1}</td>
                    ${row.map((val, j) => `<td><input type="number" step="0.01" data-config-path="seniorityTaskShifts.${idx}.${j}" value="${fmt(val)}"></td>`).join('')}
                </tr>
            `).join('');

            form.innerHTML = `
                <div class="tuning-grid">
                    <div class="tuning-card">
                        <h5>Baseline & Gates</h5>
                        <div class="tuning-field">
                            <label>θ base (entry)</label>
                            <input type="number" step="0.01" data-config-path="baseline.thetaBaseEntry" value="${fmt(modelConfig.baseline.thetaBaseEntry)}">
                        </div>
                        <div class="tuning-field">
                            <label>h0 (baseline hazard)</label>
                            <input type="number" step="0.001" data-config-path="baseline.h0" value="${fmt(modelConfig.baseline.h0)}">
                        </div>
                        <div class="tuning-field">
                            <label>γ base (steepness)</label>
                            <input type="number" step="0.1" data-config-path="baseline.gammaBase" value="${fmt(modelConfig.baseline.gammaBase)}">
                        </div>
                        <div class="tuning-field">
                            <label>κ (friction damping)</label>
                            <input type="number" step="0.01" data-config-path="baseline.kappa" value="${fmt(modelConfig.baseline.kappa)}">
                        </div>
                        <div class="tuning-field">
                            <label>Baseline friction value</label>
                            <input type="number" step="0.1" data-config-path="baseline.frictionValue" value="${fmt(modelConfig.baseline.frictionValue)}">
                        </div>
                        <div class="tuning-field">
                            <label>h<sub>AI</sub> max</label>
                            <input type="number" step="0.01" data-config-path="hazardGates.hAI" value="${fmt(modelConfig.hazardGates.hAI)}">
                        </div>
                        <div class="tuning-field">
                            <label>Hazard cap</label>
                            <input type="number" step="0.01" data-config-path="hazardGates.hazardCap" value="${fmt(modelConfig.hazardGates.hazardCap)}">
                        </div>
                        <div class="tuning-field">
                            <label>Doubling time (days)</label>
                            <div class="tuning-split-2" style="align-items:center;">
                                <input type="number" min="1" step="1" data-config-path="metr.doublingDays" value="${fmt(modelConfig.metr.doublingDays)}">
                                <span id="doubling-days-note" style="font-size:0.85em; color:#4b5563;">${resolvedDoublingMonths().toFixed(2)} mo</span>
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>θ clamp (min/max)</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="hazardGates.thetaClampMin" value="${fmt(modelConfig.hazardGates.thetaClampMin)}">
                                <input type="number" step="0.01" data-config-path="hazardGates.thetaClampMax" value="${fmt(modelConfig.hazardGates.thetaClampMax)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>γ clamp (min/max)</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.1" data-config-path="hazardGates.gammaClampMin" value="${fmt(modelConfig.hazardGates.gammaClampMin)}">
                                <input type="number" step="0.1" data-config-path="hazardGates.gammaClampMax" value="${fmt(modelConfig.hazardGates.gammaClampMax)}">
                            </div>
                        </div>
                    </div>

                    <div class="tuning-card">
                        <h5>Softness, Theta Shifts & Delay</h5>
                        <div class="tuning-field">
                            <label>Softness base / slope (per seniority)</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="softness.base" value="${fmt(modelConfig.softness.base)}">
                                <input type="number" step="0.01" data-config-path="softness.senioritySlope" value="${fmt(modelConfig.softness.senioritySlope)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Softness bounds</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="softness.min" value="${fmt(modelConfig.softness.min)}">
                                <input type="number" step="0.01" data-config-path="softness.max" value="${fmt(modelConfig.softness.max)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Softness weights (Q5/Q6)</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="softness.q5Weight" value="${fmt(modelConfig.softness.q5Weight)}">
                                <input type="number" step="0.01" data-config-path="softness.q6Weight" value="${fmt(modelConfig.softness.q6Weight)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>θ adjustments (alignment / explicitness)</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="thetaAdjustments.alignmentShift" value="${fmt(modelConfig.thetaAdjustments.alignmentShift)}">
                                <input type="number" step="0.01" data-config-path="thetaAdjustments.explicitnessShift" value="${fmt(modelConfig.thetaAdjustments.explicitnessShift)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Task bucket adjustments (Q5/Q6/Q7)</label>
                            <div class="tuning-split-3">
                                <input type="number" step="0.01" data-config-path="taskAdjustmentWeights.q5" value="${fmt(modelConfig.taskAdjustmentWeights.q5)}">
                                <input type="number" step="0.01" data-config-path="taskAdjustmentWeights.q6" value="${fmt(modelConfig.taskAdjustmentWeights.q6)}">
                                <input type="number" step="0.01" data-config-path="taskAdjustmentWeights.q7" value="${fmt(modelConfig.taskAdjustmentWeights.q7)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Delay (base / scale)</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="delay.base" value="${fmt(modelConfig.delay.base)}">
                                <input type="number" step="0.01" data-config-path="delay.scale" value="${fmt(modelConfig.delay.scale)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Delay clamps (pre-shift / final)</label>
                            <div class="tuning-split-4">
                                <input type="number" step="0.01" data-config-path="delay.preShiftMin" value="${fmt(modelConfig.delay.preShiftMin)}">
                                <input type="number" step="0.01" data-config-path="delay.preShiftMax" value="${fmt(modelConfig.delay.preShiftMax)}">
                                <input type="number" step="0.01" data-config-path="delay.finalMin" value="${fmt(modelConfig.delay.finalMin)}">
                                <input type="number" step="0.01" data-config-path="delay.finalMax" value="${fmt(modelConfig.delay.finalMax)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Delay performance sensitivity</label>
                            <input type="number" step="0.01" data-config-path="delay.performanceSensitivity" value="${fmt(modelConfig.delay.performanceSensitivity)}">
                        </div>
                    </div>

                    <div class="tuning-card">
                        <h5>Inference Weights</h5>
                        <div class="tuning-field">
                            <label>Explicitness weights (positive / negative / bias)</label>
                            <div class="tuning-split-3">
                                <input type="number" step="0.01" data-config-path="explicitnessWeights.positive" value="${fmt(modelConfig.explicitnessWeights.positive)}">
                                <input type="number" step="0.01" data-config-path="explicitnessWeights.negative" value="${fmt(modelConfig.explicitnessWeights.negative)}">
                                <input type="number" step="0.01" data-config-path="explicitnessWeights.bias" value="${fmt(modelConfig.explicitnessWeights.bias)}">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Friction decay weights</label>
                            <div class="tuning-split-3">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.base" value="${fmt(modelConfig.frictionDecayWeights.base)}">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.min" value="${fmt(modelConfig.frictionDecayWeights.min)}">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.max" value="${fmt(modelConfig.frictionDecayWeights.max)}">
                            </div>
                            <div class="tuning-split-3" style="margin-top:6px;">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.Q10" value="${fmt(modelConfig.frictionDecayWeights.Q10)}" placeholder="Q10">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.Q11" value="${fmt(modelConfig.frictionDecayWeights.Q11)}" placeholder="Q11">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.Q12" value="${fmt(modelConfig.frictionDecayWeights.Q12)}" placeholder="Q12">
                            </div>
                            <div class="tuning-split-3" style="margin-top:6px;">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.Q13" value="${fmt(modelConfig.frictionDecayWeights.Q13)}" placeholder="Q13">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.Q14" value="${fmt(modelConfig.frictionDecayWeights.Q14)}" placeholder="Q14">
                                <input type="number" step="0.001" data-config-path="frictionDecayWeights.Q15" value="${fmt(modelConfig.frictionDecayWeights.Q15)}" placeholder="Q15">
                            </div>
                        </div>
                        <div class="tuning-field">
                            <label>Pace weights (accelerators)</label>
                            ${Object.entries(modelConfig.paceWeights.accelerators).map(([qid, weight]) => `<div style="display:flex; gap:8px; align-items:center;">
                                <span style="min-width:38px;">${qid}</span>
                                <input type="number" step="0.01" data-config-path="paceWeights.accelerators.${qid}" value="${fmt(weight)}">
                            </div>`).join('')}
                        </div>
                        <div class="tuning-field">
                            <label>Pace weights (frictions)</label>
                            ${Object.entries(modelConfig.paceWeights.frictions).map(([qid, weight]) => `<div style="display:flex; gap:8px; align-items:center;">
                                <span style="min-width:38px;">${qid}</span>
                                <input type="number" step="0.01" data-config-path="paceWeights.frictions.${qid}" value="${fmt(weight)}">
                            </div>`).join('')}
                        </div>
                        <div class="tuning-field">
                            <label>Pace bounds</label>
                            <div class="tuning-split-2">
                                <input type="number" step="0.01" data-config-path="paceWeights.min" value="${fmt(modelConfig.paceWeights.min)}">
                                <input type="number" step="0.01" data-config-path="paceWeights.max" value="${fmt(modelConfig.paceWeights.max)}">
                            </div>
                        </div>
                    </div>

                    <div class="tuning-card" style="grid-column: span 2;">
                        <h5>Question toggles</h5>
                        <div class="tuning-checkbox-grid">
                            ${questionToggles}
                        </div>
                    </div>

                    <div class="tuning-card" style="grid-column: span 2;">
                        <h5>Hazard question weights (amp/friction)</h5>
                        <table class="tuning-table">
                            <thead>
                                <tr><th>Question</th><th>Amp (+)</th><th>Fric (-)</th></tr>
                            </thead>
                            <tbody>${hazardRows}</tbody>
                        </table>
                    </div>

                    <div class="tuning-card">
                        <h5>Domain alignment weights</h5>
                        <table class="tuning-table">
                            <thead><tr><th>Question</th><th>Weight</th></tr></thead>
                            <tbody>${buildWeightTable(modelConfig.domainAlignmentWeights, 'domainAlignmentWeights')}</tbody>
                        </table>
                    </div>

                    <div class="tuning-card">
                        <h5>Implementation delay weights</h5>
                        <table class="tuning-table">
                            <thead><tr><th>Question</th><th>Weight</th></tr></thead>
                            <tbody>${implementationRows}</tbody>
                        </table>
                        <div class="tuning-field" style="margin-top:8px;">
                            <label>Re-employment timing penalties (fast / medium / slow)</label>
                            <div class="tuning-split-3">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.timingPenalties.fast" value="${fmt(modelConfig.reemploymentConfig.timingPenalties.fast)}">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.timingPenalties.medium" value="${fmt(modelConfig.reemploymentConfig.timingPenalties.medium)}">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.timingPenalties.slow" value="${fmt(modelConfig.reemploymentConfig.timingPenalties.slow)}">
                            </div>
                        </div>
                        <div class="tuning-field" style="margin-top:8px;">
                            <label>Timing thresholds (years)</label>
                            <div class="tuning-split-3">
                                <input type="number" step="0.1" data-config-path="reemploymentConfig.timingThresholds.fast" value="${fmt(modelConfig.reemploymentConfig.timingThresholds.fast)}">
                                <input type="number" step="0.1" data-config-path="reemploymentConfig.timingThresholds.medium" value="${fmt(modelConfig.reemploymentConfig.timingThresholds.medium)}">
                                <input type="number" step="0.1" data-config-path="reemploymentConfig.timingThresholds.slow" value="${fmt(modelConfig.reemploymentConfig.timingThresholds.slow)}">
                            </div>
                        </div>
                    </div>

                    <div class="tuning-card">
                        <h5>Re-employment & K weights</h5>
                        <table class="tuning-table">
                            <thead><tr><th>Re-employment question</th><th>Weight</th></tr></thead>
                            <tbody>${reemploymentRows}</tbody>
                        </table>
                        <div class="tuning-field" style="margin-top:8px;">
                            <label>Re-employment base / scale / bounds</label>
                            <div class="tuning-split-4">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.base" value="${fmt(modelConfig.reemploymentConfig.base)}">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.scale" value="${fmt(modelConfig.reemploymentConfig.scale)}">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.min" value="${fmt(modelConfig.reemploymentConfig.min)}">
                                <input type="number" step="0.01" data-config-path="reemploymentConfig.max" value="${fmt(modelConfig.reemploymentConfig.max)}">
                            </div>
                        </div>
                        <h5 style="margin-top:12px;">k (steepness shift) weights</h5>
                        <table class="tuning-table">
                            <thead><tr><th>Question</th><th>Weight</th></tr></thead>
                            <tbody>${kRows}</tbody>
                        </table>
                    </div>

                        <div class="tuning-card" style="grid-column: span 2;">
                        <h5>Compression weights</h5>
                        <div class="tuning-grid tuning-subgrid">
                            <div class="tuning-card" style="box-shadow:none; border-color:#e5e7eb;">
                                <h5 style="margin-bottom:6px;">Reallocation</h5>
                                <table class="tuning-table">
                                    <thead><tr><th>Question</th><th>Weight</th></tr></thead>
                                    <tbody>${compressionReallocRows}</tbody>
                                </table>
                            </div>
                            <div class="tuning-card" style="box-shadow:none; border-color:#e5e7eb;">
                                <h5 style="margin-bottom:6px;">Learnability discount</h5>
                                <table class="tuning-table">
                                    <thead><tr><th>Factor</th><th>Weight</th></tr></thead>
                                    <tbody>${compressionLearnRows}</tbody>
                                </table>
                                <div class="tuning-field" style="margin-top:8px;">
                                    <label>Learnability floor</label>
                                    <input type="number" step="0.01" data-config-path="compressionWeights.learnabilityDiscount.min" value="${fmt(compCfg.learnabilityDiscount.min)}">
                                </div>
                            </div>
                            <div class="tuning-card" style="box-shadow:none; border-color:#e5e7eb;">
                                <h5 style="margin-bottom:6px;">Gates</h5>
                                <div class="tuning-field">
                                    <label>Amplification factor</label>
                                    <input type="number" step="0.1" data-config-path="compressionWeights.amplificationFactor" value="${fmt(compCfg.amplificationFactor)}">
                                </div>
                                <div class="tuning-field">
                                    <label>Readiness mix (immediate / capability)</label>
                                    <div class="tuning-split-2">
                                        <input type="number" step="0.01" data-config-path="compressionWeights.readinessMix.immediate" value="${fmt(compCfg.readinessMix.immediate)}">
                                        <input type="number" step="0.01" data-config-path="compressionWeights.readinessMix.capability" value="${fmt(compCfg.readinessMix.capability)}">
                                    </div>
                                </div>
                                <div class="tuning-field">
                                    <label>Compression gate (hmax / gamma / theta)</label>
                                    <div class="tuning-split-3">
                                        <input type="number" step="0.01" data-config-path="compressionWeights.gate.hMax" value="${fmt(compCfg.gate.hMax)}">
                                        <input type="number" step="0.1" data-config-path="compressionWeights.gate.gamma" value="${fmt(compCfg.gate.gamma)}">
                                        <input type="number" step="0.01" data-config-path="compressionWeights.gate.theta" value="${fmt(compCfg.gate.theta)}">
                                    </div>
                                </div>
                                <div class="tuning-field">
                                    <label>Hierarchy vulnerability (min / max)</label>
                                    <div class="tuning-split-2">
                                        <input type="number" step="0.01" data-config-path="compressionWeights.hierarchy.min" value="${fmt(compCfg.hierarchy.min)}">
                                        <input type="number" step="0.01" data-config-path="compressionWeights.hierarchy.max" value="${fmt(compCfg.hierarchy.max)}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tuning-card" style="grid-column: span 2;">
                        <h5>Seniority profiles</h5>
                        <table class="tuning-table">
                            <thead>
                                <tr>
                                    <th>Level</th><th>θ lift</th><th>Hazard shield</th><th>Delay shift</th><th>Re-employment boost</th>
                                </tr>
                            </thead>
                            <tbody>${seniorityRows}</tbody>
                        </table>
                        <h5 style="margin-top:12px;">Seniority task weight shifts (per bucket)</h5>
                        <table class="tuning-table">
                            <thead>
                                <tr><th>Level</th>${bucketLabels.map(L => `<th>L=${L}</th>`).join('')}</tr>
                            </thead>
                            <tbody>${taskShiftRows}</tbody>
                        </table>
                    </div>
                </div>
            `;

            updateDoublingTimeUI();
            bindModelTuningInputs();
            bindQuestionToggles();
        }
        function bindModelTuningInputs() {
            document.querySelectorAll('[data-config-path]').forEach(input => {
                const path = input.dataset.configPath;
                const type = input.dataset.configType || 'number';
                const currentVal = getConfigValue(path, '');
                if (type === 'checkbox') {
                    input.checked = Boolean(currentVal);
                } else if (currentVal !== '' || currentVal === 0) {
                    input.value = currentVal;
                }

                input.onchange = () => {
                    let parsed;
                    if (type === 'checkbox') {
                        parsed = input.checked;
                    } else if (type === 'integer') {
                        const n = parseInt(input.value, 10);
                        parsed = Number.isFinite(n) ? n : 0;
                    } else {
                        const n = parseFloat(input.value);
                        parsed = Number.isFinite(n) ? n : 0;
                    }
                    setConfigValue(path, parsed);
                    onModelConfigChange();
                };
                // Live-update numeric inputs as the user types so doubling time applies immediately
                if (input.type === 'number') {
                    input.oninput = input.onchange;
                }
            });
        }

        function bindQuestionToggles() {
            document.querySelectorAll('[data-question-toggle]').forEach(box => {
                const qid = box.dataset.questionToggle;
                box.onchange = () => {
                    if (!qid) return;
                    if (!box.checked) {
                        modelConfig.disabledQuestions[qid] = true;
                    } else {
                        delete modelConfig.disabledQuestions[qid];
                    }
                    onModelConfigChange();
                };
            });
        }

        function setPresetActive(name) {
            document.querySelectorAll('.tuning-preset-btn').forEach(btn => {
                const preset = btn.dataset.preset;
                if (preset === name) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        function applyTuningPreset(name) {
            const builder = TUNING_PRESETS[name];
            if (!builder) return;
            modelConfig = builder();
            onModelConfigChange();
            renderModelTuningUI();
            setPresetActive(name);
        }

        function resetModelTuning() {
            modelConfig = deepClone(MODEL_DEFAULTS);
            onModelConfigChange();
            renderModelTuningUI();
            setPresetActive('baseline');
        }

        function initModelTuningPanel() {
            const panel = document.getElementById('model-tuning-panel');
            const toggleBtn = document.getElementById('toggle-model-tuning');
            const resetBtn = document.getElementById('reset-model-tuning');
            const applyBtn = document.getElementById('apply-model-tuning');
            const presetConservative = document.getElementById('preset-conservative');
            const presetBaseline = document.getElementById('preset-baseline');
            const presetFast = document.getElementById('preset-fast');
            if (!panel) return;

            renderModelTuningUI();

            toggleBtn && (toggleBtn.onclick = () => {
                panel.classList.toggle('expanded');
            });

            resetBtn && (resetBtn.onclick = () => {
                resetModelTuning();
            });

            applyBtn && (applyBtn.onclick = () => {
                onModelConfigChange();
            });

            presetConservative && (presetConservative.onclick = () => applyTuningPreset('conservative'));
            presetBaseline && (presetBaseline.onclick = () => applyTuningPreset('baseline'));
            presetFast && (presetFast.onclick = () => applyTuningPreset('fast'));
            setPresetActive('baseline');
        }


        // METR-based capability functions

        // Reliability adjustment factor fitted to METR empirical data (logistic calibration)
        // Uses f(r) = exp(-σ · logit(r)) where logit(r) = ln(r/(1-r))
        // σ is calibrated from METR's H50_0/H80_0 ratio (137/26.37 ≈ 5.19×)
        // Examples: f(0.50)=1.0×, f(0.80)≈5.2×, f(0.95)≈33.1×, f(0.99)≈235×
        // We DIVIDE H by f(r), so higher reliability → lower H → AI can only handle shorter tasks
        function reliabilityFactor(r) {
            const lower = 0.5 + RELIABILITY_GUARD;
            const upper = 0.99 - RELIABILITY_GUARD;
            const target = clamp(r, lower, upper);
            const odds = target / (1 - target);
            const logit = Math.log(odds);
            return Math.exp(-METR_SIGMA * logit);
        }

        // METR capability: H_r(t) = (H50_0 * 2^(months_elapsed / D_eff)) / f(r)
        // Returns maximum human-equivalent task length (in minutes) AI can handle at time t with reliability r
        // Higher H = better AI (can handle longer/harder tasks that take humans more time)
        // As time progresses, H increases (AI improves and tackles longer tasks)
        // Higher reliability requirement → larger f(r) → lower H → can only automate shorter tasks
        // Lower reliability requirement → smaller f(r) → higher H → can automate longer tasks
        function H_r(tYears, H50_0 = METR_DEFAULTS.H50_0, r = null) {
            const D_months = resolvedDoublingMonths();
            const reliability = r !== null ? r : resolvedReliabilityTarget();

            // Apply historical progress since SOTA release (BASELINE_PROGRESS)
            const monthsElapsed = tYears * 12;
            const progress = BASELINE_PROGRESS * Math.pow(2, monthsElapsed / D_months);
            const f_r = reliabilityFactor(reliability);

            // Industry friction affects CAPABILITY (via domainPenalty), NOT doubling time
            // domainPenalty > 1 decreases H (makes AI relatively worse for domain-mismatched roles)
            // industryFriction from slider multiplies the penalty
            const industryFriction = resolvedDomainPace();  // From slider
            const rolePenalty = currentParams && typeof currentParams.domainPenalty === 'number'
                ? currentParams.domainPenalty
                : 1.0;
            const totalPenalty = rolePenalty * industryFriction;  // Both layers multiply
            const baselineMinutes = H50_0 / totalPenalty;  // Friction reduces effective capability

            // FIXED: Multiply by progress, divide by f_r
            // - progress increases H over time (AI tackles harder tasks)
            // - f(r) decreases H for higher reliability (more restrictive threshold)
            return (baselineMinutes * progress) / f_r;
        }

        // Logistic gate for single task bucket: G(H, L_i, s) = 1 / (1 + exp(-(ln(H) - ln(L_i)) / s))
        // Returns probability that AI can complete tasks of duration L_i given current capability H
        // H = max task length AI can handle; higher H → better AI → higher readiness
        // When H > L: AI can handle this task → gate opens (high probability)
        // When H < L: AI cannot handle this task → gate closes (low probability)
        function taskGate(H, L, s = METR_DEFAULTS.softness) {
            const logH = Math.log(Math.max(0.01, H));  // Prevent log(0)
            const logL = Math.log(L);
            const exponent = -(logH - logL) / s;  // FIXED: ln(H) - ln(L) so higher H → higher readiness
            return 1.0 / (1.0 + Math.exp(exponent));
        }

        // AI Readiness: A(t) = Σ w_i * G(H_r(t), L_i, s)
        // Returns value in [0, 1] representing fraction of job tasks AI can perform
        // UPDATED: Now uses seniority-based task weights and softness
        function A_job(tYears) {
            const H = H_r(tYears);
            const buckets = METR_DEFAULTS.taskBuckets;

            // Get seniority level and answers from currentParams (default to entry level)
            const seniorityLevel = (currentParams && currentParams.seniority) || 1;
            const answers = (currentParams && currentParams.answers) || null;
            const weights = getTaskWeightsForSeniority(seniorityLevel, answers);
            const s = getSoftnessForSeniority(seniorityLevel, answers);

            let readiness = 0;
            for (let i = 0; i < buckets.length; i++) {
                readiness += weights[i] * taskGate(H, buckets[i].L, s);
            }

            // Ensure bounded [0, 1]
            return Math.max(0, Math.min(1, readiness));
        }

        // Legacy compatibility functions (kept for now but unused)
        // METR model acceptance tests
        function runMETRAcceptanceTests() {
            console.log('\n=== METR MODEL ACCEPTANCE TESTS ===\n');

            // Test 1: A(t) is bounded [0,1]
            console.log('TEST 1: A(t) bounded [0,1]');
            const testTimes = [0, 1, 2, 3, 5, 10, 15, 20];
            let allBounded = true;
            testTimes.forEach(t => {
                const A_t = A_job(t);
                const bounded = A_t >= 0 && A_t <= 1;
                console.log(`  A(${t}yr) = ${A_t.toFixed(4)} ${bounded ? '✓' : '✗ OUT OF BOUNDS'}`);
                if (!bounded) allBounded = false;
            });
            console.log(`  RESULT: ${allBounded ? 'PASS ✓' : 'FAIL ✗'}\n`);

            // Test 2: Increasing r shifts milestones later
            console.log('TEST 2: Increasing r → later milestones');
            const findMilestone = (r_val, targetProb = 0.5) => {
                // Temporarily override reliability
                const origA = A_job;
                window.A_job = function(tYears) {
                    const H = H_r(tYears, METR_DEFAULTS.H50_0, r_val);
                    const buckets = METR_DEFAULTS.taskBuckets;
                    const s = METR_DEFAULTS.softness;
                    let readiness = 0;
                    for (const bucket of buckets) {
                        readiness += bucket.w * taskGate(H, bucket.L, s);
                    }
                    return Math.max(0, Math.min(1, readiness));
                };

                let low = 0, high = 50;
                while (high - low > 0.1) {
                    const mid = (low + high) / 2;
                    const prob = calculateDisplacementProbability(mid);
                    if (prob < targetProb) low = mid;
                    else high = mid;
                }
                window.A_job = origA;
                return (low + high) / 2;
            };

            const milestone_r90 = findMilestone(0.90);
            const milestone_r95 = findMilestone(0.95);
            const milestone_r99 = findMilestone(0.99);
            console.log(`  50% milestone at r=0.90: ${milestone_r90.toFixed(2)} years`);
            console.log(`  50% milestone at r=0.95: ${milestone_r95.toFixed(2)} years`);
            console.log(`  50% milestone at r=0.99: ${milestone_r99.toFixed(2)} years`);
            const shiftCorrect = milestone_r99 > milestone_r95 && milestone_r95 > milestone_r90;
            console.log(`  RESULT: ${shiftCorrect ? 'PASS ✓' : 'FAIL ✗'}\n`);

            // Test 3: Decreasing D_months shifts earlier
            console.log('TEST 3: Decreasing D_months → earlier milestones');
            const originalDoubling = resolvedDoublingDays();
            const baselineMilestone = findYearForProbability(0.5);
            modelConfig.metr.doublingDays = 1;
            syncModelStateFromConfig();
            const fastMilestone = findYearForProbability(0.5);
            modelConfig.metr.doublingDays = 10000;
            syncModelStateFromConfig();
            const slowMilestone = findYearForProbability(0.5);
            modelConfig.metr.doublingDays = originalDoubling;
            syncModelStateFromConfig();
            const doublingShifts = fastMilestone < baselineMilestone && slowMilestone > baselineMilestone;
            console.log(`  Fast (1d) median: ${fastMilestone.toFixed(2)} years`);
            console.log(`  Baseline median: ${baselineMilestone.toFixed(2)} years`);
            console.log(`  Slow (10000d) median: ${slowMilestone.toFixed(2)} years`);
            console.log(`  RESULT: ${doublingShifts ? 'PASS û' : 'FAIL ?'}\n`);

            // Test 4: Blue and Green curves identical except for delay
            console.log('TEST 4: Green = Blue shifted by delay');
            console.log('  Green curve at t=T should equal Blue curve at t=(T-delay)');
            console.log('  This is enforced by updateChart() implementation ✓\n');

            console.log('  Note: implementation now uses dynamic delay(t) = delay0 * exp(-lambda * t)');
            console.log('  Green(t) computed as Blue(max(t - delay(t), 0))');
            // Test 5: Key diagnostic values
            console.log('DIAGNOSTIC VALUES:');
            console.log(`  H_r(0) = ${H_r(0).toFixed(2)} minutes (baseline capability)`);
            console.log(`  H_r(5) = ${H_r(5).toFixed(4)} minutes (more capable → lower time)`);
            console.log(`  A(0) = ${A_job(0).toFixed(4)} (should be near 0)`);
            console.log(`  A(5) = ${A_job(5).toFixed(4)} (should be in [0,1])`);
            console.log(`  reliability factor f(0.95) = ${reliabilityFactor(0.95).toFixed(4)}`);

            console.log('\n=== END ACCEPTANCE TESTS ===\n');
        }

        // Unit tests to guard against regressions from patch
        function runRegressionTests() {
            console.log('\n=== REGRESSION GUARD TESTS (PATCH) ===\n');

            let allPassed = true;

            // Test 1: Gate direction - faster AI (lower H) should give higher readiness
            console.log('TEST 1: Gate direction');
            const s = 0.45, L = 10;
            const gateSlow = taskGate(1, L, s);    // H=1 is slow/low capability AI
            const gateFast = taskGate(100, L, s);  // H=100 is fast/high capability AI
            const gatePass = gateFast > gateSlow;
            console.log(`  taskGate(H=1, L=10) = ${gateSlow.toFixed(4)}`);
            console.log(`  taskGate(H=100, L=10) = ${gateFast.toFixed(4)}`);
            console.log(`  RESULT: ${gatePass ? 'PASS ✓' : 'FAIL ✗'} (faster AI must have higher readiness)`);
            if (!gatePass) allPassed = false;
            console.log('  Note: taskGate increases with higher H at fixed L (direction check)');

            // Test 2: Reliability factor - r=0.95 should be ~13.5×, r=0.99 should be ~69-72×
            console.log('\nTEST 2: Reliability factor');
            console.log('  Expected scale: f(0.95) ~33x, f(0.99) ~235x');
            const f95 = reliabilityFactor(0.95);
            const f99 = reliabilityFactor(0.99);
            const reliabilityPass = (f95 > 25 && f95 < 45) && (f99 > 180 && f99 < 320);
            console.log(`  f(0.95) = ${f95.toFixed(2)} (expected ~33)`);
            console.log(`  f(0.99) = ${f99.toFixed(2)} (expected ~235)`);
            console.log(`  RESULT: ${reliabilityPass ? 'PASS ✓' : 'FAIL ✗'}`);
            if (!reliabilityPass) allPassed = false;

            // Test 3: Green curve clamp - should never sample negative time
            console.log('\nTEST 3: Green curve clamp');
            const delay = 2;
            const blueCurve = (t) => (t <= 0 ? 0 : Math.min(t / 4, 1));
            const greenAt1 = 1 >= delay ? blueCurve(1 - delay) : 0;
            const clampPass = greenAt1 === 0;
            console.log(`  Green(t=1) with delay=2 should = Blue(max(1-2, 0)) = Blue(0) = 0`);
            console.log(`  Actual: ${greenAt1}`);
            console.log(`  RESULT: ${clampPass ? 'PASS ✓' : 'FAIL ✗'}`);
            if (!clampPass) allPassed = false;

            // Test 4: Seniority task weight shift - Executive should shift to longer tasks
            console.log('\nTEST 4: Seniority weight shift');
            const baseWeights = METR_DEFAULTS.taskBuckets.map(b => b.w);
            const execWeights = getTaskWeightsForSeniority(5);  // Executive
            const shiftPass = execWeights[3] > baseWeights[3] &&
                             execWeights[0] < baseWeights[0] &&
                             execWeights[1] < baseWeights[1];
            console.log(`  Base weights (Entry): [${baseWeights.map(w => w.toFixed(2)).join(', ')}]`);
            console.log(`  Exec weights: [${execWeights.map(w => w.toFixed(2)).join(', ')}]`);
            console.log(`  RESULT: ${shiftPass ? 'PASS ✓' : 'FAIL ✗'} (Exec shifts weight to longer tasks)`);
            if (!shiftPass) allPassed = false;

            // Test 5: Doubling dynamics - progress should double in 7 months
            console.log('\nTEST 5: Doubling dynamics');
            const D = 7;
            const months = 7;
            const progress = Math.pow(2, months / D);
            const doublingPass = Math.abs(progress - 2) < 1e-6;
            console.log(`  Progress after 7 months with D=7: ${progress.toFixed(6)}`);
            console.log(`  RESULT: ${doublingPass ? 'PASS ✓' : 'FAIL ✗'} (should be exactly 2.0)`);
            if (!doublingPass) allPassed = false;

            console.log(`\n=== OVERALL: ${allPassed ? 'ALL TESTS PASSED ✓' : 'SOME TESTS FAILED ✗'} ===\n`);
        }

        // WWILMJ PATCH: Regression tests to verify slider direction and weight normalization
        function runPatchRegressionTests() {
            console.log('\n=== WWILMJ PATCH REGRESSION TESTS ===\n');

            let allPassed = true;

            // Helper: Create neutral answers (all 3s)
            const neutralAnswers = {};
            for (let i = 1; i <= 19; i++) neutralAnswers[`Q${i}`] = 3;

            // Test 1: Q5 direction - moving from 1→5 should INCREASE hazardMult
            console.log('TEST 1: Q5 direction (decomposability)');
            const q5Low = { ...neutralAnswers, Q5: 1 };  // Very Complex
            const q5High = { ...neutralAnswers, Q5: 5 }; // Highly Structured
            const { ampMult: ampQ5Low, fricMult: fricQ5Low } = computeHazardMultipliers(q5Low);
            const { ampMult: ampQ5High, fricMult: fricQ5High } = computeHazardMultipliers(q5High);
            const multQ5Low = ampQ5Low * fricQ5Low;
            const multQ5High = ampQ5High * fricQ5High;
            const q5Pass = multQ5High > multQ5Low;
            console.log(`  Q5=1 (complex): hazardMult = ${multQ5Low.toFixed(3)}`);
            console.log(`  Q5=5 (structured): hazardMult = ${multQ5High.toFixed(3)}`);
            console.log(`  RESULT: ${q5Pass ? 'PASS ✓' : 'FAIL ✗'} (moving 1→5 should increase hazard)`);
            if (!q5Pass) allPassed = false;

            // Test 2: Q12 direction - moving from 1→5 should DECREASE hazardMult
            console.log('\nTEST 2: Q12 direction (physical presence)');
            const q12Low = { ...neutralAnswers, Q12: 1 };  // None
            const q12High = { ...neutralAnswers, Q12: 5 }; // Essential
            const { ampMult: ampQ12Low, fricMult: fricQ12Low } = computeHazardMultipliers(q12Low);
            const { ampMult: ampQ12High, fricMult: fricQ12High } = computeHazardMultipliers(q12High);
            const multQ12Low = ampQ12Low * fricQ12Low;
            const multQ12High = ampQ12High * fricQ12High;
            const q12Pass = multQ12High < multQ12Low;
            console.log(`  Q12=1 (none): hazardMult = ${multQ12Low.toFixed(3)}`);
            console.log(`  Q12=5 (essential): hazardMult = ${multQ12High.toFixed(3)}`);
            console.log(`  RESULT: ${q12Pass ? 'PASS ✓' : 'FAIL ✗'} (moving 1→5 should decrease hazard)`);
            if (!q12Pass) allPassed = false;

            // Test 3: Q15 direction - moving from 1→5 should INCREASE delayYears
            console.log('\nTEST 3: Q15 direction (labor market tightness)');
            const q15Easy = { ...neutralAnswers, Q15: 1 };       // Very Easy to hire
            const q15Difficult = { ...neutralAnswers, Q15: 5 };  // Very Difficult to hire
            const delayEasy = calculateImplementationDelay(q15Easy, 1);
            const delayDifficult = calculateImplementationDelay(q15Difficult, 1);
            const q15Pass = delayDifficult > delayEasy;
            console.log(`  Q15=1 (easy to hire): delay = ${delayEasy.toFixed(2)} years`);
            console.log(`  Q15=5 (difficult to hire): delay = ${delayDifficult.toFixed(2)} years`);
            console.log(`  RESULT: ${q15Pass ? 'PASS ✓' : 'FAIL ✗'} (moving 1→5 should increase delay)`);
            if (!q15Pass) allPassed = false;

            // Test 4: Calibration - Max(Q1,Q4,Q6)=5 vs all=3 should yield ≥2.5× hazard
            console.log('\nTEST 4: High-risk amplifier stack (Q1+Q4+Q6 max)');
            const maxRiskAnswers = { ...neutralAnswers, Q1: 5, Q4: 5, Q6: 5 };
            const { ampMult: neutralAmp, fricMult: neutralFric } = computeHazardMultipliers(neutralAnswers);
            const { ampMult: maxAmp, fricMult: maxFric } = computeHazardMultipliers(maxRiskAnswers);
            const neutralMult = neutralAmp * neutralFric;
            const maxMult = maxAmp * maxFric;
            const multRatio = maxMult / neutralMult;
            const calibPass = multRatio >= 2.5;
            console.log(`  Neutral (all 3s): hazardMult = ${neutralMult.toFixed(3)}`);
            console.log(`  Max risk (Q1,Q4,Q6=5): hazardMult = ${maxMult.toFixed(3)}`);
            console.log(`  Ratio: ${multRatio.toFixed(2)}×`);
            console.log(`  RESULT: ${calibPass ? 'PASS ✓' : 'FAIL ✗'} (should be ≥2.5×)`);
            if (!calibPass) allPassed = false;

            // Test 5: Protective stack - Q7=5, Q9=5, Q12=5, Q14=5 should suppress hazard ≤0.5× AND increase delay ≥0.7y
            console.log('\nTEST 5: Protective stack (Q7+Q9+Q12 high friction, Q14 high)');
            const protectiveAnswers = { ...neutralAnswers, Q7: 5, Q9: 5, Q12: 5, Q14: 5 };
            const { ampMult: protAmp, fricMult: protFric } = computeHazardMultipliers(protectiveAnswers);
            const protMult = protAmp * protFric;
            const protRatio = protMult / neutralMult;
            const neutralDelay = calculateImplementationDelay(neutralAnswers, 1);
            const protDelay = calculateImplementationDelay(protectiveAnswers, 1);
            const delayIncrease = protDelay - neutralDelay;
            const protPass = protRatio <= 0.5 && delayIncrease >= 0.7;
            console.log(`  Protective stack: hazardMult = ${protMult.toFixed(3)} (ratio: ${protRatio.toFixed(2)}×)`);
            console.log(`  Neutral delay: ${neutralDelay.toFixed(2)}y, Protective delay: ${protDelay.toFixed(2)}y`);
            console.log(`  Delay increase: ${delayIncrease.toFixed(2)}y`);
            console.log(`  RESULT: ${protPass ? 'PASS ✓' : 'FAIL ✗'} (hazard ≤0.5× AND delay +≥0.7y)`);
            if (!protPass) allPassed = false;

            // Test 6: Q1 min→max swing should produce ≥12pp increase in 2030 risk
            console.log('\nTEST 6: Q1 swing impact on 2030 risk');
            // Helper to compute risk by 2030
            const computeRisk2030 = (answers) => {
                const { ampMult, fricMult } = computeHazardMultipliers(answers);
                const mismatch = computeDomainMismatch(answers);
                const savedParams = currentParams;
                currentParams = {
                    h0: modelConfig.baseline.h0, theta: THETA_BASE_ENTRY, gamma: modelConfig.baseline.gammaBase, kappa: modelConfig.baseline.kappa, friction: modelConfig.baseline.frictionValue,
                    seniority: 1, seniorityProfile: SENIORITY_PROFILES[0],
                    s_e: inferredExplicitness(answers), lambda: inferredFrictionDecay(answers),
                    domainPace: inferredPace(answers),
                    ampMult: ampMult, fricMult: fricMult,
                    domainPenalty: mismatch.penalty, domainAlignment: mismatch.alignment,
                    answers: answers, implementationDelay: 0
                };
                const risk = calculateDisplacementProbability(5.35);
                currentParams = savedParams;
                return risk;
            };
            const q1Min = { ...neutralAnswers, Q1: 1 };
            const q1Max = { ...neutralAnswers, Q1: 5 };
            const riskQ1Min = computeRisk2030(q1Min);
            const riskQ1Max = computeRisk2030(q1Max);
            const q1Delta = (riskQ1Max - riskQ1Min) * 100;
            const q1SwingPass = q1Delta >= 12;
            console.log(`  Q1=1: 2030 risk = ${(riskQ1Min * 100).toFixed(1)}%`);
            console.log(`  Q1=5: 2030 risk = ${(riskQ1Max * 100).toFixed(1)}%`);
            console.log(`  Delta: ${q1Delta.toFixed(1)}pp`);
            console.log(`  RESULT: ${q1SwingPass ? 'PASS ✓' : 'FAIL ✗'} (should be ≥12pp)`);
            if (!q1SwingPass) allPassed = false;

            console.log(`\n=== PATCH TESTS: ${allPassed ? 'ALL PASSED ✓' : 'SOME FAILED ✗'} ===\n`);
            return allPassed;
        }

        // Test new features: task weight personalization and lambda friction decay
        function runFeatureImplementationTests() {
            console.log('\n=== FEATURE IMPLEMENTATION TESTS ===\n');

            let allPassed = true;

            // Helper: Create neutral answers (all 3s)
            const neutralAnswers = {};
            for (let i = 1; i <= 19; i++) neutralAnswers[`Q${i}`] = 3;

            // Test 1: Q5/Q6/Q7 affect task weights
            console.log('TEST 1: Q5/Q6/Q7 affect task weights');
            const structuredAnswers = { ...neutralAnswers, Q5: 5, Q6: 5, Q7: 1 };  // Structured, standardized, low context
            const complexAnswers = { ...neutralAnswers, Q5: 1, Q6: 1, Q7: 5 };     // Complex, bespoke, high context

            const weightsStructured = getTaskWeightsForSeniority(1, structuredAnswers);
            const weightsComplex = getTaskWeightsForSeniority(1, complexAnswers);

            // Structured should have more weight in short tasks (buckets 0,1), less in long tasks (buckets 3,4)
            const shortTasksStructured = weightsStructured[0] + weightsStructured[1];
            const shortTasksComplex = weightsComplex[0] + weightsComplex[1];
            const longTasksStructured = weightsStructured[3] + weightsStructured[4];
            const longTasksComplex = weightsComplex[3] + weightsComplex[4];

            const test1Pass = shortTasksStructured > shortTasksComplex && longTasksStructured < longTasksComplex;
            console.log(`  Structured (Q5=5,Q6=5,Q7=1): short=${(shortTasksStructured*100).toFixed(1)}%, long=${(longTasksStructured*100).toFixed(1)}%`);
            console.log(`  Complex (Q5=1,Q6=1,Q7=5): short=${(shortTasksComplex*100).toFixed(1)}%, long=${(longTasksComplex*100).toFixed(1)}%`);
            console.log(`  RESULT: ${test1Pass ? 'PASS ✓' : 'FAIL ✗'} (structured should have more short tasks)`);
            if (!test1Pass) allPassed = false;

            // Test 2: Seniority affects task weights (Executive vs Entry)
            console.log('\nTEST 2: Seniority affects task weights');
            const weightsEntry = getTaskWeightsForSeniority(1, neutralAnswers);    // Entry
            const weightsExec = getTaskWeightsForSeniority(5, neutralAnswers);     // Executive

            const shortTasksEntry = weightsEntry[0] + weightsEntry[1];
            const shortTasksExec = weightsExec[0] + weightsExec[1];
            const longTasksEntry = weightsEntry[3] + weightsEntry[4];
            const longTasksExec = weightsExec[3] + weightsExec[4];

            const test2Pass = shortTasksEntry > shortTasksExec && longTasksEntry < longTasksExec;
            console.log(`  Entry (seniority=1): short=${(shortTasksEntry*100).toFixed(1)}%, long=${(longTasksEntry*100).toFixed(1)}%`);
            console.log(`  Executive (seniority=5): short=${(shortTasksExec*100).toFixed(1)}%, long=${(longTasksExec*100).toFixed(1)}%`);
            console.log(`  RESULT: ${test2Pass ? 'PASS ✓' : 'FAIL ✗'} (entry should have more short tasks)`);
            if (!test2Pass) allPassed = false;

            // Test 3: Lambda affects dynamic delay
            console.log('\nTEST 3: Lambda affects dynamic implementation delay');
            const lowLambdaAnswers = { ...neutralAnswers, Q11: 5, Q11: 5, Q12: 1, Q15: 1 };  // Low friction decay
            const highLambdaAnswers = { ...neutralAnswers, Q11: 1, Q11: 1, Q12: 5, Q15: 5 }; // High friction decay

            const lambdaLow = inferredFrictionDecay(lowLambdaAnswers);
            const lambdaHigh = inferredFrictionDecay(highLambdaAnswers);

            // Test how lambda affects delay at t=5 years
            const baseDelay = 2.0;
            const dynamicDelayLow = baseDelay * Math.exp(-lambdaLow * 5);
            const dynamicDelayHigh = baseDelay * Math.exp(-lambdaHigh * 5);

            const test3Pass = lambdaHigh > lambdaLow && dynamicDelayHigh < dynamicDelayLow;
            console.log(`  Low friction decay (λ=${lambdaLow.toFixed(3)}): delay at t=5 is ${dynamicDelayLow.toFixed(2)}y`);
            console.log(`  High friction decay (λ=${lambdaHigh.toFixed(3)}): delay at t=5 is ${dynamicDelayHigh.toFixed(2)}y`);
            console.log(`  RESULT: ${test3Pass ? 'PASS ✓' : 'FAIL ✗'} (higher λ should reduce delay faster)`);
            if (!test3Pass) allPassed = false;

            // Test 4: Softness varies by seniority and task complexity
            console.log('\nTEST 4: Softness varies by seniority and task complexity');
            const softnessEntryStructured = getSoftnessForSeniority(1, structuredAnswers);
            const softnessExecComplex = getSoftnessForSeniority(5, complexAnswers);

            const test4Pass = softnessExecComplex > softnessEntryStructured;
            console.log(`  Entry + Structured: softness=${softnessEntryStructured.toFixed(3)} (sharper gates)`);
            console.log(`  Executive + Complex: softness=${softnessExecComplex.toFixed(3)} (smoother gates)`);
            console.log(`  RESULT: ${test4Pass ? 'PASS ✓' : 'FAIL ✗'} (exec+complex should have smoother gates)`);
            if (!test4Pass) allPassed = false;

            console.log(`\n=== FEATURE TESTS: ${allPassed ? 'ALL PASSED ✓' : 'SOME FAILED ✗'} ===\n`);
            return allPassed;
        }

        // Helper: Update sliders based on role preset and seniority
        function updateSlidersFromPreset() {
            if (!selectedRole) {
                console.log('[updateSlidersFromPreset] No role selected');
                return;
            }

            const presets = window.WWILMJ_PRESETS;
            if (!presets) {
                console.error('[updateSlidersFromPreset] WWILMJ_PRESETS not loaded!');
                return;
            }

            const rolePreset = presets.ROLE_PRESETS[selectedRole];
            if (!rolePreset) {
                console.warn('[updateSlidersFromPreset] No preset for role:', selectedRole);
                return;
            }

            // Get current seniority level
            const seniorityChecked = document.querySelector('input[name="seniority"]:checked');
            const seniorityLevel = seniorityChecked ? parseInt(seniorityChecked.value) : 1;

            console.log('[updateSlidersFromPreset] Role:', selectedRole, 'Seniority:', seniorityLevel,
                        'Preset:', rolePreset);

            // Update industry friction slider
            const frictionSlider = document.getElementById('industry-pace');
            if (frictionSlider && rolePreset.friction) {
                frictionSlider.value = rolePreset.friction;
                document.getElementById('industry-pace-value').textContent = rolePreset.friction.toFixed(2) + 'x';
                console.log('[updateSlidersFromPreset] Updated friction to', rolePreset.friction);
            }

            // Update reliability slider (includes seniority adjustment)
            const reliabilitySlider = document.getElementById('ai-reliability');
            if (reliabilitySlider) {
                const recommendedR = presets.recommendReliability(selectedRole, seniorityLevel);
                const percentValue = Math.round(recommendedR * 100);
                reliabilitySlider.value = percentValue;
                document.getElementById('ai-reliability-value').textContent = percentValue + '%';
                console.log('[updateSlidersFromPreset] Updated reliability to', percentValue + '%',
                           '(base:', rolePreset.reliabilityBase, 'seniority adj:',
                           presets.SENIORITY_R_DELTAS[seniorityLevel - 1] || 0, ')');
            }
        }

        // Auto-fill Job Characteristics answers from role + hierarchy presets
        function applyQuestionPreset() {
            const presets = window.WWILMJ_PRESETS;
            if (!presets || typeof presets.buildQuestionPreset !== 'function') {
                console.warn('[applyQuestionPreset] WWILMJ_PRESETS.buildQuestionPreset missing');
                return;
            }
            if (!selectedRole) {
                console.warn('[applyQuestionPreset] No role selected');
                return;
            }

            const seniorityChecked = document.querySelector('input[name="seniority"]:checked');
            const seniorityLevel = seniorityChecked ? parseInt(seniorityChecked.value) : 1;
            const answerMap = presets.buildQuestionPreset(selectedRole, seniorityLevel);

            Object.entries(answerMap || {}).forEach(([qid, value]) => {
                const qNum = qid.replace('Q', '');
                const radio = document.querySelector(`input[name="q${qNum}"][value="${value}"]`);
                if (radio) {
                    radio.checked = true;
                }
            });
        }

        // Reset Job Characteristics answers to neutral defaults
        function resetQuestionsToNeutral() {
            const presets = window.WWILMJ_PRESETS;
            const neutral = presets && presets.NEUTRAL_ANSWERS ? presets.NEUTRAL_ANSWERS : {};
            for (let i = 1; i <= 19; i++) {
                const target = neutral[`Q${i}`] ?? 3;
                const radio = document.querySelector(`input[name="q${i}"][value="${target}"]`);
                if (radio) {
                    radio.checked = true;
                }
            }
        }

        // Tests will be run after DOM is ready (see DOMContentLoaded handler below)
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedRole = this.dataset.role;

                updateSlidersFromPreset();
                analyzeRole();
                // Refresh bucket editor for new role context
                try { initTaskBucketEditor(); } catch (e) {}
            });
        });

        // Add event listeners to all radio buttons to auto-update
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // If seniority changed, update sliders (reliability adjusts by seniority)
                if (this.name === 'seniority') {
                    updateSlidersFromPreset();
                }
                analyzeRole();
                try { initTaskBucketEditor(); } catch (e) {}
            });
        });

        function getQuestionValue(questionNum) {
            const checked = document.querySelector(`input[name="q${questionNum}"]:checked`);
            return checked ? parseFloat(checked.value) : 3;
        }

        function averageAnswers(answerMap, questionNumbers) {
            if (!Array.isArray(questionNumbers) || questionNumbers.length === 0) {
                return 0;
            }

            const enabledKeys = questionNumbers
                .map(num => `Q${num}`)
                .filter(isQuestionEnabled);

            if (enabledKeys.length === 0) {
                return 0;
            }

            const total = enabledKeys.reduce((sum, key) => {
                const raw = answerMap && Object.prototype.hasOwnProperty.call(answerMap, key)
                    ? answerMap[key]
                    : 3;
                const value = typeof raw === 'number' ? raw : parseFloat(raw);
                return sum + (Number.isFinite(value) ? value : 3);
            }, 0);

            return total / enabledKeys.length;
        }

        function computeDomainMismatch(answers) {
            let weightedSum = 0;
            for (const [qid, weight] of Object.entries(modelConfig.domainAlignmentWeights)) {
                if (!isQuestionEnabled(qid)) continue;
                const raw = answers && Object.prototype.hasOwnProperty.call(answers, qid) ? answers[qid] : 3;
                const x = codeAnswer(qid, raw);
                weightedSum += weight * x;
            }
            weightedSum = Math.max(-2.0, Math.min(2.0, weightedSum));
            const penaltyClamp = modelConfig.domainPenaltyClamp || { min: 0.7, max: 1.8 };
            const penalty = clamp(Math.exp(-weightedSum) * DOMAIN_PENALTY_BIAS, penaltyClamp.min, penaltyClamp.max);
            const alignment = clamp(0.5 + 0.18 * weightedSum, 0, 1);
            return { penalty, alignment, weightedSum };
        }


        // Code raw answers to numeric x_i, aiming for symmetric effects
        // Likert 1..5 -> -2..+2; booleans -> +/-1; fallback 0.
        function codeAnswer(qid, raw) {
            if (!isQuestionEnabled(qid)) return 0;
            if (typeof raw === 'number' && raw >= 1 && raw <= 5) return raw - 3;
            if (raw === true) return +1;
            if (raw === false) return -1;
            return 0;
        }

        // Compute hazard multipliers from all answers
        function computeHazardMultipliers(answers) {
            let sumAmp = 0, sumFric = 0;
            for (const [qid, raw] of Object.entries(answers)) {
                if (!isQuestionEnabled(qid)) continue;
                const w = modelConfig.questionWeights[qid];
                if (!w) continue;
                const x = codeAnswer(qid, raw);
                if (w.amp)  sumAmp  += w.amp  * x;
                if (w.fric) sumFric += w.fric * x;
            }
            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
            sumAmp  = clamp(sumAmp,  -2.0, +2.0);  // ≈ 0.14× .. 7.4×
            sumFric = clamp(sumFric, -2.0, +2.0);
            return { ampMult: Math.exp(sumAmp), fricMult: Math.exp(sumFric) };
        }

        // Calculate implementation delay in years (0.5 - 3 years), scaled by seniority
        function calculateImplementationDelay(answers, seniority, seniorityProfile = SENIORITY_PROFILES[seniority - 1] || SENIORITY_PROFILES[0]) {
            let delayScore = 0;
            for (const [qid, weight] of Object.entries(modelConfig.implementationWeights)) {
                if (!isQuestionEnabled(qid)) continue;
                const raw = getAnswerValue(answers, qid);
                const x = codeAnswer(qid, raw);
                delayScore += weight * x;
            }
            delayScore = clamp(delayScore, -2.0, +2.0);
            const delayCfg = modelConfig.delay;
            let delay = delayCfg.base - delayCfg.scale * delayScore;
            delay = clamp(delay, delayCfg.preShiftMin, delayCfg.preShiftMax);
            // Performance-modulated seniority shift (sign-aware)
            const q19Raw = getAnswerValue(answers, 'Q19');
            const q19Norm = (q19Raw - 1) / 4; // in [0,1]
            const baseShift = seniorityProfile ? (seniorityProfile.delayShift || 0) : 0;
            const s = Math.sign(baseShift) || 1;
            const perfAdj = 1 + delayCfg.performanceSensitivity * (q19Norm - 0.5) * s; // factor in [0.75, 1.25]
            const effectiveShift = baseShift * perfAdj;
            delay += effectiveShift;
            return clamp(delay, delayCfg.finalMin, delayCfg.finalMax);
        }

        // Calculate re-employment probability (0-1 scale)
        // Dependent on technical feasibility timing and seniority
        function calculateReemploymentProbability(answers, seniority, medianTechYears) {
            let reemployScore = 0;
            for (const [qid, weight] of Object.entries(modelConfig.reemploymentWeights)) {
                if (!isQuestionEnabled(qid)) continue;
                const raw = getAnswerValue(answers, qid);
                const x = codeAnswer(qid, raw);
                reemployScore += weight * x;
            }
            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
            reemployScore = clamp(reemployScore, -2.0, +2.0);

            // Base probability from adaptability factors
            const reCfg = modelConfig.reemploymentConfig;
            let probability = reCfg.base + (reemployScore * reCfg.scale);

            // Penalize based on how soon automation happens (sooner = harder to find work)
            // If median is <fast: -fastPenalty, <medium: -mediumPenalty, <slow: -slowPenalty
            let timingPenalty = 0;
            if (medianTechYears < reCfg.timingThresholds.fast) timingPenalty = reCfg.timingPenalties.fast;
            else if (medianTechYears < reCfg.timingThresholds.medium) timingPenalty = reCfg.timingPenalties.medium;
            else if (medianTechYears < reCfg.timingThresholds.slow) timingPenalty = reCfg.timingPenalties.slow;
            probability -= timingPenalty;

            const seniorityProfile = SENIORITY_PROFILES[seniority - 1] || SENIORITY_PROFILES[0];
            probability *= seniorityProfile.reemploymentBoost;

            return clamp(probability, reCfg.min, reCfg.max); // Cap at 85% - no one is guaranteed
        }

        // Optional timing shift via capability gate steepness k (affects BLUE curve only)
        function kEff(baseK, answers) {
            let sumK = 0;
            for (const [qid, raw] of Object.entries(answers)) {
                if (!isQuestionEnabled(qid)) continue;
                const x = codeAnswer(qid, raw);
                if (modelConfig.kWeights[qid]) sumK += modelConfig.kWeights[qid] * x;
            }
            sumK = Math.max(-1.0, Math.min(+1.0, sumK));
            return baseK * Math.exp(sumK);
        }

        function analyzeRole() {
            if (!selectedRole) {
                return;
            }

            const prevParams = currentParams;
            const roleName = selectedRole === 'custom' ?
                'Other/Custom' :
                document.querySelector(`.preset-btn[data-role="${selectedRole}"]`).textContent.trim();

            // Collect all answers
            const answers = {};
            for (let i = 1; i <= 19; i++) {
                answers[`Q${i}`] = getQuestionValue(i);
            }

            // Get seniority level (1=Entry, 2=Mid, 3=Senior, 4=Lead, 5=Executive)
            const seniorityChecked = document.querySelector('input[name="seniority"]:checked');
            const seniority = seniorityChecked ? parseFloat(seniorityChecked.value) : 1;

            // Compute hazard multipliers from question weights
            const { ampMult, fricMult } = computeHazardMultipliers(answers);

            // Compute section scores for display purposes only (not used in hazard calculation)
            const aiReadiness = averageAnswers(answers, [1, 2, 3, 4]);
            const taskAdapt = averageAnswers(answers, [5, 6, 7, 8, 9]);
            const friction = averageAnswers(answers, [10, 11]);
            const firmReadiness = averageAnswers(answers, [12, 13, 14, 15]);
            const personalAdapt = averageAnswers(answers, [16, 17, 18]);

            // Baseline parameters (will be modified by question multipliers)
            const h0_base = modelConfig.baseline.h0;
            const thetaBase = THETA_BASE_ENTRY;  // Baseline coverage bar before role/domain adjustments
            const gammaBase = modelConfig.baseline.gammaBase;               // Capability sensitivity to surplus (logistic gate steepness)
            const kappa = modelConfig.baseline.kappa;                       // Baseline friction damping retained for other multipliers
            const frictionValue = modelConfig.baseline.frictionValue;

            const s_e = inferredExplicitness(answers);
            const lambda = inferredFrictionDecay(answers);
            const domainPace = inferredPace(answers);
            const { penalty: domainPenalty, alignment: domainAlignment } = computeDomainMismatch(answers);

            const seniorityProfile = SENIORITY_PROFILES[seniority - 1] || SENIORITY_PROFILES[0];
            const thetaProfileBase = thetaBase + (seniorityProfile.thetaLift || 0);
            const alignmentShift = modelConfig.thetaAdjustments.alignmentShift * (0.5 - domainAlignment);
            const explicitnessShift = modelConfig.thetaAdjustments.explicitnessShift * (0.5 - s_e);
            const thetaCandidate = thetaProfileBase + alignmentShift + explicitnessShift;
            const thetaEffective = clamp(thetaCandidate, modelConfig.hazardGates.thetaClampMin, modelConfig.hazardGates.thetaClampMax);

            // Apply optional timing shift (capability gate steepness adjustment)
            const gammaEffective = kEff(gammaBase, answers);
            const gammaClamped = clamp(gammaEffective, modelConfig.hazardGates.gammaClampMin, modelConfig.hazardGates.gammaClampMax);

            // Calculate implementation delay (scaled by seniority)
            const implementationDelay = calculateImplementationDelay(answers, seniority, seniorityProfile);

            currentParams = {
                name: roleName,
                h0: h0_base,
                theta: thetaEffective,
                gamma: gammaClamped,
                kappa: kappa,
                friction: frictionValue,
                seniority: seniority,
                seniorityLabel: seniorityProfile.label,
                seniorityProfile: seniorityProfile,
                s_e: s_e,
                lambda: lambda,
                domainPace: domainPace,
                domainPenalty: domainPenalty,
                domainAlignment: domainAlignment,
                aiReadiness: aiReadiness,
                taskAdapt: taskAdapt,
                friction_score: friction,
                firmReadiness: firmReadiness,
                personalAdapt: personalAdapt,
                ampMult: ampMult,
                fricMult: fricMult,
                answers: answers,
                implementationDelay: implementationDelay,
                userBaseWeights: (prevParams && Array.isArray(prevParams.userBaseWeights)) ? prevParams.userBaseWeights : null
            };

            updatePersonalTimeline();
            initChart();
            updateChart();
            initTaskBucketEditor();
        }

        function updatePersonalTimeline() {
            const timeline = document.getElementById('personal-timeline');
            const events = [];

            const risk25 = findYearForProbability(0.25, currentParams);
            const risk50 = findYearForProbability(0.5, currentParams);
            const risk75 = findYearForProbability(0.75, currentParams);
            const risk90 = findYearForProbability(0.9, currentParams);
            
            const currentYear = 2025.65;
            
            if (risk25 < 10) {
                events.push({
                    date: (currentYear + risk25).toFixed(1),
                    description: '25% risk AI can technically automate role'
                });
            }
            if (risk50 < 15) {
                events.push({
                    date: (currentYear + risk50).toFixed(1),
                    description: '50% risk AI can technically automate role'
                });
            }
            if (risk75 < 20) {
                events.push({
                    date: (currentYear + risk75).toFixed(1),
                    description: '75% risk AI can technically automate role'
                });
            }
            if (risk90 < 25) {
                events.push({
                    date: (currentYear + risk90).toFixed(1),
                    description: '90% risk AI can technically automate role'
                });
            }
            
            timeline.innerHTML = events.map(e => `
                <div class="timeline-event">
                    <span class="timeline-date">${e.date}</span>
                    <span class="timeline-description">${e.description}</span>
                </div>
            `).join('');
        }

        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Technical Feasibility of Automation',
                        data: [],
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Actual Job Loss',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${(context.parsed.y * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years from Now'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Compute user multipliers from questions (bounded to 0.33x - 3.0x overall)
        // PATCH: Apply seniority AFTER question product (hazardMult *= (1 - hazardShield))
        // PATCH: Widened from [0.5, 2.0] to [0.33, 3.0] to eliminate dead zones
        function getUserMultiplier() {
            if (!currentParams) return 1.0;

            // Step 1: Compute question-based hazard multiplier (ampMult * fricMult)
            const questionMultiplier = currentParams.ampMult * currentParams.fricMult;

            // Step 2: Apply seniority hazard shield AFTER question multiplier
            const profiles = SENIORITY_PROFILES;
            const idx = Math.max(0, Math.min(profiles.length - 1, (currentParams.seniority || 1) - 1));
            const profile = profiles[idx] || profiles[0];
            const hazardMult = questionMultiplier * (1 - (profile.hazardShield || 0));

            // Step 3: Bound overall multiplier to [0.33, 3.0] (wider band for better slider responsiveness)
            return Math.max(0.33, Math.min(3.0, hazardMult));
        }

        // New logistic gate hazard: lambdaAI(t) = hAI / (1 + exp(-gamma * (A(t) - theta)))
        // No internal time decay (removed e^(-lambda*t))
        // UPDATED: Now uses seniority-based theta (base θ_0 + thetaLift)
        function hazardAI(tYears) {
            if (!currentParams) return 0;

            const hAI = modelConfig.hazardGates.hAI;           // Max base annual hazard (40% per year at full automation)
            const gammaDefault = modelConfig.hazardGates.gammaDefault;   // Steepness of logistic gate baseline

            const seniorityLevel = currentParams.seniority || 1;
            const idx = Math.max(0, Math.min(SENIORITY_PROFILES.length - 1, seniorityLevel - 1));
            const profile = SENIORITY_PROFILES[idx];
            const thetaCandidate = typeof currentParams.theta === 'number'
                ? currentParams.theta
                : THETA_BASE_ENTRY + (profile.thetaLift || 0);
            const theta = clamp(thetaCandidate, modelConfig.hazardGates.thetaClampMin, modelConfig.hazardGates.thetaClampMax);

            const gamma = (currentParams && typeof currentParams.gamma === 'number')
                ? currentParams.gamma
                : gammaDefault;

            const A_t = A_job(tYears);
            const logisticArg = -gamma * (A_t - theta);
            const baseHazard = hAI / (1.0 + Math.exp(logisticArg));

            const userMult = getUserMultiplier();
            const hazard = baseHazard * userMult;

            // Diagnostic logging at t=0 for debugging
            if (tYears === 0 && currentParams.taskBucketMode === 'custom') {
                console.log('[Hazard Debug] t=0 with custom buckets:');
                console.log(`  A_job(0) = ${A_t.toFixed(3)}`);
                console.log(`  theta = ${theta.toFixed(3)}`);
                console.log(`  gamma = ${gamma.toFixed(1)}`);
                console.log(`  baseHazard = ${baseHazard.toFixed(3)} (before multiplier)`);
                console.log(`  userMult = ${userMult.toFixed(3)} (ampMult=${currentParams.ampMult.toFixed(2)} × fricMult=${currentParams.fricMult.toFixed(2)})`);
                console.log(`  final hazard = ${hazard.toFixed(3)}`);
            }

            const capped = Math.min(modelConfig.hazardGates.hazardCap, hazard);
            const floor = modelConfig.hazardGates.hazardFloor || 0;
            return Math.max(floor, capped);
        }

        // Workforce Compression Hazard - job loss via task reallocation to amplified seniors
        // This hazard activates EARLIER than full automation (lower threshold)
        // Only affects GREEN curve (actual job loss), not BLUE curve (technical feasibility)
        function compressionHazard(tYears) {
            if (!currentParams) return 0;

            const seniorityLevel = currentParams.seniority || 1;

            // Protection handled by hierarchy vulnerability scaling (Level 4→0.4, Level 5→0.2)

            const answers = currentParams.answers || {};

            // 1. Task Reallocation Feasibility Score
            // Higher score = easier for others to absorb your work
            const q10 = getAnswerValue(answers, 'Q10');
            const q5 = getAnswerValue(answers, 'Q5');
            const q6 = getAnswerValue(answers, 'Q6');
            const q7 = getAnswerValue(answers, 'Q7');
            const q9 = getAnswerValue(answers, 'Q9');
            const q12 = getAnswerValue(answers, 'Q12');

            const compCfg = modelConfig.compressionWeights;
            const reallocationScore = (
                norm(q10) * compCfg.reallocation.Q10 +
                norm(q5) * compCfg.reallocation.Q5 +
                norm(q6) * compCfg.reallocation.Q6 +
                (1 - norm(q7)) * compCfg.reallocation.Q7 +
                (1 - norm(q9)) * compCfg.reallocation.Q9 +
                (1 - norm(q12)) * compCfg.reallocation.Q12
            );

            // 2. Senior Productivity Amplification (only for AI-learnable digital work)
            const q1 = getAnswerValue(answers, 'Q1');    // Current AI performance
            const q4 = getAnswerValue(answers, 'Q4');    // Task digitization
            // q5, q6, q7, q9 already declared above for reallocation score

            const A_current = A_job(tYears); // Current task readiness

            // Raw digitization (digital deliverables)
            const rawDigitalFraction = norm(q4);

            // Learnability discount: factors that make digital work less AI-trainable
            // High context, high tacit knowledge, low decomposability, and low standardization
            // all reduce how much AI can learn from observing the digital work
            const contextPenalty = norm(q7);           // High context = work requires understanding not in the data
            const tacitPenalty = norm(q9);             // High tacit = work requires experience not codifiable
            const variabilityPenalty = 1 - norm(q5);   // Low decomposability = work is integrated/holistic
            const customizationPenalty = 1 - norm(q6); // Low standardization = each instance is unique

            const learnabilityDiscount = 1 - (
                compCfg.learnabilityDiscount.context * contextPenalty +
                compCfg.learnabilityDiscount.tacit * tacitPenalty +
                compCfg.learnabilityDiscount.variability * variabilityPenalty +
                compCfg.learnabilityDiscount.customization * customizationPenalty
            );

            // Effective digital fraction: only digital work that AI can actually learn from
            const effectiveDigitalFraction = rawDigitalFraction * Math.max(compCfg.learnabilityDiscount.min, learnabilityDiscount);

            const aiCapability = norm(q1) * A_current;

            // Amplification ranges from 0 to 2.0 (can double senior productivity)
            // But only applies to work that is both digital AND AI-learnable
            const amplificationBoost = effectiveDigitalFraction * aiCapability * compCfg.amplificationFactor;

            // 3. Compression Readiness (hybrid: 70% immediate + 30% time-dependent)
            // This gives Q10 immediate effect while preserving growth as AI improves
            const capabilityScale = 1 + (compCfg.capabilityGain || 0) * A_current;
            const compressionReadiness = reallocationScore * (compCfg.readinessMix.immediate + compCfg.readinessMix.capability * (1.0 + amplificationBoost)) * capabilityScale;

            // 4. Compression Hazard Gate (lower threshold than automation)
            const h_max_compression = compCfg.gate.hMax;  // Equal to automation's 0.40 - AI-driven compression is equally serious
            const gamma_compression = compCfg.gate.gamma;   // Gentler slope than automation's 8.0
            const theta_compression = compCfg.gate.theta;  // Lower threshold than automation's ~0.50

            const logisticArg = -gamma_compression * (compressionReadiness - theta_compression);
            const baseCompressionHazard = h_max_compression / (1.0 + Math.exp(logisticArg));

            // 5. Scale by Hierarchy Vulnerability
            // Level 1 = 1.0 (fully vulnerable), Level 5 = 0.2 (protected)
            const hierarchyVuln = clamp((6 - seniorityLevel) / 5, compCfg.hierarchy.min, compCfg.hierarchy.max);

            // 6. Gate compression by actual AI readiness so it ramps as capability grows
            const readinessFloor = compCfg.readinessFloor || 0.2;
            const readinessGate = clamp((A_current - readinessFloor) / (1 - readinessFloor), 0, 1); // zero until floor readiness, full by ~100%
            const finalCompressionHazard = baseCompressionHazard * hierarchyVuln * readinessGate;

            // Diagnostic logging at t=0
            if (tYears === 0 && compressionReadiness > 0.2) {
                console.log('[Compression Debug] t=0:');
                console.log(`  reallocationScore = ${reallocationScore.toFixed(3)}`);
                console.log(`  rawDigital = ${rawDigitalFraction.toFixed(2)}, learnabilityDiscount = ${learnabilityDiscount.toFixed(2)}`);
                console.log(`  effectiveDigital = ${effectiveDigitalFraction.toFixed(2)} (AI-learnable fraction)`);
                console.log(`  amplificationBoost = ${amplificationBoost.toFixed(3)} (AI capability=${aiCapability.toFixed(2)})`);
                console.log(`  compressionReadiness = ${compressionReadiness.toFixed(3)}`);
                console.log(`  hierarchyVuln = ${hierarchyVuln.toFixed(2)} (level ${seniorityLevel})`);
                console.log(`  compression hazard = ${finalCompressionHazard.toFixed(3)}/year`);
            }

            return finalCompressionHazard;
        }

        // Cumulative risk from hazard series using survival function
        function cumulativeRiskFromHazard(hSeries, dtYears) {
            let cum = 0;
            return hSeries.map(h => {
                cum += h * dtYears;
                return 1 - Math.exp(-cum);
            });
        }

        // Calibration tests - run these to verify question weights have expected impact
        function runCalibrationTests() {
            const tests = [];

            // Helper to compute risk by 2030 (t=5.35 years from 2024.65)
            const computeRisk2030 = (answers) => {
                const { ampMult, fricMult } = computeHazardMultipliers(answers);
                const mismatch = computeDomainMismatch(answers);
                const savedParams = currentParams;
                currentParams = {
                    h0: modelConfig.baseline.h0,
                    theta: THETA_BASE_ENTRY,
                    gamma: modelConfig.baseline.gammaBase,
                    kappa: modelConfig.baseline.kappa,
                    friction: modelConfig.baseline.frictionValue,
                    seniority: 1,
                    s_e: inferredExplicitness(answers),
                    lambda: inferredFrictionDecay(answers),
                    domainPace: inferredPace(answers),
                    ampMult: ampMult,
                    fricMult: fricMult,
                    domainPenalty: mismatch.penalty,
                    domainAlignment: mismatch.alignment
                };
                const risk = calculateDisplacementProbability(5.35);
                currentParams = savedParams;
                return risk;
            };

            // Neutral baseline: all answers = 3
            const neutralAnswers = {};
            for (let i = 1; i <= 19; i++) neutralAnswers[`Q${i}`] = 3;

            // Test 1: Q1 min->max should increase Risk by 2030 by ≥ +12 percentage points
            const q1MinAnswers = { ...neutralAnswers, Q1: 1 };
            const q1MaxAnswers = { ...neutralAnswers, Q1: 5 };
            const riskQ1Min = computeRisk2030(q1MinAnswers);
            const riskQ1Max = computeRisk2030(q1MaxAnswers);
            const q1Delta = (riskQ1Max - riskQ1Min) * 100;
            tests.push({
                name: 'Q1 min->max increases Risk by 2030 by ≥12pp',
                pass: q1Delta >= 12,
                actual: q1Delta.toFixed(1) + 'pp',
                expected: '≥12pp'
            });

            // Test 2: Q1+Q4+Q6 max yields ≥2.5× hazard vs neutral
            const maxRiskAnswers = { ...neutralAnswers, Q1: 5, Q4: 5, Q6: 5 };
            const { ampMult: neutralAmpMult, fricMult: neutralFricMult } = computeHazardMultipliers(neutralAnswers);
            const { ampMult: maxAmpMult, fricMult: maxFricMult } = computeHazardMultipliers(maxRiskAnswers);
            const neutralMult = neutralAmpMult * neutralFricMult;
            const maxMult = maxAmpMult * maxFricMult;
            const multRatio = maxMult / neutralMult;
            tests.push({
                name: 'Q1+Q4+Q6 max yields ≥2.5× hazard vs neutral',
                pass: multRatio >= 2.5,
                actual: multRatio.toFixed(2) + '×',
                expected: '≥2.5×'
            });

            // Test 3: Protective stack (Q5+Q7+Q8+Q15 high) suppresses hazard by ≥50%
            const protectiveAnswers = { ...neutralAnswers, Q5: 5, Q7: 5, Q8: 5, Q15: 5 };
            const { ampMult: protAmpMult, fricMult: protFricMult } = computeHazardMultipliers(protectiveAnswers);
            const protMult = protAmpMult * protFricMult;
            const suppression = (1 - protMult / neutralMult) * 100;
            tests.push({
                name: 'Protective stack suppresses hazard by ≥50%',
                pass: suppression >= 50,
                actual: suppression.toFixed(1) + '%',
                expected: '≥50%'
            });

            // Log results to console
            console.log('=== CALIBRATION TEST RESULTS ===');
            tests.forEach(t => {
                const status = t.pass ? '✓ PASS' : '✗ FAIL';
                console.log(`${status} - ${t.name}`);
                console.log(`  Expected: ${t.expected}, Actual: ${t.actual}`);
            });
            const allPassed = tests.every(t => t.pass);
            console.log(`\nOverall: ${allPassed ? '✓ ALL TESTS PASSED' : '✗ SOME TESTS FAILED'}`);

            return tests;
        }

        // BLUE CURVE: Technical feasibility only (pure AI automation hazard)
        function calculateDisplacementProbability(t) {
            const n = 100;
            const dt = t / n;
            let integral = 0;

            for (let i = 0; i <= n; i++) {
                const s = i * dt;
                const rate = hazardAI(s);

                if (i === 0 || i === n) {
                    integral += rate;
                } else if (i % 2 === 1) {
                    integral += 4 * rate;
                } else {
                    integral += 2 * rate;
                }
            }

            integral = integral * dt / 3;
            return 1 - Math.exp(-integral);
        }

        // GREEN CURVE: Actual job loss (automation + compression)
        function calculateActualJobLossProbability(t) {
            const n = 100;
            const dt = t / n;
            let integral = 0;

            for (let i = 0; i <= n; i++) {
                const s = i * dt;
                const automationRate = hazardAI(s);
                const compressionRate = compressionHazard(s);

                // Combined hazard (capped at 0.60/year)
                const totalRate = Math.min(automationRate + compressionRate, 0.60);

                if (i === 0 || i === n) {
                    integral += totalRate;
                } else if (i % 2 === 1) {
                    integral += 4 * totalRate;
                } else {
                    integral += 2 * totalRate;
                }
            }

            integral = integral * dt / 3;
            return 1 - Math.exp(-integral);
        }

        function updateChart() {
            if (!currentParams || !chart) return;

            const years = [];
            const technicalFeasibility = [];
            const actualJobLoss = [];
            const maxYears = 20;
            const delay = currentParams.implementationDelay || 0;

            for (let t = 0; t <= maxYears; t += 0.25) {
                years.push(t);
                // Blue curve: Technical feasibility - Risk_tech(t) = 1 - exp(-∫ lambdaAI(u) du)
                technicalFeasibility.push(calculateDisplacementProbability(t));

                // Green curve: Actual job loss with dynamic friction decay + compression hazard
                // Implementation delay decreases exponentially as capability grows: delay(t) = delay_0 * exp(-lambda * t)
                // This models how organizational barriers diminish as AI capability increases
                // PLUS workforce compression hazard (task reallocation to AI-amplified seniors)
                const lambda = currentParams.lambda || 0.02;
                const delayCfg = modelConfig.delay;
                const knee = delayCfg.lambdaKnee || 0.025;
                const satBoost = delayCfg.lambdaSaturationBoost || 0.0;
                const lambdaCapGain = delayCfg.lambdaCapabilityGain || 0.0;
                const lamMax = (modelConfig.frictionDecayWeights && modelConfig.frictionDecayWeights.max) || lambda || 0.05;
                const readiness = A_job(t);
                const ramp = Math.max(0, Math.min(1, (lambda - knee) / Math.max(0.001, lamMax - knee)));
                const effectiveLambda = lambda * (1 + satBoost * ramp + lambdaCapGain * readiness);
                const lambdaCeil = lamMax * (1 + satBoost + lambdaCapGain);
                const lambdaUsed = Math.min(effectiveLambda, lambdaCeil);
                const dynamicDelay = delay * Math.exp(-lambdaUsed * t);
                const effectiveTime = Math.max(t - dynamicDelay, 0);
                actualJobLoss.push(effectiveTime > 0 ? calculateActualJobLossProbability(effectiveTime) : 0);
            }

            chart.data.labels = years;
            chart.data.datasets[0].data = technicalFeasibility;
            chart.data.datasets[1].data = actualJobLoss;
            chart.update();
            updateResults();

            // Debug: Log key metrics
            console.log('[METR] Blue curve at t=5:', technicalFeasibility[20].toFixed(3));  // t=5 is index 20 (0.25 step)
            console.log('[METR] Green curve at t=5:', actualJobLoss[20].toFixed(3));
            console.log('[METR] Implementation delay:', delay.toFixed(2), 'years');
        }

        function findYearForProbability(targetProb) {
            let low = 0;
            let high = 50;
            let mid;

            while (high - low > 0.1) {
                mid = (low + high) / 2;
                const prob = calculateDisplacementProbability(mid);

                if (prob < targetProb) {
                    low = mid;
                } else {
                    high = mid;
                }
            }

            return mid;
        }

        function findYearForProbabilityWithDynamicDelay(targetProb, delay, lambda) {
            let low = 0;
            let high = 50;
            let mid;

            while (high - low > 0.1) {
                mid = (low + high) / 2;
                // Calculate probability with dynamic delay + compression: delay(t) = delay_0 * exp(-lambda * t)
                const dynamicDelay = delay * Math.exp(-lambda * mid);
                const effectiveTime = Math.max(mid - dynamicDelay, 0);
                const prob = effectiveTime > 0 ? calculateActualJobLossProbability(effectiveTime) : 0;

                if (prob < targetProb) {
                    low = mid;
                } else {
                    high = mid;
                }
            }

            return mid;
        }

        function describeExplicitness(se) {
            if (typeof se !== 'number') return '-';
            let note;
            if (se >= 0.7) {
                note = 'heavy explicit work pulls timelines forward.';
            } else if (se <= 0.35) {
                note = 'tacit-heavy mix slows capability transfer.';
            } else {
                note = 'mixed tasks keep the acceleration moderate.';
            }
            return `${se.toFixed(2)} - ${note}`;
        }

        function describeTheta(theta, seniority) {
            if (typeof theta !== 'number') return '-';
            const profiles = SENIORITY_PROFILES;
            const idx = Math.max(0, Math.min(profiles.length - 1, (seniority || 1) - 1));
            const profile = profiles[idx] || { label: 'Entry', thetaLift: 0 };
            const baseTheta = THETA_BASE_ENTRY + (profile.thetaLift || 0);
            const pct = theta * 100;
            const basePct = baseTheta * 100;
            const delta = pct - basePct;
            let note;
            if (delta > 3) {
                note = `${profile.label} coverage lifts by ~${delta.toFixed(1)} pts due to tacit or compliance load.`;
            } else if (delta < -3) {
                note = `${profile.label} coverage drops by ~${Math.abs(delta).toFixed(1)} pts thanks to explicit digital tasks.`;
            } else {
                note = `${profile.label} coverage bar is close to the baseline expectations.`;
            }
            return `${pct.toFixed(1)}% - ${note}`;
        }


        function describePace(pace) {
            if (typeof pace !== 'number' || !Number.isFinite(pace)) return '-';
            const multiplier = pace.toFixed(2);
            if (pace > 1.05) {
                return `~${multiplier}x METR doubling time - slower capability transfer.`;
            }
            if (pace < 0.95) {
                return `~${multiplier}x METR doubling time - faster than the trend.`;
            }
            return `~${multiplier}x METR doubling time - close to baseline.`;
        }

        function describeFriction(lambda) {
            if (typeof lambda !== 'number') return '-';
            let band;
            if (lambda >= 0.035) {
                band = 'fast rollout';
            } else if (lambda <= 0.015) {
                band = 'slow rollout';
            } else {
                band = 'medium rollout';
            }
            return `lambda = ${lambda.toFixed(3)} - ${band} damping.`;
        }

        function describeAlignment(alignment, penalty) {
            if (typeof alignment !== 'number' || typeof penalty !== 'number' || !Number.isFinite(penalty)) {
                return '-';
            }
            const alignmentPct = alignment * 100;
            let note;
            if (alignment >= 0.7) {
                note = 'close to METR software tasks.';
            } else if (alignment >= 0.4) {
                note = 'mixed workflows; slower transfer from METR.';
            } else {
                note = 'tacit/physical heavy; METR trend damped.';
            }
            return `${alignmentPct.toFixed(0)}% aligned, horizon penalty ${penalty.toFixed(2)}x - ${note}`;
        }

        function updateResults() {
            const delay = currentParams.implementationDelay || 0;
            const lambda = currentParams.lambda || 0.02;

            // Technical feasibility timeline
            const medianTech = findYearForProbability(0.5);
            const highTech = findYearForProbability(0.9);

            // Actual job loss timeline with dynamic friction decay
            const medianActual = findYearForProbabilityWithDynamicDelay(0.5, delay, lambda);
            const highActual = findYearForProbabilityWithDynamicDelay(0.9, delay, lambda);

            // Calculate years from now to 2030 and 2031 with dynamic delay
            const currentYear = getCurrentYearDecimal();
            const yearsTo2030 = 2030.0 - currentYear;
            const yearsTo2031 = 2031.0 - currentYear;
            const dynamicDelay2030 = delay * Math.exp(-lambda * yearsTo2030);
            const dynamicDelay2031 = delay * Math.exp(-lambda * yearsTo2031);
            const effectiveTime2030 = Math.max(yearsTo2030 - dynamicDelay2030, 0);
            const effectiveTime2031 = Math.max(yearsTo2031 - dynamicDelay2031, 0);
            const risk2030 = yearsTo2030 > 0 && effectiveTime2030 > 0 ? calculateActualJobLossProbability(effectiveTime2030) : (yearsTo2030 <= 0 ? 1.0 : 0);
            const risk2031 = yearsTo2031 > 0 && effectiveTime2031 > 0 ? calculateActualJobLossProbability(effectiveTime2031) : (yearsTo2031 <= 0 ? 1.0 : 0);

            document.getElementById('median-year').textContent =
                medianActual < 50 ? `${medianActual.toFixed(1)} years` : 'Beyond 2050';
            document.getElementById('high-year').textContent =
                highActual < 50 ? `${highActual.toFixed(1)} years` : 'Beyond 2050';
            document.getElementById('risk-2030').textContent =
                `${(Math.max(0, risk2030) * 100).toFixed(1)}%`;
            document.getElementById('risk-2031').textContent =
                `${(Math.max(0, risk2031) * 100).toFixed(1)}%`;

            // Re-employment likelihood (calculated here with medianTech timing)
            const reemployProb = calculateReemploymentProbability(
                currentParams.answers,
                currentParams.seniority,
                medianTech
            );
            const reemployPct = (reemployProb * 100).toFixed(0);
            let reemployLabel = 'Moderate';
            if (reemployProb >= 0.7) reemployLabel = 'Good';
            else if (reemployProb >= 0.5) reemployLabel = 'Moderate';
            else if (reemployProb >= 0.3) reemployLabel = 'Low';
            else reemployLabel = 'Very Low';
            document.getElementById('reemployment-value').textContent =
                `${reemployLabel} (${reemployPct}%)`;

            document.getElementById('insight-explicitness').textContent = describeExplicitness(currentParams.s_e);
            document.getElementById('insight-theta').textContent = describeTheta(currentParams.theta, currentParams.seniority);
            document.getElementById('insight-friction').textContent = describeFriction(currentParams.lambda);
            document.getElementById('insight-alignment').textContent =
                describeAlignment(currentParams.domainAlignment, currentParams.domainPenalty);

            // Update personal timeline table
            updatePersonalTimeline();
        }

        if (false) document.getElementById('ai-doubling')?.addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('ai-doubling-value').textContent = value + ' mo';
            console.log('[Slider] AI Doubling:', value, 'months → expect', value < 7 ? 'FASTER' : 'SLOWER', 'automation');
            updateChart();
        });

        document.getElementById('industry-pace')?.addEventListener('input', function() {
            const frictionValue = parseFloat(this.value);
            document.getElementById('industry-pace-value').textContent = frictionValue.toFixed(1) + 'x';
            console.log('[Slider] Industry Friction:', frictionValue.toFixed(1) + 'x',
                       '→ expect', frictionValue > 1.0 ? 'SLOWER' : 'FASTER', 'automation');
            updateChart();
        });

        document.getElementById('ai-reliability')?.addEventListener('input', function() {
            const reliabilityValue = parseInt(this.value);
            document.getElementById('ai-reliability-value').textContent = reliabilityValue + '%';
            console.log('[Slider] AI Reliability:', reliabilityValue + '%',
                       '-> expect', reliabilityValue > 95 ? 'SLOWER' : 'FASTER', 'automation');
            updateChart();
        });

        // Lightweight top-of-page flow (dropdowns + progress dots)
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('role-select');
            const hierarchySelect = document.getElementById('hierarchy-select');
            const prefillToggle = document.getElementById('prefill-questions');
            const dotRole = document.getElementById('dot-role');
            const dotHierarchy = document.getElementById('dot-hierarchy');
            const dotDone = document.getElementById('dot-done');
            const resultsSection = document.getElementById('results-column');
            const legacyWizard = document.querySelector('.legacy-wizard');
            const sequenceItems = Array.from(document.querySelectorAll('.sequence-item'))
                .sort((a, b) => (parseInt(a.dataset.seq || '0') || 0) - (parseInt(b.dataset.seq || '0') || 0));

            const activate = (el) => el && el.classList.add('active');
            const showBlock = (el) => el && el.classList.remove('hidden-block');

            function clickPreset(roleVal) {
                const btn = document.querySelector(`.preset-btn[data-role="${roleVal}"]`);
                if (btn) btn.click();
            }

            function syncSeniority(val) {
                const radio = document.querySelector(`input[name="seniority"][value="${val}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }

            function tryShowResults() {
                if (roleSelect?.value && hierarchySelect?.value) {
                    showBlock(resultsSection);
                }
            }

            function setPrefillState() {
                if (!prefillToggle) return;
                const ready = !!(roleSelect?.value && hierarchySelect?.value);
                if (!ready) {
                    prefillToggle.checked = false;
                    prefillToggle.disabled = true;
                } else {
                    prefillToggle.disabled = false;
                }
            }

            function updateChartSubtitle() {
                const subtitle = document.getElementById('chart-subtitle');
                if (!subtitle) return;

                const roleText = roleSelect?.selectedOptions[0]?.text || '';
                const hierarchyValue = hierarchySelect?.value;

                let levelText = '';
                if (hierarchyValue) {
                    levelText = `Level ${hierarchyValue}`;
                }

                if (roleText && roleText !== 'Select role' && levelText) {
                    subtitle.textContent = `${roleText} · ${levelText}`;
                } else if (roleText && roleText !== 'Select role') {
                    subtitle.textContent = roleText;
                } else {
                    subtitle.textContent = '-';
                }
            }

            roleSelect?.addEventListener('change', () => {
                if (roleSelect.value) {
                    roleSelect.classList.add('selected');
                    clickPreset(roleSelect.value);
                    activate(dotRole);
                }
                updateChartSubtitle();
                tryShowResults();
                setPrefillState();
                if (prefillToggle?.checked) {
                    applyQuestionPreset();
                    analyzeRole();
                }
            });

            hierarchySelect?.addEventListener('change', () => {
                if (hierarchySelect.value) {
                    hierarchySelect.classList.add('selected');
                    syncSeniority(hierarchySelect.value);
                    activate(dotHierarchy);
                }
                updateChartSubtitle();
                tryShowResults();
                setPrefillState();
                if (prefillToggle?.checked) {
                    applyQuestionPreset();
                    analyzeRole();
                }
            });

            // Pin chart toggle with FLIP animation
            document.getElementById('pin-chart-toggle')?.addEventListener('change', function() {
                const container = document.querySelector('.container');
                const pinnableSection = document.getElementById('pinnable-section');
                const rightColumn = document.getElementById('results-column');
                const contentWrapper = document.querySelector('.content-wrapper');

                // FIRST: capture initial positions
                const firstRect = pinnableSection.getBoundingClientRect();
                const contentFirstRect = contentWrapper.getBoundingClientRect();

                if (this.checked) {
                    // Move pinnable section to container
                    container.appendChild(pinnableSection);
                    document.body.classList.add('chart-pinned');
                } else {
                    // Move back to right column
                    rightColumn.insertBefore(pinnableSection, rightColumn.firstChild);
                    document.body.classList.remove('chart-pinned');
                }

                // LAST: capture final positions
                const lastRect = pinnableSection.getBoundingClientRect();
                const contentLastRect = contentWrapper.getBoundingClientRect();

                // INVERT: calculate the difference
                const deltaX = firstRect.left - lastRect.left;
                const deltaY = firstRect.top - lastRect.top;
                const contentDeltaX = contentFirstRect.left - contentLastRect.left;

                // Apply inverse transform (element appears in original position)
                pinnableSection.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                pinnableSection.style.transition = 'none';
                contentWrapper.style.transform = `translateX(${contentDeltaX}px)`;
                contentWrapper.style.transition = 'none';

                // PLAY: animate to final position
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        pinnableSection.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                        pinnableSection.style.transform = '';
                        contentWrapper.style.transition = 'transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                        contentWrapper.style.transform = '';
                    });
                });
            });

            document.getElementById('step-open-survey')?.addEventListener('click', () => {
                if (legacyWizard) {
                    legacyWizard.classList.remove('hidden-block');
                    legacyWizard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                if (roleSelect?.value) activate(dotRole);
                if (hierarchySelect?.value) activate(dotHierarchy);
                if (roleSelect?.value && hierarchySelect?.value) {
                    activate(dotDone);
                    showBlock(resultsSection);
                }
            });

            // Handle horizontal sequence interactions
            const questionnaireButton = document.getElementById('questionnaire-button');

            // Questionnaire button - scroll to and expand questionnaire
            questionnaireButton?.addEventListener('click', () => {
                // Find the questionnaire section and scroll to it
                const setupWizard = document.getElementById('setup-wizard');
                if (setupWizard) {
                    setupWizard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Open the survey immediately so questions appear without delay
                    document.getElementById('step-open-survey')?.click();
                }
            });

            // Prefill answers on demand (toggle style)
            prefillToggle?.addEventListener('change', () => {
                if (prefillToggle.disabled) return;
                if (prefillToggle.checked) {
                    if (!selectedRole) {
                        alert('Pick a role and hierarchy level first.');
                        prefillToggle.checked = false;
                        return;
                    }
                    applyQuestionPreset();
                } else {
                    resetQuestionsToNeutral();
                }
                analyzeRole();
            });

            // Navigation buttons (Guide/Methodology)
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const page = e.currentTarget.getAttribute('data-page');
                    if (page) {
                        window.location.href = page;
                    }
                });
                // Allow clicking anywhere within step cards
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });

            document.querySelectorAll('.step-card').forEach(card => {
                const page = card.getAttribute('data-page');
                if (!page) return;
                card.addEventListener('click', () => {
                    window.location.href = page;
                });
            });

            // Immediate reveal
            sequenceItems.forEach((el) => el.classList.add('is-visible'));

            setPrefillState();
            initModelTuningPanel();
        });

        // Task bucket editor logic
        function getBaseTaskWeights() {
            const userBase = (currentParams && Array.isArray(currentParams.userBaseWeights)) ? currentParams.userBaseWeights : null;
            if (userBase && userBase.length === METR_DEFAULTS.taskBuckets.length) return userBase;
            return METR_DEFAULTS.taskBuckets.map(b => b.w);
        }

        function initTaskBucketEditor() {
            const panel = document.getElementById('task-bucket-editor');
            const btn = document.getElementById('edit-task-buckets');
            if (!panel || !btn) return;

            const ids = ['tb-bucket-0','tb-bucket-1','tb-bucket-2','tb-bucket-3','tb-bucket-4'];
            const inputs = ids.map(id => document.getElementById(id)).filter(Boolean);
            const sumEl = document.getElementById('tb-sum');
            const applyBtn = document.getElementById('tb-apply');
            const autoChk = document.getElementById('tb-auto');

            // Prefill from current base weights
            const toPct = (x) => Math.max(0, Math.min(100, Math.round(x * 100)));
            function setInputsFromArray(arr){ inputs.forEach((inp, i) => { inp.value = toPct(arr[i] || 0); }); }

            function updateSum() {
                const total = inputs.reduce((s, inp) => s + (parseFloat(inp.value) || 0), 0);
                if (sumEl) sumEl.textContent = `Sum: ${Math.round(total)}%`;
                return total;
            }

            inputs.forEach(inp => inp.addEventListener('input', updateSum));

            btn.onclick = () => {
                panel.classList.toggle('expanded');
                refreshTaskBucketEditor();
            };

            applyBtn && (applyBtn.onclick = () => {
                let raw = inputs.map(inp => Math.max(0, parseFloat(inp.value) || 0));
                const total = raw.reduce((a,b)=>a+b,0);
                if (total <= 0) {
                    console.warn('[TaskBuckets] Sum is zero; ignoring apply');
                    return;
                }
                const normalized = raw.map(v => v / total);
                if (!currentParams) return;
                currentParams.userBaseWeights = normalized;
                console.log('[TaskBuckets] Applied user base weights:', normalized.map(v=>v.toFixed(3)));
                updateChart();
            });

            function refreshTaskBucketEditor(){
                if (!currentParams) return;
                const mode = currentParams.taskBucketMode === 'custom' ? 'custom' : 'auto';
                if (autoChk) autoChk.checked = (mode === 'auto');
                const disable = (mode === 'auto');
                inputs.forEach(inp => inp.disabled = disable);
                applyBtn && (applyBtn.disabled = disable);

                const seniorityLevel = (currentParams && currentParams.seniority) || 1;
                const answers = (currentParams && currentParams.answers) || null;

                if (mode === 'auto') {
                    // In auto mode, always show the current model-computed weights
                    const effectiveWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                    setInputsFromArray(effectiveWeights);
                    updateSum();
                } else {
                    // In custom mode, show user's custom weights if they exist
                    // Otherwise show model-computed weights as starting point
                    if (currentParams.userBaseWeights && currentParams.userBaseWeights.length === METR_DEFAULTS.taskBuckets.length) {
                        setInputsFromArray(currentParams.userBaseWeights);
                    } else {
                        const modelWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                        setInputsFromArray(modelWeights);
                    }
                    updateSum();
                }
            }

            autoChk && (autoChk.onchange = () => {
                if (!currentParams) return;
                const wasAuto = (currentParams.taskBucketMode !== 'custom');
                currentParams.taskBucketMode = autoChk.checked ? 'auto' : 'custom';

                // If switching FROM custom TO auto, reset to model values and update chart
                if (!wasAuto && autoChk.checked) {
                    const seniorityLevel = (currentParams && currentParams.seniority) || 1;
                    const answers = (currentParams && currentParams.answers) || null;
                    const modelWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                    // Clear user overrides and recalculate from model
                    currentParams.userBaseWeights = null;
                    setInputsFromArray(modelWeights);
                    updateSum();
                    console.log('[TaskBuckets] Switched to auto mode, reset to model weights:', modelWeights.map(v=>v.toFixed(3)));
                    updateChart();
                }

                // If switching FROM auto TO custom, populate with current model-computed values
                // This gives users the current model calculation as their starting point for editing
                if (wasAuto && !autoChk.checked) {
                    const seniorityLevel = (currentParams && currentParams.seniority) || 1;
                    const answers = (currentParams && currentParams.answers) || null;
                    const modelWeights = getTaskWeightsForSeniority(seniorityLevel, answers);
                    // Don't set userBaseWeights yet - let them click Apply to commit
                    setInputsFromArray(modelWeights);
                    updateSum();
                }

                refreshTaskBucketEditor();
            });

            refreshTaskBucketEditor();
        }

        // Auto-initialize: load benchmark data, then select custom role and trigger analysis on page load
        window.addEventListener('DOMContentLoaded', async function() {
            // Load benchmark data first
            await loadBenchmarkData();

            // Re-render the model tuning UI now that computed doubling time is available
            renderModelTuningUI();

            const currentYear = getCurrentYearDecimal();
            console.log(`[System] Current date: ${new Date().toISOString().split('T')[0]} (${currentYear.toFixed(2)})`);
            console.log(`[System] Years since baseline: ${(currentYear - BASELINE_YEAR_DECIMAL).toFixed(2)}`);
            console.log(`[System] Years to 2030: ${(2030.0 - currentYear).toFixed(2)}`);

            const customBtn = document.querySelector('.preset-btn[data-role="custom"]');
            if (customBtn) {
                customBtn.click();
            }

            // Run tests after initial analysis completes
            setTimeout(() => {
                runMETRAcceptanceTests();
                runRegressionTests();
                runPatchRegressionTests();
                runFeatureImplementationTests();
                runCalibrationTests();
                initTaskBucketEditor();
            }, 500);
        });
    </script>
    <script src="navigation.js"></script>
</body>
</html>
